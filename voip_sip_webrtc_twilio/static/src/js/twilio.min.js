/*! twilio-client.js 1.4.32

The following license applies to all parts of this software except as
documented below.

    Copyright 2015 Twilio, inc.

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

This software includes rtcpeerconnection-shim under the following (BSD 3-Clause) license.

    Copyright (c) 2017 Philipp Hancke. All rights reserved.

    Copyright (c) 2014, The WebRTC project authors. All rights reserved.

    Redistribution and use in source and binary forms, with or without
    modification, are permitted provided that the following conditions are
    met:

      * Redistributions of source code must retain the above copyright
        notice, this list of conditions and the following disclaimer.

      * Redistributions in binary form must reproduce the above copyright
        notice, this list of conditions and the following disclaimer in
        the documentation and/or other materials provided with the
        distribution.

      * Neither the name of Philipp Hancke nor the names of its contributors may
        be used to endorse or promote products derived from this software
        without specific prior written permission.

    THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
    "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
    LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
    A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
    HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
    SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
    LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
    DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
    THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
    (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
    OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

 */
(function(root){var bundle=function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r}()({1:[function(require,module,exports){"use strict";module.exports=WebSocket},{}],2:[function(require,module,exports){"use strict";module.exports={XMLHttpRequest:XMLHttpRequest}},{}],3:[function(require,module,exports){exports.Device=require("./twilio/device").Device;exports.PStream=require("./twilio/pstream").PStream;exports.Connection=require("./twilio/connection").Connection},{"./twilio/connection":5,"./twilio/device":6,"./twilio/pstream":11}],4:[function(require,module,exports){var EventEmitter=require("events").EventEmitter;var inherits=require("util").inherits;var log=require("./log");var MediaDeviceInfoShim=require("./shims/mediadeviceinfo");var defaultMediaDevices=require("./shims/mediadevices");var OutputDeviceCollection=require("./outputdevicecollection");var util=require("./util");function AudioHelper(onActiveOutputsChanged,onActiveInputChanged,getUserMedia,options){if(!(this instanceof AudioHelper)){return new AudioHelper(onActiveOutputsChanged,onActiveInputChanged,getUserMedia,options)}EventEmitter.call(this);options=Object.assign({AudioContext:typeof AudioContext!=="undefined"&&AudioContext,mediaDevices:defaultMediaDevices,setSinkId:typeof HTMLAudioElement!=="undefined"&&HTMLAudioElement.prototype.setSinkId},options);log.mixinLog(this,"[AudioHelper]");this.log.enabled=options.logEnabled;this.log.warnings=options.logWarnings;var availableInputDevices=new Map;var availableOutputDevices=new Map;var isAudioContextSupported=!!(options.AudioContext||options.audioContext);var mediaDevices=options.mediaDevices;var isEnumerationSupported=mediaDevices&&mediaDevices.enumerateDevices||false;var isSetSinkSupported=typeof options.setSinkId==="function";var isOutputSelectionSupported=isEnumerationSupported&&isSetSinkSupported;var isVolumeSupported=isAudioContextSupported;if(options.soundOptions){addOptionsToAudioHelper(this,options.soundOptions)}var audioContext=null;var inputVolumeAnalyser=null;if(isVolumeSupported){audioContext=options.audioContext||new options.AudioContext;inputVolumeAnalyser=audioContext.createAnalyser();inputVolumeAnalyser.fftSize=32;inputVolumeAnalyser.smoothingTimeConstant=.3}var self=this;Object.defineProperties(this,{_audioContext:{value:audioContext},_getUserMedia:{value:getUserMedia},_inputDevice:{value:null,writable:true},_inputStream:{value:null,writable:true},_inputVolumeAnalyser:{value:inputVolumeAnalyser},_isPollingInputVolume:{value:false,writable:true},_onActiveInputChanged:{value:onActiveInputChanged},_mediaDevices:{value:mediaDevices},_unknownDeviceIndexes:{value:{}},_updateAvailableDevices:{value:updateAvailableDevices.bind(null,this)},availableInputDevices:{enumerable:true,value:availableInputDevices},availableOutputDevices:{enumerable:true,value:availableOutputDevices},inputDevice:{enumerable:true,get:function(){return self._inputDevice}},inputStream:{enumerable:true,get:function(){return self._inputStream}},isVolumeSupported:{enumerable:true,value:isVolumeSupported},isOutputSelectionSupported:{enumerable:true,value:isOutputSelectionSupported},ringtoneDevices:{enumerable:true,value:new OutputDeviceCollection("ringtone",availableOutputDevices,onActiveOutputsChanged,isOutputSelectionSupported)},speakerDevices:{enumerable:true,value:new OutputDeviceCollection("speaker",availableOutputDevices,onActiveOutputsChanged,isOutputSelectionSupported)}});this.on("newListener",function(eventName){if(eventName==="inputVolume"){self._maybeStartPollingVolume()}});this.on("removeListener",function(eventName){if(eventName==="inputVolume"){self._maybeStopPollingVolume()}});this.once("newListener",function(){if(!isOutputSelectionSupported){console.warn("Warning: This browser does not support audio output selection.")}if(!isVolumeSupported){console.warn("Warning: This browser does not support Twilio's volume indicator feature.")}});if(isEnumerationSupported){initializeEnumeration(this)}}function initializeEnumeration(audio){audio._mediaDevices.addEventListener("devicechange",audio._updateAvailableDevices);audio._mediaDevices.addEventListener("deviceinfochange",audio._updateAvailableDevices);updateAvailableDevices(audio).then(function(){if(!audio.isOutputSelectionSupported){return}Promise.all([audio.speakerDevices.set("default"),audio.ringtoneDevices.set("default")]).catch(function(reason){audio.log.warn("Warning: Unable to set audio output devices. "+reason)})})}inherits(AudioHelper,EventEmitter);AudioHelper.prototype._maybeStartPollingVolume=function _maybeStartPollingVolume(){if(!this.isVolumeSupported||!this._inputStream){return}updateVolumeSource(this);if(this._isPollingInputVolume){return}var bufferLength=this._inputVolumeAnalyser.frequencyBinCount;var buffer=new Uint8Array(bufferLength);var self=this;this._isPollingInputVolume=true;requestAnimationFrame(function emitVolume(){if(!self._isPollingInputVolume){return}self._inputVolumeAnalyser.getByteFrequencyData(buffer);var inputVolume=util.average(buffer);self.emit("inputVolume",inputVolume/255);requestAnimationFrame(emitVolume)})};AudioHelper.prototype._maybeStopPollingVolume=function _maybeStopPollingVolume(){if(!this.isVolumeSupported){return}if(!this._isPollingInputVolume||this._inputStream&&this.listenerCount("inputVolume")){return}if(this._inputVolumeSource){this._inputVolumeSource.disconnect();this._inputVolumeSource=null}this._isPollingInputVolume=false};AudioHelper.prototype.setInputDevice=function setInputDevice(deviceId){if(util.isFirefox()){return Promise.reject(new Error("Firefox does not currently support opening multiple "+"audio input tracks simultaneously, even across different tabs. As a result, "+"Device.audio.setInputDevice is disabled on Firefox until support is added.\n"+"Related BugZilla thread: https://bugzilla.mozilla.org/show_bug.cgi?id=1299324"))}return this._setInputDevice(deviceId,false)};AudioHelper.prototype._setInputDevice=function _setInputDevice(deviceId,forceGetUserMedia){if(typeof deviceId!=="string"){return Promise.reject(new Error("Must specify the device to set"))}var device=this.availableInputDevices.get(deviceId);if(!device){return Promise.reject(new Error("Device not found: "+deviceId))}if(this._inputDevice&&this._inputDevice.deviceId===deviceId&&this._inputStream){if(!forceGetUserMedia){return Promise.resolve()}this._inputStream.getTracks().forEach(function(track){track.stop()})}var self=this;return this._getUserMedia({audio:{deviceId:{exact:deviceId}}}).then(function onGetUserMediaSuccess(stream){return self._onActiveInputChanged(stream).then(function(){replaceStream(self,stream);self._inputDevice=device;self._maybeStartPollingVolume()})})};AudioHelper.prototype.unsetInputDevice=function unsetInputDevice(){if(!this.inputDevice){return Promise.resolve()}var self=this;return this._onActiveInputChanged(null).then(function(){replaceStream(self,null);self._inputDevice=null;self._maybeStopPollingVolume()})};AudioHelper.prototype._unbind=function _unbind(){this._mediaDevices.removeEventListener("devicechange",this._updateAvailableDevices);this._mediaDevices.removeEventListener("deviceinfochange",this._updateAvailableDevices)};function addOptionsToAudioHelper(audioHelper,options){var dictionary=options.__dict__;if(!dictionary){return}function setValue(key,value){if(typeof value!=="undefined"){dictionary[key]=value}return dictionary[key]}Object.keys(dictionary).forEach(function(key){audioHelper[key]=setValue.bind(null,key)})}function updateAvailableDevices(audio){return audio._mediaDevices.enumerateDevices().then(function(devices){updateDevices(audio,filterByKind(devices,"audiooutput"),audio.availableOutputDevices,removeLostOutput);updateDevices(audio,filterByKind(devices,"audioinput"),audio.availableInputDevices,removeLostInput);var defaultDevice=audio.availableOutputDevices.get("default")||Array.from(audio.availableOutputDevices.values())[0];[audio.speakerDevices,audio.ringtoneDevices].forEach(function(outputDevices){if(!outputDevices.get().size&&audio.availableOutputDevices.size){outputDevices.set(defaultDevice.deviceId)}})})}function removeLostOutput(audio,lostDevice){return audio.speakerDevices._delete(lostDevice)|audio.ringtoneDevices._delete(lostDevice)}function removeLostInput(audio,lostDevice){if(!audio.inputDevice||audio.inputDevice.deviceId!==lostDevice.deviceId){return false}replaceStream(audio,null);audio._inputDevice=null;audio._maybeStopPollingVolume();var defaultDevice=audio.availableInputDevices.get("default")||Array.from(audio.availableInputDevices.values())[0];if(defaultDevice){audio.setInputDevice(defaultDevice.deviceId)}return true}function filterByKind(devices,kind){return devices.filter(function(device){return device.kind===kind})}function getDeviceId(device){return device.deviceId}function updateDevices(audio,updatedDevices,availableDevices,removeLostDevice){var updatedDeviceIds=updatedDevices.map(getDeviceId);var knownDeviceIds=Array.from(availableDevices.values()).map(getDeviceId);var lostActiveDevices=[];var lostDeviceIds=util.difference(knownDeviceIds,updatedDeviceIds);lostDeviceIds.forEach(function(lostDeviceId){var lostDevice=availableDevices.get(lostDeviceId);availableDevices.delete(lostDeviceId);if(removeLostDevice(audio,lostDevice)){lostActiveDevices.push(lostDevice)}});var deviceChanged=false;updatedDevices.forEach(function(newDevice){var existingDevice=availableDevices.get(newDevice.deviceId);var newMediaDeviceInfo=wrapMediaDeviceInfo(audio,newDevice);if(!existingDevice||existingDevice.label!==newMediaDeviceInfo.label){availableDevices.set(newDevice.deviceId,newMediaDeviceInfo);deviceChanged=true}});if(deviceChanged||lostDeviceIds.length){if(audio.inputDevice!==null&&audio.inputDevice.deviceId==="default"){audio.log.warn(["Calling getUserMedia after device change to ensure that the","tracks of the active device (default) have not gone stale."].join(" "));audio._setInputDevice(audio._inputDevice.deviceId,true)}audio.emit("deviceChange",lostActiveDevices)}}var kindAliases={audiooutput:"Audio Output",audioinput:"Audio Input"};function getUnknownDeviceIndex(audioHelper,mediaDeviceInfo){var id=mediaDeviceInfo.deviceId;var kind=mediaDeviceInfo.kind;var unknownIndexes=audioHelper._unknownDeviceIndexes;if(!unknownIndexes[kind]){unknownIndexes[kind]={}}var index=unknownIndexes[kind][id];if(!index){index=Object.keys(unknownIndexes[kind]).length+1;unknownIndexes[kind][id]=index}return index}function wrapMediaDeviceInfo(audioHelper,mediaDeviceInfo){var options={deviceId:mediaDeviceInfo.deviceId,groupId:mediaDeviceInfo.groupId,kind:mediaDeviceInfo.kind,label:mediaDeviceInfo.label};if(!options.label){if(options.deviceId==="default"){options.label="Default"}else{var index=getUnknownDeviceIndex(audioHelper,mediaDeviceInfo);options.label="Unknown "+kindAliases[options.kind]+" Device "+index}}return new MediaDeviceInfoShim(options)}function updateVolumeSource(audioHelper){if(audioHelper._inputVolumeSource){audioHelper._inputVolumeSource.disconnect();audioHelper._inputVolumeSource=null}audioHelper._inputVolumeSource=audioHelper._audioContext.createMediaStreamSource(audioHelper._inputStream);audioHelper._inputVolumeSource.connect(audioHelper._inputVolumeAnalyser)}function replaceStream(audio,stream){if(audio._inputStream){audio._inputStream.getTracks().forEach(function(track){track.stop()})}audio._inputStream=stream}module.exports=AudioHelper},{"./log":8,"./outputdevicecollection":10,"./shims/mediadeviceinfo":22,"./shims/mediadevices":23,"./util":28,events:43,util:55}],5:[function(require,module,exports){var EventEmitter=require("events").EventEmitter;var Exception=require("./util").Exception;var log=require("./log");var rtc=require("./rtc");var RTCMonitor=require("./rtc/monitor");var twutil=require("./util");var util=require("util");var DTMF_INTER_TONE_GAP=70;var DTMF_PAUSE_DURATION=500;var DTMF_TONE_DURATION=160;var METRICS_BATCH_SIZE=10;var SAMPLES_TO_IGNORE=20;var FEEDBACK_SCORES=[1,2,3,4,5];var FEEDBACK_ISSUES=["one-way-audio","choppy-audio","dropped-call","audio-latency","noisy-call","echo"];var WARNING_NAMES={audioOutputLevel:"audio-output-level",audioInputLevel:"audio-input-level",packetsLostFraction:"packet-loss",jitter:"jitter",rtt:"rtt",mos:"mos"};var WARNING_PREFIXES={min:"low-",max:"high-",maxDuration:"constant-"};function Connection(device,message,getUserMedia,options){if(!(this instanceof Connection)){return new Connection(device,message,getUserMedia,options)}var self=this;twutil.monitorEventEmitter("Twilio.Connection",this);this._soundcache=device.soundcache;this.message=message||{};var DefaultMediaStream=options.mediaStreamFactory||device.options.MediaStream||device.options.mediaStreamFactory||rtc.PeerConnection;options=this.options=Object.assign({audioConstraints:device.options.audioConstraints,callParameters:{},debug:false,iceServers:device.options.iceServers,logPrefix:"[Connection]",MediaStream:DefaultMediaStream,offerSdp:null,rtcConstraints:device.options.rtcConstraints},options);this.parameters=options.callParameters;this._status="pending";this._isAnswered=false;this._direction=this.parameters.CallSid?"INCOMING":"OUTGOING";this.sendHangup=true;log.mixinLog(this,this.options.logPrefix);this.log.enabled=this.options.debug;this.log.warnings=this.options.warnings;function noop(){}this._onCancel=noop;this._onHangup=noop;this._onAnswer=this._onAnswer.bind(this);this._onRinging=this._onRinging.bind(this);var publisher=this._publisher=options.publisher;if(this._direction==="INCOMING"){publisher.info("connection","incoming",null,this)}var monitor=this._monitor=new RTCMonitor;monitor.disableWarnings();var samples=[];function createMetricPayload(){var payload={call_sid:self.parameters.CallSid,client_name:device._clientName,sdk_version:twutil.getReleaseVersion(),selected_region:device.options.region};if(device.stream){if(device.stream.gateway){payload.gateway=device.stream.gateway}if(device.stream.region){payload.region=device.stream.region}}payload.direction=self._direction;return payload}function publishMetrics(){if(samples.length===0){return}publisher.postMetrics("quality-metrics-samples","metrics-sample",samples.splice(0),createMetricPayload()).catch(function(e){self.log.warn("Unable to post metrics to Insights. Received error:",e)})}var samplesIgnored=0;monitor.on("sample",function(sample){if(samplesIgnored<SAMPLES_TO_IGNORE){samplesIgnored++}else if(samplesIgnored===SAMPLES_TO_IGNORE){monitor.enableWarnings()}sample.inputVolume=self._latestInputVolume;sample.outputVolume=self._latestOutputVolume;samples.push(sample);if(samples.length>=METRICS_BATCH_SIZE){publishMetrics()}});function formatPayloadForEA(warningData){var payloadData={threshold:warningData.threshold.value};if(warningData.values){payloadData.values=warningData.values.map(function(value){if(typeof value==="number"){return Math.round(value*100)/100}return value})}else if(warningData.value){payloadData.value=warningData.value}return{data:payloadData}}function reemitWarning(wasCleared,warningData){var groupPrefix=/^audio/.test(warningData.name)?"audio-level-":"network-quality-";var groupSuffix=wasCleared?"-cleared":"-raised";var groupName=groupPrefix+"warning"+groupSuffix;var warningPrefix=WARNING_PREFIXES[warningData.threshold.name];var warningName=warningPrefix+WARNING_NAMES[warningData.name];if(warningName==="constant-audio-input-level"&&self.isMuted()){return}var level=wasCleared?"info":"warning";if(warningName==="constant-audio-output-level"){level="info"}publisher.post(level,groupName,warningName,formatPayloadForEA(warningData),self);if(warningName!=="constant-audio-output-level"){var emitName=wasCleared?"warning-cleared":"warning";self.emit(emitName,warningName)}}monitor.on("warning-cleared",reemitWarning.bind(null,true));monitor.on("warning",reemitWarning.bind(null,false));this.mediaStream=new this.options.MediaStream(device,getUserMedia);this.on("volume",function(inputVolume,outputVolume){self._latestInputVolume=inputVolume;self._latestOutputVolume=outputVolume});this.mediaStream.onvolume=this.emit.bind(this,"volume");this.mediaStream.oniceconnectionstatechange=function(state){var level=state==="failed"?"error":"debug";publisher.post(level,"ice-connection-state",state,null,self)};this.mediaStream.onicegatheringstatechange=function(state){publisher.debug("signaling-state",state,null,self)};this.mediaStream.onsignalingstatechange=function(state){publisher.debug("signaling-state",state,null,self)};this.mediaStream.ondisconnect=function(msg){self.log(msg);publisher.warn("network-quality-warning-raised","ice-connectivity-lost",{message:msg},self);self.emit("warning","ice-connectivity-lost")};this.mediaStream.onreconnect=function(msg){self.log(msg);publisher.info("network-quality-warning-cleared","ice-connectivity-lost",{message:msg},self);self.emit("warning-cleared","ice-connectivity-lost")};this.mediaStream.onerror=function(e){if(e.disconnect===true){self._disconnect(e.info&&e.info.message)}var error={code:e.info.code,message:e.info.message||"Error with mediastream",info:e.info,connection:self};self.log("Received an error from MediaStream:",e);self.emit("error",error)};this.mediaStream.onopen=function(){if(self._status==="open"){return}else if(self._status==="ringing"||self._status==="connecting"){self.mute(false);self._maybeTransitionToOpen()}else{self.mediaStream.close()}};this.mediaStream.onclose=function(){self._status="closed";if(device.sounds.__dict__.disconnect){device.soundcache.get("disconnect").play()}monitor.disable();publishMetrics();self.emit("disconnect",self)};this.outboundConnectionId=twutil.generateConnectionUUID();this.pstream=device.stream;this._onCancel=function(payload){var callsid=payload.callsid;if(self.parameters.CallSid===callsid){self._status="closed";self.emit("cancel");self.pstream.removeListener("cancel",self._onCancel)}};if(this.pstream){this.pstream.on("cancel",this._onCancel);this.pstream.on("ringing",this._onRinging)}this.on("error",function(error){publisher.error("connection","error",{code:error.code,message:error.message},self);if(self.pstream&&self.pstream.status==="disconnected"){cleanupEventListeners(self)}});this.on("disconnect",function(){cleanupEventListeners(self)});return this}util.inherits(Connection,EventEmitter);Connection.toString=function(){return"[Twilio.Connection class]"};Connection.prototype.toString=function(){return"[Twilio.Connection instance]"};Connection.prototype.sendDigits=function(digits){if(digits.match(/[^0-9*#w]/)){throw new Exception("Illegal character passed into sendDigits")}var sequence=[];digits.split("").forEach(function(digit){var dtmf=digit!=="w"?"dtmf"+digit:"";if(dtmf==="dtmf*")dtmf="dtmfs";if(dtmf==="dtmf#")dtmf="dtmfh";sequence.push(dtmf)});(function playNextDigit(soundCache){var digit=sequence.shift();soundCache.get(digit).play();if(sequence.length){setTimeout(playNextDigit.bind(null,soundCache),200)}})(this._soundcache);var dtmfSender=this.mediaStream.getOrCreateDTMFSender();function insertDTMF(dtmfs){if(!dtmfs.length){return}var dtmf=dtmfs.shift();if(dtmf.length){dtmfSender.insertDTMF(dtmf,DTMF_TONE_DURATION,DTMF_INTER_TONE_GAP)}setTimeout(insertDTMF.bind(null,dtmfs),DTMF_PAUSE_DURATION)}if(dtmfSender){if(!("canInsertDTMF"in dtmfSender)||dtmfSender.canInsertDTMF){this.log("Sending digits using RTCDTMFSender");insertDTMF(digits.split("w"));return}this.log("RTCDTMFSender cannot insert DTMF")}this.log("Sending digits over PStream");var payload;if(this.pstream!==null&&this.pstream.status!=="disconnected"){payload={dtmf:digits,callsid:this.parameters.CallSid};this.pstream.publish("dtmf",payload)}else{payload={error:{}};var error={code:payload.error.code||31e3,message:payload.error.message||"Could not send DTMF: Signaling channel is disconnected",connection:this};this.emit("error",error)}};Connection.prototype.status=function(){return this._status};Connection.prototype.mute=function(shouldMute){if(typeof shouldMute==="undefined"){shouldMute=true;this.log.deprecated(".mute() is deprecated. Please use .mute(true) or .mute(false) "+"to mute or unmute a call instead.")}else if(typeof shouldMute==="function"){this.addListener("mute",shouldMute);return}if(this.isMuted()===shouldMute){return}this.mediaStream.mute(shouldMute);var isMuted=this.isMuted();this._publisher.info("connection",isMuted?"muted":"unmuted",null,this);this.emit("mute",isMuted,this)};Connection.prototype.isMuted=function(){return this.mediaStream.isMuted};Connection.prototype.unmute=function(){this.log.deprecated(".unmute() is deprecated. Please use .mute(false) to unmute a call instead.");this.mute(false)};Connection.prototype.accept=function(handler){if(typeof handler==="function"){this.addListener("accept",handler);return}if(this._status!=="pending"){return}var audioConstraints=handler||this.options.audioConstraints;var self=this;this._status="connecting";function connect_(){if(self._status!=="connecting"){cleanupEventListeners(self);self.mediaStream.close();return}var pairs=[];for(var key in self.message){pairs.push(encodeURIComponent(key)+"="+encodeURIComponent(self.message[key]))}function onLocalAnswer(pc){self._publisher.info("connection","accepted-by-local",null,self);self._monitor.enable(pc)}function onRemoteAnswer(pc){self._publisher.info("connection","accepted-by-remote",null,self);self._monitor.enable(pc)}var sinkIds=typeof self.options.getSinkIds==="function"&&self.options.getSinkIds();if(Array.isArray(sinkIds)){self.mediaStream._setSinkIds(sinkIds).catch(function(){})}var params=pairs.join("&");if(self._direction==="INCOMING"){self._isAnswered=true;self.mediaStream.answerIncomingCall(self.parameters.CallSid,self.options.offerSdp,self.options.rtcConstraints,self.options.iceServers,onLocalAnswer)}else{self.pstream.once("answer",self._onAnswer.bind(self));self.mediaStream.makeOutgoingCall(self.pstream.token,params,self.outboundConnectionId,self.options.rtcConstraints,self.options.iceServers,onRemoteAnswer)}self._onHangup=function(payload){if(payload.callsid&&(self.parameters.CallSid||self.outboundConnectionId)){if(payload.callsid!==self.parameters.CallSid&&payload.callsid!==self.outboundConnectionId){return}}else if(payload.callsid){return}self.log("Received HANGUP from gateway");if(payload.error){var error={code:payload.error.code||31e3,message:payload.error.message||"Error sent from gateway in HANGUP",connection:self};self.log("Received an error from the gateway:",error);self.emit("error",error)}self.sendHangup=false;self._publisher.info("connection","disconnected-by-remote",null,self);self._disconnect(null,true);cleanupEventListeners(self)};self.pstream.addListener("hangup",self._onHangup)}var inputStream=typeof this.options.getInputStream==="function"&&this.options.getInputStream();var promise=inputStream?this.mediaStream.setInputTracksFromStream(inputStream):this.mediaStream.openWithConstraints(audioConstraints);promise.then(function(){self._publisher.info("get-user-media","succeeded",{data:{audioConstraints:audioConstraints}},self);connect_()},function(error){var message;var code;if(error.code&&error.code===error.PERMISSION_DENIED||error.name&&error.name==="PermissionDeniedError"){code=31208;message="User denied access to microphone, or the web browser did not allow microphone "+"access at this address.";self._publisher.error("get-user-media","denied",{data:{audioConstraints:audioConstraints,error:error}},self)}else{code=31201;message="Error occurred while accessing microphone: "+error.name+(error.message?" ("+error.message+")":"");self._publisher.error("get-user-media","failed",{data:{audioConstraints:audioConstraints,error:error}},self)}return self._die(message,code)})};Connection.prototype.reject=function(handler){if(typeof handler==="function"){this.addListener("reject",handler);return}if(this._status!=="pending"){return}var payload={callsid:this.parameters.CallSid};this.pstream.publish("reject",payload);this.emit("reject");this.mediaStream.reject(this.parameters.CallSid);this._publisher.info("connection","rejected-by-local",null,this)};Connection.prototype.ignore=function(handler){if(typeof handler==="function"){this.addListener("cancel",handler);return}if(this._status!=="pending"){return}this._status="closed";this.emit("cancel");this.mediaStream.ignore(this.parameters.CallSid);this._publisher.info("connection","ignored-by-local",null,this)};Connection.prototype.cancel=function(handler){this.log.deprecated(".cancel() is deprecated. Please use .ignore() instead.");this.ignore(handler)};Connection.prototype.disconnect=function(handler){if(typeof handler==="function"){this.addListener("disconnect",handler);return}this._disconnect()};Connection.prototype._disconnect=function(message,remote){message=typeof message==="string"?message:null;if(this._status!=="open"&&this._status!=="connecting"&&this._status!=="ringing"){return}this.log("Disconnecting...");if(this.pstream!==null&&this.pstream.status!=="disconnected"&&this.sendHangup){var callId=this.parameters.CallSid||this.outboundConnectionId;if(callId){var payload={callsid:callId};if(message){payload.message=message}this.pstream.publish("hangup",payload)}}cleanupEventListeners(this);this.mediaStream.close();if(!remote){this._publisher.info("connection","disconnected-by-local",null,this)}};Connection.prototype.error=function(handler){if(typeof handler==="function"){this.addListener("error",handler);return}};Connection.prototype._die=function(message,code){this._disconnect();this.emit("error",{message:message,code:code})};Connection.prototype._setCallSid=function _setCallSid(payload){var callSid=payload.callsid;if(!callSid){return}this.parameters.CallSid=callSid;this.mediaStream.callSid=callSid};Connection.prototype._setSinkIds=function _setSinkIds(sinkIds){return this.mediaStream._setSinkIds(sinkIds)};Connection.prototype._setInputTracksFromStream=function _setInputTracksFromStream(stream){return this.mediaStream.setInputTracksFromStream(stream)};Connection.prototype._onRinging=function(payload){this._setCallSid(payload);if(this._status!=="connecting"&&this._status!=="ringing"){return}var hasEarlyMedia=!!payload.sdp;if(this.options.enableRingingState){this._status="ringing";this._publisher.info("connection","outgoing-ringing",{hasEarlyMedia:hasEarlyMedia},this);this.emit("ringing",hasEarlyMedia)}else if(hasEarlyMedia){this._onAnswer(payload)}};Connection.prototype._onAnswer=function(payload){if(this._isAnswered){return}this._setCallSid(payload);this._isAnswered=true;this._maybeTransitionToOpen()};Connection.prototype._maybeTransitionToOpen=function(){if(this.mediaStream&&this.mediaStream.status==="open"&&this._isAnswered){this._status="open";this.emit("accept",this)}};Connection.prototype.volume=function(handler){if(!window||!window.AudioContext&&!window.webkitAudioContext){console.warn("This browser does not support Connection.volume")}else if(typeof handler==="function"){this.on("volume",handler)}};Connection.prototype.getLocalStream=function getLocalStream(){return this.mediaStream&&this.mediaStream.stream};Connection.prototype.getRemoteStream=function getRemoteStream(){return this.mediaStream&&this.mediaStream._remoteStream};Connection.prototype.postFeedback=function(score,issue){if(typeof score==="undefined"||score===null){return this._postFeedbackDeclined()}if(FEEDBACK_SCORES.indexOf(score)===-1){throw new Error("Feedback score must be one of: "+FEEDBACK_SCORES)}if(typeof issue!=="undefined"&&issue!==null&&FEEDBACK_ISSUES.indexOf(issue)===-1){throw new Error("Feedback issue must be one of: "+FEEDBACK_ISSUES)}return this._publisher.post("info","feedback","received",{quality_score:score,issue_name:issue},this,true)};Connection.prototype._postFeedbackDeclined=function(){return this._publisher.post("info","feedback","received-none",null,this,true)};Connection.prototype._getTempCallSid=function(){return this.outboundConnectionId};Connection.prototype._getRealCallSid=function(){return/^TJ/.test(this.parameters.CallSid)?null:this.parameters.CallSid};function cleanupEventListeners(connection){function cleanup(){if(!connection.pstream){return}connection.pstream.removeListener("answer",connection._onAnswer);connection.pstream.removeListener("cancel",connection._onCancel);connection.pstream.removeListener("hangup",connection._onHangup);connection.pstream.removeListener("ringing",connection._onRinging)}cleanup();setTimeout(cleanup,0)}exports.Connection=Connection},{"./log":8,"./rtc":14,"./rtc/monitor":16,"./util":28,events:43,util:55}],6:[function(require,module,exports){var AudioHelper=require("./audiohelper");var EventEmitter=require("events").EventEmitter;var util=require("util");var log=require("./log");var twutil=require("./util");var rtc=require("./rtc");var Publisher=require("./eventpublisher");var Options=require("./options").Options;var Sound=require("./sound");var Connection=require("./connection").Connection;var getUserMedia=require("./rtc/getusermedia");var PStream=require("./pstream").PStream;var REG_INTERVAL=3e4;var RINGTONE_PLAY_TIMEOUT=2e3;function Device(token,options){if(!Device.isSupported){throw new twutil.Exception("twilio.js 1.3+ SDKs require WebRTC/ORTC browser support. "+"For more information, see <https://www.twilio.com/docs/api/client/twilio-js>. "+"If you have any questions about this announcement, please contact "+"Twilio Support at <help@twilio.com>.")}if(!(this instanceof Device)){return new Device(token,options)}twutil.monitorEventEmitter("Twilio.Device",this);if(!token){throw new twutil.Exception("Capability token is not valid or missing.")}options=options||{};var origOptions={};for(var i in options){origOptions[i]=options[i]}var DefaultSound=options.soundFactory||Sound;var defaults={logPrefix:"[Device]",eventgw:"eventgw.twilio.com",Sound:DefaultSound,connectionFactory:Connection,pStreamFactory:PStream,noRegister:false,closeProtection:false,secureSignaling:true,warnings:true,audioConstraints:true,iceServers:[],region:"gll",dscp:true,sounds:{}};options=options||{};for(var prop in defaults){if(prop in options)continue;options[prop]=defaults[prop]}if(options.dscp){options.rtcConstraints={optional:[{googDscp:true}]}}else{options.rtcConstraints={}}this.options=options;this.token=token;this._status="offline";this._region="offline";this._connectionSinkIds=["default"];this._connectionInputStream=null;this.connections=[];this._activeConnection=null;this.sounds=new Options({incoming:true,outgoing:true,disconnect:true});log.mixinLog(this,this.options.logPrefix);this.log.enabled=this.options.debug;var regions={gll:"chunderw-vpc-gll.twilio.com",au1:"chunderw-vpc-gll-au1.twilio.com",br1:"chunderw-vpc-gll-br1.twilio.com",de1:"chunderw-vpc-gll-de1.twilio.com",ie1:"chunderw-vpc-gll-ie1.twilio.com",jp1:"chunderw-vpc-gll-jp1.twilio.com",sg1:"chunderw-vpc-gll-sg1.twilio.com",us1:"chunderw-vpc-gll-us1.twilio.com","us1-tnx":"chunderw-vpc-gll-us1-tnx.twilio.com","us2-tnx":"chunderw-vpc-gll-us2-tnx.twilio.com","ie1-tnx":"chunderw-vpc-gll-ie1-tnx.twilio.com","us1-ix":"chunderw-vpc-gll-us1-ix.twilio.com","us2-ix":"chunderw-vpc-gll-us2-ix.twilio.com","ie1-ix":"chunderw-vpc-gll-ie1-ix.twilio.com"};var deprecatedRegions={au:"au1",br:"br1",ie:"ie1",jp:"jp1",sg:"sg1","us-va":"us1","us-or":"us1"};var region=options.region.toLowerCase();if(region in deprecatedRegions){this.log.deprecated("Region "+region+" is deprecated, please use "+deprecatedRegions[region]+".");region=deprecatedRegions[region]}if(!(region in regions)){throw new twutil.Exception("Region "+options.region+" is invalid. Valid values are: "+Object.keys(regions).join(", "))}options.chunderw="wss://"+(options.chunderw||regions[region||"gll"])+"/signal";this.soundcache=new Map;var a=typeof document!=="undefined"?document.createElement("audio"):{};var canPlayMp3;try{canPlayMp3=a.canPlayType&&!!a.canPlayType("audio/mpeg").replace(/no/,"")}catch(e){canPlayMp3=false}var canPlayVorbis;try{canPlayVorbis=a.canPlayType&&!!a.canPlayType("audio/ogg;codecs='vorbis'").replace(/no/,"")}catch(e){canPlayVorbis=false}var ext="mp3";if(canPlayVorbis&&!canPlayMp3){ext="ogg"}var defaultSounds={incoming:{filename:"incoming",shouldLoop:true},outgoing:{filename:"outgoing",maxDuration:3e3},disconnect:{filename:"disconnect",maxDuration:3e3},dtmf1:{filename:"dtmf-1",maxDuration:1e3},dtmf2:{filename:"dtmf-2",maxDuration:1e3},dtmf3:{filename:"dtmf-3",maxDuration:1e3},dtmf4:{filename:"dtmf-4",maxDuration:1e3},dtmf5:{filename:"dtmf-5",maxDuration:1e3},dtmf6:{filename:"dtmf-6",maxDuration:1e3},dtmf7:{filename:"dtmf-7",maxDuration:1e3},dtmf8:{filename:"dtmf-8",maxDuration:1e3},dtmf9:{filename:"dtmf-9",maxDuration:1e3},dtmf0:{filename:"dtmf-0",maxDuration:1e3},dtmfs:{filename:"dtmf-star",maxDuration:1e3},dtmfh:{filename:"dtmf-hash",maxDuration:1e3}};var base=twutil.getTwilioRoot()+"sounds/releases/"+twutil.getSoundVersion()+"/";for(var name_1 in defaultSounds){var soundDef=defaultSounds[name_1];var defaultUrl=base+soundDef.filename+"."+ext+"?cache=1_4_23";var soundUrl=options.sounds[name_1]||defaultUrl;var sound=new this.options.Sound(name_1,soundUrl,{maxDuration:soundDef.maxDuration,minDuration:soundDef.minDuration,shouldLoop:soundDef.shouldLoop,audioContext:this.options.disableAudioContextSounds?null:Device.audioContext});this.soundcache.set(name_1,sound)}var self=this;function createDefaultPayload(connection){var payload={client_name:self._clientName,platform:rtc.getMediaEngine(),sdk_version:twutil.getReleaseVersion(),selected_region:self.options.region};function setIfDefined(propertyName,value){if(value){payload[propertyName]=value}}if(connection){setIfDefined("call_sid",connection._getRealCallSid());setIfDefined("temp_call_sid",connection._getTempCallSid());payload.direction=connection._direction}var stream=self.stream;if(stream){setIfDefined("gateway",stream.gateway);setIfDefined("region",stream.region)}return payload}var publisher=this._publisher=new Publisher("twilio-js-sdk",this.token,{host:this.options.eventgw,defaultPayload:createDefaultPayload});if(options.publishEvents===false){publisher.disable()}function updateSinkIds(type,sinkIds){var promise=type==="ringtone"?updateRingtoneSinkIds(sinkIds):updateSpeakerSinkIds(sinkIds);return promise.then(function(){publisher.info("audio",type+"-devices-set",{audio_device_ids:sinkIds},self._activeConnection)},function(error){publisher.error("audio",type+"-devices-set-failed",{audio_device_ids:sinkIds,message:error.message},self._activeConnection);throw error})}function updateSpeakerSinkIds(sinkIds){sinkIds=sinkIds.forEach?sinkIds:[sinkIds];Array.from(self.soundcache.entries()).forEach(function(entry){if(entry[0]!=="incoming"){entry[1].setSinkIds(sinkIds)}});self._connectionSinkIds=sinkIds;var connection=self._activeConnection;return connection?connection._setSinkIds(sinkIds):Promise.resolve()}function updateRingtoneSinkIds(sinkIds){return Promise.resolve(self.soundcache.get("incoming").setSinkIds(sinkIds))}function updateInputStream(inputStream){var connection=self._activeConnection;if(connection&&!inputStream){return Promise.reject(new Error("Cannot unset input device while a call is in progress."))}self._connectionInputStream=inputStream;return connection?connection._setInputTracksFromStream(inputStream):Promise.resolve()}var audio=this.audio=new AudioHelper(updateSinkIds,updateInputStream,getUserMedia,{audioContext:Device.audioContext,logEnabled:!!this.options.debug,logWarnings:!!this.options.warnings,soundOptions:this.sounds});audio.on("deviceChange",function(lostActiveDevices){var activeConnection=self._activeConnection;var deviceIds=lostActiveDevices.map(function(device){return device.deviceId});publisher.info("audio","device-change",{lost_active_device_ids:deviceIds},activeConnection);if(activeConnection){activeConnection.mediaStream._onInputDevicesChanged()}});this.mediaPresence={audio:!this.options.noRegister};this.register(this.token);var closeProtection=this.options.closeProtection;function confirmClose(event){if(self._activeConnection){var defaultMsg="A call is currently in-progress. "+"Leaving or reloading this page will end the call.";var confirmationMsg=closeProtection===true?defaultMsg:closeProtection;(event||window.event).returnValue=confirmationMsg;return confirmationMsg}}if(closeProtection){if(typeof window!=="undefined"){if(window.addEventListener){window.addEventListener("beforeunload",confirmClose)}else if(window.attachEvent){window.attachEvent("onbeforeunload",confirmClose)}}}function onClose(){self.disconnectAll()}if(typeof window!=="undefined"){if(window.addEventListener){window.addEventListener("unload",onClose)}else if(window.attachEvent){window.attachEvent("onunload",onClose)}}this.on("error",function(){});return this}util.inherits(Device,EventEmitter);function makeConnection(device,params,options){var defaults={getSinkIds:function(){return device._connectionSinkIds},getInputStream:function(){return device._connectionInputStream},debug:device.options.debug,warnings:device.options.warnings,publisher:device._publisher,enableRingingState:device.options.enableRingingState};options=options||{};for(var prop in defaults){if(prop in options)continue;options[prop]=defaults[prop]}var connection=device.options.connectionFactory(device,params,getUserMedia,options);connection.once("accept",function(){device._activeConnection=connection;device._removeConnection(connection);device.audio._maybeStartPollingVolume();device.emit("connect",connection)});connection.addListener("error",function(error){if(connection.status()==="closed"){device._removeConnection(connection)}device.audio._maybeStopPollingVolume();device.emit("error",error)});connection.once("cancel",function(){device.log("Canceled: "+connection.parameters.CallSid);device._removeConnection(connection);device.audio._maybeStopPollingVolume();device.emit("cancel",connection)});connection.once("disconnect",function(){device.audio._maybeStopPollingVolume();device._removeConnection(connection);if(device._activeConnection===connection){device._activeConnection=null}device.emit("disconnect",connection)});connection.once("reject",function(){device.log("Rejected: "+connection.parameters.CallSid);device.audio._maybeStopPollingVolume();device._removeConnection(connection)});return connection}Object.defineProperties(Device,{isSupported:{get:function(){return rtc.enabled()}}});Device.toString=function(){return"[Twilio.Device class]"};Device.prototype.toString=function(){return"[Twilio.Device instance]"};Device.prototype.register=function(token){var objectized=twutil.objectize(token);this._accountSid=objectized.iss;this._clientName=objectized.scope["client:incoming"]?objectized.scope["client:incoming"].params.clientName:null;if(this.stream){this.stream.setToken(token);this._publisher.setToken(token)}else{this._setupStream(token)}};Device.prototype.registerPresence=function(){if(!this.token){return}var tokenIncomingObject=twutil.objectize(this.token).scope["client:incoming"];if(tokenIncomingObject){this.mediaPresence.audio=true}this._sendPresence()};Device.prototype.unregisterPresence=function(){this.mediaPresence.audio=false;this._sendPresence()};Device.prototype.connect=function(params,audioConstraints){if(typeof params==="function"){return this.addListener("connect",params)}if(this._activeConnection){throw new Error("A Connection is already active")}params=params||{};audioConstraints=audioConstraints||this.options.audioConstraints;var connection=this._activeConnection=makeConnection(this,params);this.connections.splice(0).forEach(function(conn){conn.ignore()});this.soundcache.get("incoming").stop();if(this.sounds.__dict__.outgoing){var self_1=this;connection.accept(function(){self_1.soundcache.get("outgoing").play()})}connection.accept(audioConstraints);return connection};Device.prototype.disconnectAll=function(){var connections=[].concat(this.connections);for(var i=0;i<connections.length;i++){connections[i].disconnect()}if(this._activeConnection){this._activeConnection.disconnect()}if(this.connections.length>0){this.log("Connections left pending: "+this.connections.length)}};Device.prototype.destroy=function(){this._stopRegistrationTimer();this.audio._unbind();if(this.stream){this.stream.destroy();this.stream=null}};Device.prototype.disconnect=function(handler){this.addListener("disconnect",handler)};Device.prototype.incoming=function(handler){this.addListener("incoming",handler)};Device.prototype.offline=function(handler){this.addListener("offline",handler)};Device.prototype.ready=function(handler){this.addListener("ready",handler)};Device.prototype.error=function(handler){this.addListener("error",handler)};Device.prototype.status=function(){return this._activeConnection?"busy":this._status};Device.prototype.activeConnection=function(){return this._activeConnection||this.connections[0]};Device.prototype.region=function(){return this._region};Device.prototype._sendPresence=function(){if(!this.stream){return}this.stream.register(this.mediaPresence);if(this.mediaPresence.audio){this._startRegistrationTimer()}else{this._stopRegistrationTimer()}};Device.prototype._startRegistrationTimer=function(){clearTimeout(this.regTimer);var self=this;this.regTimer=setTimeout(function(){self._sendPresence()},REG_INTERVAL)};Device.prototype._stopRegistrationTimer=function(){clearTimeout(this.regTimer)};Device.prototype._setupStream=function(token){var self=this;this.log("Setting up PStream");var streamOptions={debug:this.options.debug,secureSignaling:this.options.secureSignaling};this.stream=this.options.pStreamFactory(token,this.options.chunderw,streamOptions);this.stream.addListener("connected",function(payload){var regions={US_EAST_VIRGINIA:"us1",US_WEST_OREGON:"us2",ASIAPAC_SYDNEY:"au1",SOUTH_AMERICA_SAO_PAULO:"br1",EU_IRELAND:"ie1",ASIAPAC_TOKYO:"jp1",ASIAPAC_SINGAPORE:"sg1"};self._region=regions[payload.region]||payload.region;self._sendPresence()});this.stream.addListener("close",function(){self.stream=null});this.stream.addListener("ready",function(){self.log("Stream is ready");if(self._status==="offline"){self._status="ready"}self.emit("ready",self)});this.stream.addListener("offline",function(){self.log("Stream is offline");self._status="offline";self._region="offline";self.emit("offline",self)});this.stream.addListener("error",function(payload){var error=payload.error;if(error){if(payload.callsid){error.connection=self._findConnection(payload.callsid)}if(error.code===31205){self._stopRegistrationTimer()}self.log("Received error: ",error);self.emit("error",error)}});this.stream.addListener("invite",function(payload){if(self._activeConnection){self.log("Device busy; ignoring incoming invite");return}if(!payload.callsid||!payload.sdp){self.emit("error",{message:"Malformed invite from gateway"});return}var params=payload.parameters||{};params.CallSid=params.CallSid||payload.callsid;function maybeStopIncomingSound(){if(!self.connections.length){self.soundcache.get("incoming").stop()}}var connection=makeConnection(self,{},{offerSdp:payload.sdp,callParameters:params});self.connections.push(connection);connection.once("accept",function(){self.soundcache.get("incoming").stop()});["cancel","error","reject"].forEach(function(event){connection.once(event,maybeStopIncomingSound)});var play=self.sounds.__dict__.incoming?function(){return self.soundcache.get("incoming").play()}:function(){return Promise.resolve()};self._showIncomingConnection(connection,play)})};Device.prototype._showIncomingConnection=function(connection,play){var self=this;var timeout;return Promise.race([play(),new Promise(function(resolve,reject){timeout=setTimeout(function(){reject(new Error("Playing incoming ringtone took too long; it might not play. Continuing execution..."))},RINGTONE_PLAY_TIMEOUT)})]).catch(function(reason){console.warn(reason.message)}).then(function(){clearTimeout(timeout);self.emit("incoming",connection)})};Device.prototype._removeConnection=function(connection){for(var i=this.connections.length-1;i>=0;i--){if(connection===this.connections[i]){this.connections.splice(i,1)}}};Device.prototype._findConnection=function(callsid){for(var i=0;i<this.connections.length;i++){var conn=this.connections[i];if(conn.parameters.CallSid===callsid||conn.outboundConnectionId===callsid){return conn}}return null};function singletonwrapper(cls){var afterSetup=[];var tasks=[];function enqueue(task){if(cls.instance){task()}else{tasks.push(task)}}function defaultErrorHandler(error){var errorMessage=(error.code?error.code+": ":"")+error.message;if(cls.instance){var n=0;var listeners=cls.instance.listeners("error");for(var i=0;i<listeners.length;i++){if(listeners[i]!==defaultErrorHandler){n++}}if(n>1){return}cls.instance.log(errorMessage)}throw new twutil.Exception(errorMessage)}var members={instance:null,setup:function(token,options){if(!cls.audioContext){if(typeof AudioContext!=="undefined"){cls.audioContext=new AudioContext}else if(typeof webkitAudioContext!=="undefined"){cls.audioContext=new webkitAudioContext}}var i;if(cls.instance){cls.instance.log("Found existing Device; using new token but ignoring options");cls.instance.token=token;cls.instance.register(token)}else{cls.instance=new Device(token,options);cls.error(defaultErrorHandler);cls.sounds=cls.instance.sounds;for(i=0;i<tasks.length;i++){tasks[i]()}tasks=[]}for(i=0;i<afterSetup.length;i++){afterSetup[i](token,options)}afterSetup=[];return cls},connect:function(parameters,audioConstraints){if(typeof parameters==="function"){enqueue(function(){cls.instance.addListener("connect",parameters)});return null}if(!cls.instance){throw new twutil.Exception("Run Twilio.Device.setup()")}if(cls.instance.connections.length>0){cls.instance.emit("error",{message:"A connection is currently active"});return null}return cls.instance.connect(parameters,audioConstraints)},disconnectAll:function(){enqueue(function(){cls.instance.disconnectAll()});return cls},disconnect:function(handler){enqueue(function(){cls.instance.addListener("disconnect",handler)});return cls},status:function(){if(!cls.instance){throw new twutil.Exception("Run Twilio.Device.setup()")}return cls.instance.status()},region:function(){if(!cls.instance){throw new twutil.Exception("Run Twilio.Device.setup()")}return cls.instance.region()},ready:function(handler){enqueue(function(){cls.instance.addListener("ready",handler)});return cls},error:function(handler){enqueue(function(){if(handler!==defaultErrorHandler){cls.instance.removeListener("error",defaultErrorHandler)}cls.instance.addListener("error",handler)});return cls},offline:function(handler){enqueue(function(){cls.instance.addListener("offline",handler)});return cls},incoming:function(handler){enqueue(function(){cls.instance.addListener("incoming",handler)});return cls},destroy:function(){if(cls.instance){cls.instance.destroy()}return cls},cancel:function(handler){enqueue(function(){cls.instance.addListener("cancel",handler)});return cls},activeConnection:function(){if(!cls.instance){return null}return cls.instance.activeConnection()}};for(var method in members){cls[method]=members[method]}Object.defineProperties(cls,{audio:{get:function(){return cls.instance.audio}}});return cls}exports.Device=singletonwrapper(Device)},{"./audiohelper":4,"./connection":5,"./eventpublisher":7,"./log":8,"./options":9,"./pstream":11,"./rtc":14,"./rtc/getusermedia":13,"./sound":24,"./util":28,events:43,util:55}],7:[function(require,module,exports){var request=require("./request");function EventPublisher(productName,token,options){if(!(this instanceof EventPublisher)){return new EventPublisher(productName,token,options)}options=Object.assign({defaultPayload:function(){return{}},host:"eventgw.twilio.com"},options);var defaultPayload=options.defaultPayload;if(typeof defaultPayload!=="function"){defaultPayload=function(){return Object.assign({},options.defaultPayload)}}var isEnabled=true;Object.defineProperties(this,{_defaultPayload:{value:defaultPayload},_isEnabled:{get:function(){return isEnabled},set:function(_isEnabled){isEnabled=_isEnabled}},_host:{value:options.host},_request:{value:options.request||request},_token:{value:token,writable:true},isEnabled:{enumerable:true,get:function(){return isEnabled}},productName:{enumerable:true,value:productName},token:{enumerable:true,get:function(){return this._token}}})}EventPublisher.prototype._post=function _post(endpointName,level,group,name,payload,connection,force){if(!this.isEnabled&&!force){return Promise.resolve()}var event={publisher:this.productName,group:group,name:name,timestamp:(new Date).toISOString(),level:level.toUpperCase(),payload_type:"application/json",private:false,payload:payload&&payload.forEach?payload.slice(0):Object.assign(this._defaultPayload(connection),payload)};var requestParams={url:"https://"+this._host+"/v2/"+endpointName,body:event,headers:{"Content-Type":"application/json","X-Twilio-Token":this.token}};var self=this;return new Promise(function(resolve,reject){self._request.post(requestParams,function(err){if(err){reject(err)}else{resolve()}})})};EventPublisher.prototype.post=function post(level,group,name,payload,connection,force){return this._post("EndpointEvents",level,group,name,payload,connection,force)};EventPublisher.prototype.debug=function debug(group,name,payload,connection){return this.post("debug",group,name,payload,connection)};EventPublisher.prototype.info=function info(group,name,payload,connection){return this.post("info",group,name,payload,connection)};EventPublisher.prototype.warn=function warn(group,name,payload,connection){return this.post("warning",group,name,payload,connection)};EventPublisher.prototype.error=function error(group,name,payload,connection){return this.post("error",group,name,payload,connection)};EventPublisher.prototype.postMetrics=function postMetrics(group,name,metrics,customFields){var self=this;return new Promise(function(resolve){var samples=metrics.map(formatMetric).map(function(sample){return Object.assign(sample,customFields)});resolve(self._post("EndpointMetrics","info",group,name,samples))})};EventPublisher.prototype.setToken=function setToken(token){this._token=token};EventPublisher.prototype.enable=function enable(){this._isEnabled=true};EventPublisher.prototype.disable=function disable(){this._isEnabled=false};function formatMetric(sample){return{timestamp:new Date(sample.timestamp).toISOString(),total_packets_received:sample.totals.packetsReceived,total_packets_lost:sample.totals.packetsLost,total_packets_sent:sample.totals.packetsSent,total_bytes_received:sample.totals.bytesReceived,total_bytes_sent:sample.totals.bytesSent,packets_received:sample.packetsReceived,packets_lost:sample.packetsLost,packets_lost_fraction:sample.packetsLostFraction&&Math.round(sample.packetsLostFraction*100)/100,audio_level_in:sample.audioInputLevel,audio_level_out:sample.audioOutputLevel,call_volume_input:sample.inputVolume,call_volume_output:sample.outputVolume,jitter:sample.jitter,rtt:sample.rtt,mos:sample.mos&&Math.round(sample.mos*100)/100}}module.exports=EventPublisher},{"./request":12}],8:[function(require,module,exports){function mixinLog(object,prefix){function log(){var args=[];for(var _i=0;_i<arguments.length;_i++){args[_i]=arguments[_i]}if(!log.enabled){return}var format=log.prefix?log.prefix+" ":"";for(var i=0;i<args.length;i++){var arg=args[i];log.handler(typeof arg==="string"?format+arg:arg)}}function defaultWarnHandler(x){if(typeof console!=="undefined"){if(typeof console.warn==="function"){console.warn(x)}else if(typeof console.log==="function"){console.log(x)}}}function deprecated(){var args=[];for(var _i=0;_i<arguments.length;_i++){args[_i]=arguments[_i]}if(!log.warnings){return}for(var i=0;i<args.length;i++){var arg=args[i];log.warnHandler(arg)}}log.enabled=true;log.prefix=prefix||"";log.defaultHandler=function(x){if(typeof console!=="undefined"){console.log(x)}};log.handler=log.defaultHandler;log.warnings=true;log.defaultWarnHandler=defaultWarnHandler;log.warnHandler=log.defaultWarnHandler;log.deprecated=deprecated;log.warn=deprecated;object.log=log}exports.mixinLog=mixinLog},{}],9:[function(require,module,exports){var Log=require("./log");var SOUNDS_DEPRECATION_WARNING=require("./strings").SOUNDS_DEPRECATION_WARNING;exports.Options=function(){function Options(defaults,assignments){if(!(this instanceof Options)){return new Options(defaults)}this.__dict__={};defaults=defaults||{};assignments=assignments||{};Log.mixinLog(this,"[Sounds]");var hasBeenWarned=false;function makeprop(__dict__,name,log){return function(value,shouldSilence){if(!shouldSilence&&!hasBeenWarned){hasBeenWarned=true;log.deprecated(SOUNDS_DEPRECATION_WARNING)}if(typeof value!=="undefined"){__dict__[name]=value}return __dict__[name]}}var name;for(name in defaults){this[name]=makeprop(this.__dict__,name,this.log);this[name](defaults[name],true)}for(name in assignments){this[name](assignments[name],true)}}return Options}()},{"./log":8,"./strings":26}],10:[function(require,module,exports){var util=require("./util");var DEFAULT_TEST_SOUND_URL=util.getTwilioRoot()+"sounds/releases/"+util.getSoundVersion()+"/outgoing.mp3";function OutputDeviceCollection(name,availableDevices,beforeChange,isSupported){Object.defineProperties(this,{_activeDevices:{value:new Set},_availableDevices:{value:availableDevices},_beforeChange:{value:beforeChange},_isSupported:{value:isSupported},_name:{value:name}})}OutputDeviceCollection.prototype._delete=function _delete(device){var wasDeleted=this._activeDevices.delete(device);var defaultDevice=this._availableDevices.get("default")||Array.from(this._availableDevices.values())[0];if(!this._activeDevices.size&&defaultDevice){this._activeDevices.add(defaultDevice)}var deviceIds=Array.from(this._activeDevices.values()).map(function(deviceInfo){return deviceInfo.deviceId});this._beforeChange(this._name,deviceIds);return wasDeleted};OutputDeviceCollection.prototype.get=function get(){return this._activeDevices};OutputDeviceCollection.prototype.set=function set(deviceIds){if(!this._isSupported){return Promise.reject(new Error("This browser does not support audio output selection"))}deviceIds=Array.isArray(deviceIds)?deviceIds:[deviceIds];if(!deviceIds.length){return Promise.reject(new Error("Must specify at least one device to set"))}var missingIds=[];var devices=deviceIds.map(function(id){var device=this._availableDevices.get(id);if(!device){missingIds.push(id)}return device},this);if(missingIds.length){return Promise.reject(new Error("Devices not found: "+missingIds.join(", ")))}var self=this;function updateDevices(){self._activeDevices.clear();devices.forEach(self._activeDevices.add,self._activeDevices)}return new Promise(function(resolve){resolve(self._beforeChange(self._name,deviceIds))}).then(updateDevices)};OutputDeviceCollection.prototype.test=function test(soundUrl){if(!this._isSupported){return Promise.reject(new Error("This browser does not support audio output selection"))}soundUrl=soundUrl||DEFAULT_TEST_SOUND_URL;if(!this._activeDevices.size){return Promise.reject(new Error("No active output devices to test"))}return Promise.all(Array.from(this._activeDevices).map(function(device){var el=new Audio([soundUrl]);return el.setSinkId(device.deviceId).then(function(){return el.play()})}))};module.exports=OutputDeviceCollection},{"./util":28}],11:[function(require,module,exports){var EventEmitter=require("events").EventEmitter;var util=require("util");var log=require("./log");var twutil=require("./util");var WSTransport=require("./wstransport").default;var PSTREAM_VERSION="1.4";function PStream(token,uri,options){if(!(this instanceof PStream)){return new PStream(token,uri,options)}twutil.monitorEventEmitter("Twilio.PStream",this);var defaults={logPrefix:"[PStream]",secureSignaling:true,TransportFactory:WSTransport,debug:false};options=options||{};for(var prop in defaults){if(prop in options)continue;options[prop]=defaults[prop]}this.options=options;this.token=token||"";this.status="disconnected";this.uri=uri;this.gateway=null;this.region=null;this._messageQueue=[];this._handleTransportClose=this._handleTransportClose.bind(this);this._handleTransportError=this._handleTransportError.bind(this);this._handleTransportMessage=this._handleTransportMessage.bind(this);this._handleTransportOpen=this._handleTransportOpen.bind(this);log.mixinLog(this,this.options.logPrefix);this.log.enabled=this.options.debug;this.on("error",function(){});var self=this;this.addListener("ready",function(){self.status="ready"});this.addListener("offline",function(){self.status="offline"});this.addListener("close",function(){self.log('Received "close" from server. Destroying PStream...');self._destroy()});this.transport=new this.options.TransportFactory(this.uri,{logLevel:this.options.debug?"debug":"off"});this.transport.on("close",this._handleTransportClose);this.transport.on("error",this._handleTransportError);this.transport.on("message",this._handleTransportMessage);this.transport.on("open",this._handleTransportOpen);this.transport.open();return this}util.inherits(PStream,EventEmitter);PStream.prototype._handleTransportClose=function(){if(this.status!=="disconnected"){if(this.status!=="offline"){this.emit("offline",this)}this.status="disconnected"}};PStream.prototype._handleTransportError=function(err){this.emit("error",err)};PStream.prototype._handleTransportMessage=function(msg){var objects=twutil.splitObjects(msg.data);for(var i=0;i<objects.length;i++){var obj=JSON.parse(objects[i]);var eventType=obj.type;var payload=obj.payload||{};if(payload.gateway){this.gateway=payload.gateway}if(payload.region){this.region=payload.region}this.emit(eventType,payload)}};PStream.prototype._handleTransportOpen=function(){var _this=this;this.status="connected";this.setToken(this.token);var messages=this._messageQueue.splice(0,this._messageQueue.length);messages.forEach(function(message){return _this._publish.apply(_this,message)})};PStream.toString=function(){return"[Twilio.PStream class]"};PStream.prototype.toString=function(){return"[Twilio.PStream instance]"};PStream.prototype.setToken=function(token){this.log("Setting token and publishing listen");this.token=token;var payload={token:token,browserinfo:twutil.getSystemInfo()};this._publish("listen",payload)};PStream.prototype.register=function(mediaCapabilities){var regPayload={media:mediaCapabilities};this._publish("register",regPayload,true)};PStream.prototype._destroy=function(){this.transport.removeListener("close",this._handleTransportClose);this.transport.removeListener("error",this._handleTransportError);this.transport.removeListener("message",this._handleTransportMessage);this.transport.removeListener("open",this._handleTransportOpen);this.transport.close();this.emit("offline",this)};PStream.prototype.destroy=function(){this.log("PStream.destroy() called...");this._destroy();return this};PStream.prototype.publish=function(type,payload){return this._publish(type,payload,true)};PStream.prototype._publish=function(type,payload,shouldRetry){var msg=JSON.stringify({type:type,version:PSTREAM_VERSION,payload:payload});if(!this.transport.send(msg)&&shouldRetry){this._messageQueue.push([type,payload,true])}};exports.PStream=PStream},{"./log":8,"./util":28,"./wstransport":29,events:43,util:55}],12:[function(require,module,exports){var XHR=require("xmlhttprequest").XMLHttpRequest;function request(method,params,callback){var options={};options.XMLHttpRequest=options.XMLHttpRequest||XHR;var xhr=new options.XMLHttpRequest;xhr.open(method,params.url,true);xhr.onreadystatechange=function onreadystatechange(){if(xhr.readyState!==4){return}if(200<=xhr.status&&xhr.status<300){callback(null,xhr.responseText);return}callback(new Error(xhr.responseText))};for(var headerName in params.headers){xhr.setRequestHeader(headerName,params.headers[headerName])}xhr.send(JSON.stringify(params.body))}var Request=request;Request.get=function get(params,callback){return new this("GET",params,callback)};Request.post=function post(params,callback){return new this("POST",params,callback)};module.exports=Request},{xmlhttprequest:2}],13:[function(require,module,exports){var util=require("../util");function getUserMedia(constraints,options){options=options||{};options.util=options.util||util;options.navigator=options.navigator||(typeof navigator!=="undefined"?navigator:null);return new Promise(function(resolve,reject){if(!options.navigator){throw new Error("getUserMedia is not supported")}switch("function"){case typeof(options.navigator.mediaDevices&&options.navigator.mediaDevices.getUserMedia):return resolve(options.navigator.mediaDevices.getUserMedia(constraints));case typeof options.navigator.webkitGetUserMedia:return options.navigator.webkitGetUserMedia(constraints,resolve,reject);case typeof options.navigator.mozGetUserMedia:return options.navigator.mozGetUserMedia(constraints,resolve,reject);case typeof options.navigator.getUserMedia:return options.navigator.getUserMedia(constraints,resolve,reject);default:throw new Error("getUserMedia is not supported")}}).catch(function(e){throw options.util.isFirefox()&&e.name==="NotReadableError"?new Error("Firefox does not currently support opening multiple audio input tracks"+"simultaneously, even across different tabs.\n"+"Related Bugzilla thread: https://bugzilla.mozilla.org/show_bug.cgi?id=1299324"):e})}module.exports=getUserMedia},{"../util":28}],14:[function(require,module,exports){var PeerConnection=require("./peerconnection");function enabled(set){if(typeof set!=="undefined"){PeerConnection.enabled=set}return PeerConnection.enabled}function getMediaEngine(){return typeof RTCIceGatherer!=="undefined"?"ORTC":"WebRTC"}module.exports={enabled:enabled,getMediaEngine:getMediaEngine,PeerConnection:PeerConnection}},{"./peerconnection":18}],15:[function(require,module,exports){var OLD_MAX_VOLUME=32767;var NativeRTCStatsReport=typeof window!=="undefined"?window.RTCStatsReport:undefined;function MockRTCStatsReport(statsMap){if(!(this instanceof MockRTCStatsReport)){return new MockRTCStatsReport(statsMap)}var self=this;Object.defineProperties(this,{size:{enumerable:true,get:function(){return self._map.size}},_map:{value:statsMap}});this[Symbol.iterator]=statsMap[Symbol.iterator]}if(NativeRTCStatsReport){MockRTCStatsReport.prototype=Object.create(NativeRTCStatsReport.prototype);MockRTCStatsReport.prototype.constructor=MockRTCStatsReport}["entries","forEach","get","has","keys","values"].forEach(function(key){MockRTCStatsReport.prototype[key]=function(){var args=[];for(var _i=0;_i<arguments.length;_i++){args[_i]=arguments[_i]}return(_a=this._map)[key].apply(_a,args);var _a}});MockRTCStatsReport.fromArray=function fromArray(array){return new MockRTCStatsReport(array.reduce(function(map,rtcStats){map.set(rtcStats.id,rtcStats);return map},new Map))};MockRTCStatsReport.fromRTCStatsResponse=function fromRTCStatsResponse(statsResponse){var activeCandidatePairId;var transportIds=new Map;var statsMap=statsResponse.result().reduce(function(map,report){var id=report.id;switch(report.type){case"googCertificate":map.set(id,createRTCCertificateStats(report));break;case"datachannel":map.set(id,createRTCDataChannelStats(report));break;case"googCandidatePair":if(getBoolean(report,"googActiveConnection")){activeCandidatePairId=id}map.set(id,createRTCIceCandidatePairStats(report));break;case"localcandidate":map.set(id,createRTCIceCandidateStats(report,false));break;case"remotecandidate":map.set(id,createRTCIceCandidateStats(report,true));break;case"ssrc":if(isPresent(report,"packetsReceived")){map.set("rtp-"+id,createRTCInboundRTPStreamStats(report))}else{map.set("rtp-"+id,createRTCOutboundRTPStreamStats(report))}map.set("track-"+id,createRTCMediaStreamTrackStats(report));map.set("codec-"+id,createRTCCodecStats(report));break;case"googComponent":var transportReport=createRTCTransportStats(report);transportIds.set(transportReport.selectedCandidatePairId,id);map.set(id,createRTCTransportStats(report));break}return map},new Map);if(activeCandidatePairId){var activeTransportId=transportIds.get(activeCandidatePairId);if(activeTransportId){statsMap.get(activeTransportId).dtlsState="connected"}}return new MockRTCStatsReport(statsMap)};function createRTCTransportStats(report){return{type:"transport",id:report.id,timestamp:Date.parse(report.timestamp),bytesSent:undefined,bytesReceived:undefined,rtcpTransportStatsId:undefined,dtlsState:undefined,selectedCandidatePairId:report.stat("selectedCandidatePairId"),localCertificateId:report.stat("localCertificateId"),remoteCertificateId:report.stat("remoteCertificateId")}}function createRTCCodecStats(report){return{type:"codec",id:report.id,timestamp:Date.parse(report.timestamp),payloadType:undefined,mimeType:report.stat("mediaType")+"/"+report.stat("googCodecName"),clockRate:undefined,channels:undefined,sdpFmtpLine:undefined,implementation:undefined}}function createRTCMediaStreamTrackStats(report){return{type:"track",id:report.id,timestamp:Date.parse(report.timestamp),trackIdentifier:report.stat("googTrackId"),remoteSource:undefined,ended:undefined,kind:report.stat("mediaType"),detached:undefined,ssrcIds:undefined,frameWidth:isPresent(report,"googFrameWidthReceived")?getInt(report,"googFrameWidthReceived"):getInt(report,"googFrameWidthSent"),frameHeight:isPresent(report,"googFrameHeightReceived")?getInt(report,"googFrameHeightReceived"):getInt(report,"googFrameHeightSent"),framesPerSecond:undefined,framesSent:getInt(report,"framesEncoded"),framesReceived:undefined,framesDecoded:getInt(report,"framesDecoded"),framesDropped:undefined,framesCorrupted:undefined,partialFramesLost:undefined,fullFramesLost:undefined,audioLevel:isPresent(report,"audioOutputLevel")?getInt(report,"audioOutputLevel")/OLD_MAX_VOLUME:(getInt(report,"audioInputLevel")||0)/OLD_MAX_VOLUME,echoReturnLoss:getFloat(report,"googEchoCancellationReturnLoss"),echoReturnLossEnhancement:getFloat(report,"googEchoCancellationReturnLossEnhancement")}}function createRTCRTPStreamStats(report,isInbound){return{id:report.id,timestamp:Date.parse(report.timestamp),ssrc:report.stat("ssrc"),associateStatsId:undefined,isRemote:undefined,mediaType:report.stat("mediaType"),trackId:"track-"+report.id,transportId:report.stat("transportId"),codecId:"codec-"+report.id,firCount:isInbound?getInt(report,"googFirsSent"):undefined,pliCount:isInbound?getInt(report,"googPlisSent"):getInt(report,"googPlisReceived"),nackCount:isInbound?getInt(report,"googNacksSent"):getInt(report,"googNacksReceived"),sliCount:undefined,qpSum:getInt(report,"qpSum")}}function createRTCInboundRTPStreamStats(report){var rtp=createRTCRTPStreamStats(report,true);Object.assign(rtp,{type:"inbound-rtp",packetsReceived:getInt(report,"packetsReceived"),bytesReceived:getInt(report,"bytesReceived"),packetsLost:getInt(report,"packetsLost"),jitter:convertMsToSeconds(report.stat("googJitterReceived")),fractionLost:undefined,roundTripTime:convertMsToSeconds(report.stat("googRtt")),packetsDiscarded:undefined,packetsRepaired:undefined,burstPacketsLost:undefined,burstPacketsDiscarded:undefined,burstLossCount:undefined,burstDiscardCount:undefined,burstLossRate:undefined,burstDiscardRate:undefined,gapLossRate:undefined,gapDiscardRate:undefined,framesDecoded:getInt(report,"framesDecoded")});return rtp}function createRTCOutboundRTPStreamStats(report){var rtp=createRTCRTPStreamStats(report,false);Object.assign(rtp,{type:"outbound-rtp",remoteTimestamp:undefined,packetsSent:getInt(report,"packetsSent"),bytesSent:getInt(report,"bytesSent"),targetBitrate:undefined,framesEncoded:getInt(report,"framesEncoded")});return rtp}function createRTCIceCandidateStats(report,isRemote){return{type:isRemote?"remote-candidate":"local-candidate",id:report.id,timestamp:Date.parse(report.timestamp),transportId:undefined,isRemote:isRemote,ip:report.stat("ipAddress"),port:getInt(report,"portNumber"),protocol:report.stat("transport"),candidateType:translateCandidateType(report.stat("candidateType")),priority:getFloat(report,"priority"),url:undefined,relayProtocol:undefined,deleted:undefined}}function createRTCIceCandidatePairStats(report){return{type:"candidate-pair",id:report.id,timestamp:Date.parse(report.timestamp),transportId:report.stat("googChannelId"),localCandidateId:report.stat("localCandidateId"),remoteCandidateId:report.stat("remoteCandidateId"),state:undefined,priority:undefined,nominated:undefined,writable:getBoolean(report,"googWritable"),readable:undefined,bytesSent:getInt(report,"bytesSent"),bytesReceived:getInt(report,"bytesReceived"),lastPacketSentTimestamp:undefined,lastPacketReceivedTimestamp:undefined,totalRoundTripTime:undefined,currentRoundTripTime:convertMsToSeconds(report.stat("googRtt")),availableOutgoingBitrate:undefined,availableIncomingBitrate:undefined,requestsReceived:getInt(report,"requestsReceived"),requestsSent:getInt(report,"requestsSent"),responsesReceived:getInt(report,"responsesReceived"),responsesSent:getInt(report,"responsesSent"),retransmissionsReceived:undefined,retransmissionsSent:undefined,consentRequestsSent:getInt(report,"consentRequestsSent")}}function createRTCCertificateStats(report){return{type:"certificate",id:report.id,timestamp:Date.parse(report.timestamp),fingerprint:report.stat("googFingerprint"),fingerprintAlgorithm:report.stat("googFingerprintAlgorithm"),base64Certificate:report.stat("googDerBase64"),issuerCertificateId:report.stat("googIssuerId")}}function createRTCDataChannelStats(report){return{type:"data-channel",id:report.id,timestamp:Date.parse(report.timestamp),label:report.stat("label"),protocol:report.stat("protocol"),datachannelid:report.stat("datachannelid"),transportId:report.stat("transportId"),state:report.stat("state"),messagesSent:undefined,bytesSent:undefined,messagesReceived:undefined,bytesReceived:undefined}}function convertMsToSeconds(inMs){return isNaN(inMs)||inMs===""?undefined:parseInt(inMs,10)/1e3}function translateCandidateType(type){switch(type){case"peerreflexive":return"prflx";case"serverreflexive":return"srflx";case"host":case"relay":default:return type}}function getInt(report,statName){var stat=report.stat(statName);return isPresent(report,statName)?parseInt(stat,10):undefined}function getFloat(report,statName){var stat=report.stat(statName);return isPresent(report,statName)?parseFloat(stat):undefined}function getBoolean(report,statName){var stat=report.stat(statName);return isPresent(report,statName)?stat==="true"||stat===true:undefined}function isPresent(report,statName){var stat=report.stat(statName);return typeof stat!=="undefined"&&stat!==""}module.exports=MockRTCStatsReport},{}],16:[function(require,module,exports){var EventEmitter=require("events").EventEmitter;var getStatistics=require("./stats");var inherits=require("util").inherits;var Mos=require("./mos");var SAMPLE_COUNT_METRICS=5;var SAMPLE_COUNT_CLEAR=0;var SAMPLE_COUNT_RAISE=3;var SAMPLE_INTERVAL=1e3;var WARNING_TIMEOUT=5*1e3;var DEFAULT_THRESHOLDS={audioInputLevel:{maxDuration:10},audioOutputLevel:{maxDuration:10},packetsLostFraction:{max:1},jitter:{max:30},rtt:{max:400},mos:{min:3}};function RTCMonitor(options){if(!(this instanceof RTCMonitor)){return new RTCMonitor(options)}options=options||{};var thresholds=Object.assign({},DEFAULT_THRESHOLDS,options.thresholds);Object.defineProperties(this,{_activeWarnings:{value:new Map},_currentStreaks:{value:new Map},_peerConnection:{value:options.peerConnection,writable:true},_sampleBuffer:{value:[]},_sampleInterval:{value:null,writable:true},_thresholds:{value:thresholds},_warningsEnabled:{value:true,writable:true}});if(options.peerConnection){this.enable()}EventEmitter.call(this)}inherits(RTCMonitor,EventEmitter);RTCMonitor.createSample=function createSample(stats,previousSample){var previousPacketsSent=previousSample&&previousSample.totals.packetsSent||0;var previousPacketsReceived=previousSample&&previousSample.totals.packetsReceived||0;var previousPacketsLost=previousSample&&previousSample.totals.packetsLost||0;var currentPacketsSent=stats.packetsSent-previousPacketsSent;var currentPacketsReceived=stats.packetsReceived-previousPacketsReceived;var currentPacketsLost=stats.packetsLost-previousPacketsLost;var currentInboundPackets=currentPacketsReceived+currentPacketsLost;var currentPacketsLostFraction=currentInboundPackets>0?currentPacketsLost/currentInboundPackets*100:0;var totalInboundPackets=stats.packetsReceived+stats.packetsLost;var totalPacketsLostFraction=totalInboundPackets>0?stats.packetsLost/totalInboundPackets*100:100;return{timestamp:stats.timestamp,totals:{packetsReceived:stats.packetsReceived,packetsLost:stats.packetsLost,packetsSent:stats.packetsSent,packetsLostFraction:totalPacketsLostFraction,bytesReceived:stats.bytesReceived,bytesSent:stats.bytesSent},packetsSent:currentPacketsSent,packetsReceived:currentPacketsReceived,packetsLost:currentPacketsLost,packetsLostFraction:currentPacketsLostFraction,audioInputLevel:stats.audioInputLevel,audioOutputLevel:stats.audioOutputLevel,jitter:stats.jitter,rtt:stats.rtt,mos:Mos.calculate(stats,previousSample&&currentPacketsLostFraction)}};RTCMonitor.prototype.enable=function enable(peerConnection){if(peerConnection){if(this._peerConnection&&peerConnection!==this._peerConnection){throw new Error("Attempted to replace an existing PeerConnection in RTCMonitor.enable")}this._peerConnection=peerConnection}if(!this._peerConnection){throw new Error("Can not enable RTCMonitor without a PeerConnection")}this._sampleInterval=this._sampleInterval||setInterval(this._fetchSample.bind(this),SAMPLE_INTERVAL);return this};RTCMonitor.prototype.disable=function disable(){clearInterval(this._sampleInterval);this._sampleInterval=null;return this};RTCMonitor.prototype.getSample=function getSample(){var pc=this._peerConnection;var self=this;return getStatistics(pc).then(function(stats){var previousSample=self._sampleBuffer.length&&self._sampleBuffer[self._sampleBuffer.length-1];return RTCMonitor.createSample(stats,previousSample)})};RTCMonitor.prototype._fetchSample=function _fetchSample(){var self=this;return this.getSample().then(function addSample(sample){self._addSample(sample);self._raiseWarnings();self.emit("sample",sample);return sample},function getSampleFailed(error){self.disable();self.emit("error",error)})};RTCMonitor.prototype._addSample=function _addSample(sample){var samples=this._sampleBuffer;samples.push(sample);if(samples.length>SAMPLE_COUNT_METRICS){samples.splice(0,samples.length-SAMPLE_COUNT_METRICS)}};RTCMonitor.prototype._raiseWarnings=function _raiseWarnings(){if(!this._warningsEnabled){return}for(var name_1 in this._thresholds){this._raiseWarningsForStat(name_1)}};RTCMonitor.prototype.enableWarnings=function enableWarnings(){this._warningsEnabled=true;return this};RTCMonitor.prototype.disableWarnings=function disableWarnings(){if(this._warningsEnabled){this._activeWarnings.clear()}this._warningsEnabled=false;return this};RTCMonitor.prototype._raiseWarningsForStat=function _raiseWarningsForStat(statName){var samples=this._sampleBuffer;var limits=this._thresholds[statName];var relevantSamples=samples.slice(-SAMPLE_COUNT_METRICS);var values=relevantSamples.map(function(sample){return sample[statName]});var containsNull=values.some(function(value){return typeof value==="undefined"||value===null});if(containsNull){return}var count;if(typeof limits.max==="number"){count=countHigh(limits.max,values);if(count>=SAMPLE_COUNT_RAISE){this._raiseWarning(statName,"max",{values:values})}else if(count<=SAMPLE_COUNT_CLEAR){this._clearWarning(statName,"max",{values:values})}}if(typeof limits.min==="number"){count=countLow(limits.min,values);if(count>=SAMPLE_COUNT_RAISE){this._raiseWarning(statName,"min",{values:values})}else if(count<=SAMPLE_COUNT_CLEAR){this._clearWarning(statName,"min",{values:values})}}if(typeof limits.maxDuration==="number"&&samples.length>1){relevantSamples=samples.slice(-2);var prevValue=relevantSamples[0][statName];var curValue=relevantSamples[1][statName];var prevStreak=this._currentStreaks.get(statName)||0;var streak=prevValue===curValue?prevStreak+1:0;this._currentStreaks.set(statName,streak);if(streak>=limits.maxDuration){this._raiseWarning(statName,"maxDuration",{value:streak})}else if(streak===0){this._clearWarning(statName,"maxDuration",{value:prevStreak})}}};function countLow(min,values){return values.reduce(function(lowCount,value){return lowCount+=value<min?1:0},0)}function countHigh(max,values){return values.reduce(function(highCount,value){return highCount+=value>max?1:0},0)}RTCMonitor.prototype._clearWarning=function _clearWarning(statName,thresholdName,data){var warningId=statName+":"+thresholdName;var activeWarning=this._activeWarnings.get(warningId);if(!activeWarning||Date.now()-activeWarning.timeRaised<WARNING_TIMEOUT){return}this._activeWarnings.delete(warningId);this.emit("warning-cleared",Object.assign({name:statName,threshold:{name:thresholdName,value:this._thresholds[statName][thresholdName]}},data))};RTCMonitor.prototype._raiseWarning=function _raiseWarning(statName,thresholdName,data){var warningId=statName+":"+thresholdName;if(this._activeWarnings.has(warningId)){return}this._activeWarnings.set(warningId,{timeRaised:Date.now()});this.emit("warning",Object.assign({name:statName,threshold:{name:thresholdName,value:this._thresholds[statName][thresholdName]}},data))};module.exports=RTCMonitor},{"./mos":17,"./stats":20,events:43,util:55}],17:[function(require,module,exports){var rfactorConstants={r0:94.768,is:1.42611};function calcMos(sample,fractionLost){if(!sample||!isPositiveNumber(sample.rtt)||!isPositiveNumber(sample.jitter)||!isPositiveNumber(fractionLost)){return null}var rFactor=calculateRFactor(sample.rtt,sample.jitter,fractionLost);var mos=1+.035*rFactor+7e-6*rFactor*(rFactor-60)*(100-rFactor);var isValid=mos>=1&&mos<4.6;return isValid?mos:null}function calculateRFactor(rtt,jitter,fractionLost){var effectiveLatency=rtt+jitter*2+10;var rFactor=0;switch(true){case effectiveLatency<160:rFactor=rfactorConstants.r0-effectiveLatency/40;break;case effectiveLatency<1e3:rFactor=rfactorConstants.r0-(effectiveLatency-120)/10;break;case effectiveLatency>=1e3:rFactor=rfactorConstants.r0-effectiveLatency/100;break}var multiplier=.01;switch(true){case fractionLost===-1:multiplier=0;rFactor=0;break;case fractionLost<=rFactor/2.5:multiplier=2.5;break;case fractionLost>rFactor/2.5&&fractionLost<100:multiplier=.25;break}rFactor-=fractionLost*multiplier;return rFactor}function isPositiveNumber(n){return typeof n==="number"&&!isNaN(n)&&isFinite(n)&&n>=0}module.exports={calculate:calcMos}},{}],18:[function(require,module,exports){var Log=require("../log");var StateMachine=require("../statemachine");var util=require("../util");var RTCPC=require("./rtcpc");var ICE_CONNECTION_STATES={new:["checking","closed"],checking:["new","connected","failed","closed","completed"],connected:["new","disconnected","completed","closed"],completed:["new","disconnected","closed","completed"],failed:["new","disconnected","closed"],disconnected:["connected","completed","failed","closed"],closed:[]};var INITIAL_ICE_CONNECTION_STATE="new";var SIGNALING_STATES={stable:["have-local-offer","have-remote-offer","closed"],"have-local-offer":["stable","closed"],"have-remote-offer":["stable","closed"],closed:[]};var INITIAL_SIGNALING_STATE="stable";function PeerConnection(device,getUserMedia,options){if(!device||!getUserMedia){throw new Error("Device and getUserMedia are required arguments")}if(!(this instanceof PeerConnection)){return new PeerConnection(device,getUserMedia,options)}function noop(){}this.onopen=noop;this.onerror=noop;this.onclose=noop;this.ondisconnect=noop;this.onreconnect=noop;this.onsignalingstatechange=noop;this.oniceconnectionstatechange=noop;this.onicecandidate=noop;this.onvolume=noop;this.version=null;this.pstream=device.stream;this.stream=null;this.sinkIds=new Set(["default"]);this.outputs=new Map;this.status="connecting";this.callSid=null;this.isMuted=false;this.getUserMedia=getUserMedia;var AudioContext=typeof window!=="undefined"&&(window.AudioContext||window.webkitAudioContext);this._isSinkSupported=!!AudioContext&&typeof HTMLAudioElement!=="undefined"&&HTMLAudioElement.prototype.setSinkId;this._audioContext=AudioContext&&device.audio._audioContext;this._masterAudio=null;this._masterAudioDeviceId=null;this._mediaStreamSource=null;this._dtmfSender=null;this._dtmfSenderUnsupported=false;this._callEvents=[];this._nextTimeToPublish=Date.now();this._onAnswerOrRinging=noop;this._remoteStream=null;this._shouldManageStream=true;Log.mixinLog(this,"[Twilio.PeerConnection]");this.log.enabled=device.options.debug;this.log.warnings=device.options.warnings;this._iceConnectionStateMachine=new StateMachine(ICE_CONNECTION_STATES,INITIAL_ICE_CONNECTION_STATE);this._signalingStateMachine=new StateMachine(SIGNALING_STATES,INITIAL_SIGNALING_STATE);this.options=options=options||{};this.navigator=options.navigator||(typeof navigator!=="undefined"?navigator:null);this.util=options.util||util;return this}PeerConnection.prototype.uri=function(){return this._uri};PeerConnection.prototype.openWithConstraints=function(constraints){return this.getUserMedia({audio:constraints}).then(this._setInputTracksFromStream.bind(this,false))};PeerConnection.prototype.setInputTracksFromStream=function(stream){var self=this;return this._setInputTracksFromStream(true,stream).then(function(){self._shouldManageStream=false})};PeerConnection.prototype._createAnalyser=function(stream,audioContext){var analyser=audioContext.createAnalyser();analyser.fftSize=32;analyser.smoothingTimeConstant=.3;var streamSource=audioContext.createMediaStreamSource(stream);streamSource.connect(analyser);return analyser};PeerConnection.prototype._setVolumeHandler=function(handler){this.onvolume=handler};PeerConnection.prototype._startPollingVolume=function(){if(!this._audioContext||!this.stream||!this._remoteStream){return}var audioContext=this._audioContext;var inputAnalyser=this._inputAnalyser=this._createAnalyser(this.stream,audioContext);var inputBufferLength=inputAnalyser.frequencyBinCount;var inputDataArray=new Uint8Array(inputBufferLength);var outputAnalyser=this._outputAnalyser=this._createAnalyser(this._remoteStream,audioContext);var outputBufferLength=outputAnalyser.frequencyBinCount;var outputDataArray=new Uint8Array(outputBufferLength);var self=this;requestAnimationFrame(function emitVolume(){if(!self._audioContext){return}else if(self.status==="closed"){self._inputAnalyser.disconnect();self._outputAnalyser.disconnect();return}self._inputAnalyser.getByteFrequencyData(inputDataArray);var inputVolume=self.util.average(inputDataArray);self._outputAnalyser.getByteFrequencyData(outputDataArray);var outputVolume=self.util.average(outputDataArray);self.onvolume(inputVolume/255,outputVolume/255);requestAnimationFrame(emitVolume)})};PeerConnection.prototype._stopStream=function _stopStream(stream){if(!this._shouldManageStream){return}if(typeof MediaStreamTrack.prototype.stop==="function"){var audioTracks=typeof stream.getAudioTracks==="function"?stream.getAudioTracks():stream.audioTracks;audioTracks.forEach(function(track){track.stop()})}else{stream.stop()}};PeerConnection.prototype._setInputTracksFromStream=function(shouldClone,newStream){var self=this;if(!newStream){return Promise.reject(new Error("Can not set input stream to null while in a call"))}if(!newStream.getAudioTracks().length){return Promise.reject(new Error("Supplied input stream has no audio tracks"))}var localStream=this.stream;if(!localStream){this.stream=shouldClone?cloneStream(newStream):newStream}else{this._stopStream(localStream);removeStream(this.version.pc,localStream);localStream.getAudioTracks().forEach(localStream.removeTrack,localStream);newStream.getAudioTracks().forEach(localStream.addTrack,localStream);addStream(this.version.pc,newStream)}this.mute(this.isMuted);if(!this.version){return Promise.resolve(this.stream)}return new Promise(function(resolve,reject){self.version.createOffer({audio:true},function onOfferSuccess(){self.version.processAnswer(self._answerSdp,function(){if(self._audioContext){self._inputAnalyser=self._createAnalyser(self.stream,self._audioContext)}resolve(self.stream)},reject)},reject)})};PeerConnection.prototype._onInputDevicesChanged=function(){if(!this.stream){return}var activeInputWasLost=this.stream.getAudioTracks().every(function(track){return track.readyState==="ended"});if(activeInputWasLost&&this._shouldManageStream){this.openWithConstraints(true)}};PeerConnection.prototype._setSinkIds=function(sinkIds){if(!this._isSinkSupported){return Promise.reject(new Error("Audio output selection is not supported by this browser"))}this.sinkIds=new Set(sinkIds.forEach?sinkIds:[sinkIds]);return this.version?this._updateAudioOutputs():Promise.resolve()};PeerConnection.prototype._updateAudioOutputs=function updateAudioOutputs(){var addedOutputIds=Array.from(this.sinkIds).filter(function(id){return!this.outputs.has(id)},this);var removedOutputIds=Array.from(this.outputs.keys()).filter(function(id){return!this.sinkIds.has(id)},this);var self=this;var createOutputPromises=addedOutputIds.map(this._createAudioOutput,this);return Promise.all(createOutputPromises).then(function(){return Promise.all(removedOutputIds.map(self._removeAudioOutput,self))})};PeerConnection.prototype._createAudio=function createAudio(arr){return new Audio(arr)};PeerConnection.prototype._createAudioOutput=function createAudioOutput(id){var dest=this._audioContext.createMediaStreamDestination();this._mediaStreamSource.connect(dest);var audio=this._createAudio();setAudioSource(audio,dest.stream);var self=this;return audio.setSinkId(id).then(function(){return audio.play()}).then(function(){self.outputs.set(id,{audio:audio,dest:dest})})};PeerConnection.prototype._removeAudioOutputs=function removeAudioOutputs(){return Array.from(this.outputs.keys()).map(this._removeAudioOutput,this)};PeerConnection.prototype._disableOutput=function disableOutput(pc,id){var output=pc.outputs.get(id);if(!output){return}if(output.audio){output.audio.pause();output.audio.src=""}if(output.dest){output.dest.disconnect()}};PeerConnection.prototype._reassignMasterOutput=function reassignMasterOutput(pc,masterId){var masterOutput=pc.outputs.get(masterId);pc.outputs.delete(masterId);var self=this;var idToReplace=Array.from(pc.outputs.keys())[0]||"default";return masterOutput.audio.setSinkId(idToReplace).then(function(){self._disableOutput(pc,idToReplace);pc.outputs.set(idToReplace,masterOutput);pc._masterAudioDeviceId=idToReplace}).catch(function rollback(reason){pc.outputs.set(masterId,masterOutput);throw reason})};PeerConnection.prototype._removeAudioOutput=function removeAudioOutput(id){if(this._masterAudioDeviceId===id){return this._reassignMasterOutput(this,id)}this._disableOutput(this,id);this.outputs.delete(id);return Promise.resolve()};PeerConnection.prototype._onAddTrack=function onAddTrack(pc,stream){var audio=pc._masterAudio=this._createAudio();setAudioSource(audio,stream);audio.play();var deviceId=Array.from(pc.outputs.keys())[0]||"default";pc._masterAudioDeviceId=deviceId;pc.outputs.set(deviceId,{audio:audio});pc._mediaStreamSource=pc._audioContext.createMediaStreamSource(stream);pc.pcStream=stream;pc._updateAudioOutputs()};PeerConnection.prototype._fallbackOnAddTrack=function fallbackOnAddTrack(pc,stream){var audio=document&&document.createElement("audio");audio.autoplay=true;if(!setAudioSource(audio,stream)){pc.log("Error attaching stream to element.")}pc.outputs.set("default",{audio:audio})};PeerConnection.prototype._setupPeerConnection=function(rtcConstraints,iceServers){var self=this;var version=this._getProtocol();version.create(this.log,rtcConstraints,iceServers);addStream(version.pc,this.stream);var eventName="ontrack"in version.pc?"ontrack":"onaddstream";version.pc[eventName]=function(event){var stream=self._remoteStream=event.stream||event.streams[0];if(self._isSinkSupported){self._onAddTrack(self,stream)}else{self._fallbackOnAddTrack(self,stream)}self._startPollingVolume()};return version};PeerConnection.prototype._setupChannel=function(){var self=this;var pc=this.version.pc;self.version.pc.onopen=function(){self.status="open";self.onopen()};self.version.pc.onstatechange=function(){if(self.version.pc&&self.version.pc.readyState==="stable"){self.status="open";self.onopen()}};self.version.pc.onsignalingstatechange=function(){var state=pc.signalingState;self.log('signalingState is "'+state+'"');try{self._signalingStateMachine.transition(state)}catch(error){self.log("Failed to transition to signaling state "+state+": "+error)}if(self.version.pc&&self.version.pc.signalingState==="stable"){self.status="open";self.onopen()}self.onsignalingstatechange(pc.signalingState)};pc.onicecandidate=function onicecandidate(event){self.onicecandidate(event.candidate)};pc.oniceconnectionstatechange=function(){var state=pc.iceConnectionState;var previousState=self._iceConnectionStateMachine.currentState;try{self._iceConnectionStateMachine.transition(state)}catch(error){self.log("Failed to transition to ice connection state "+state+": "+error)}var message;switch(state){case"connected":if(previousState==="disconnected"){message="ICE liveliness check succeeded. Connection with Twilio restored";self.log(message);self.onreconnect(message)}break;case"disconnected":message="ICE liveliness check failed. May be having trouble connecting to Twilio";self.log(message);self.ondisconnect(message);break;case"failed":message=(previousState==="checking"?"ICE negotiation with Twilio failed.":"Connection with Twilio was interrupted.")+" Call will terminate.";self.log(message);self.onerror({info:{code:31003,message:message},disconnect:true});break;default:self.log('iceConnectionState is "'+state+'"')}self.oniceconnectionstatechange(state)}};PeerConnection.prototype._initializeMediaStream=function(rtcConstraints,iceServers){if(this.status==="open"){return false}if(this.pstream.status==="disconnected"){this.onerror({info:{code:31e3,message:"Cannot establish connection. Client is disconnected"}});this.close();return false}this.version=this._setupPeerConnection(rtcConstraints,iceServers);this._setupChannel();return true};PeerConnection.prototype.makeOutgoingCall=function(token,params,callsid,rtcConstraints,iceServers,onMediaStarted){if(!this._initializeMediaStream(rtcConstraints,iceServers)){return}var self=this;this.callSid=callsid;function onAnswerSuccess(){onMediaStarted(self.version.pc)}function onAnswerError(err){var errMsg=err.message||err;self.onerror({info:{code:31e3,message:"Error processing answer: "+errMsg}})}this._onAnswerOrRinging=function(payload){if(!payload.sdp){return}self._answerSdp=payload.sdp;if(self.status!=="closed"){self.version.processAnswer(payload.sdp,onAnswerSuccess,onAnswerError)}self.pstream.removeListener("answer",self._onAnswerOrRinging);self.pstream.removeListener("ringing",self._onAnswerOrRinging)};this.pstream.on("answer",this._onAnswerOrRinging);this.pstream.on("ringing",this._onAnswerOrRinging);function onOfferSuccess(){if(self.status!=="closed"){self.pstream.publish("invite",{sdp:self.version.getSDP(),callsid:self.callSid,twilio:{accountsid:token?self.util.objectize(token).iss:null,params:params}})}}function onOfferError(err){var errMsg=err.message||err;self.onerror({info:{code:31e3,message:"Error creating the offer: "+errMsg}})}this.version.createOffer({audio:true},onOfferSuccess,onOfferError)};PeerConnection.prototype.answerIncomingCall=function(callSid,sdp,rtcConstraints,iceServers,onMediaStarted){if(!this._initializeMediaStream(rtcConstraints,iceServers)){return}this._answerSdp=sdp.replace(/^a=setup:actpass$/gm,"a=setup:passive");this.callSid=callSid;var self=this;function onAnswerSuccess(){if(self.status!=="closed"){self.pstream.publish("answer",{callsid:callSid,sdp:self.version.getSDP()});onMediaStarted(self.version.pc)}}function onAnswerError(err){var errMsg=err.message||err;self.onerror({info:{code:31e3,message:"Error creating the answer: "+errMsg}})}this.version.processSDP(sdp,{audio:true},onAnswerSuccess,onAnswerError)};PeerConnection.prototype.close=function(){if(this.version&&this.version.pc){if(this.version.pc.signalingState!=="closed"){this.version.pc.close()}this.version.pc=null}if(this.stream){this.mute(false);this._stopStream(this.stream)}this.stream=null;if(this.pstream){this.pstream.removeListener("answer",this._onAnswerOrRinging)}this._removeAudioOutputs();if(this._mediaStreamSource){this._mediaStreamSource.disconnect()}if(this._inputAnalyser){this._inputAnalyser.disconnect()}if(this._outputAnalyser){this._outputAnalyser.disconnect()}this.status="closed";this.onclose()};PeerConnection.prototype.reject=function(callSid){this.callSid=callSid};PeerConnection.prototype.ignore=function(callSid){this.callSid=callSid};PeerConnection.prototype.mute=function(shouldMute){this.isMuted=shouldMute;if(!this.stream){return}var audioTracks=typeof this.stream.getAudioTracks==="function"?this.stream.getAudioTracks():this.stream.audioTracks;audioTracks.forEach(function(track){track.enabled=!shouldMute})};PeerConnection.prototype.getOrCreateDTMFSender=function getOrCreateDTMFSender(){if(this._dtmfSender||this._dtmfSenderUnsupported){return this._dtmfSender||null}var self=this;var pc=this.version.pc;if(!pc){this.log("No RTCPeerConnection available to call createDTMFSender on");return null}if(typeof pc.getSenders==="function"&&(typeof RTCDTMFSender==="function"||typeof RTCDtmfSender==="function")){var chosenSender=pc.getSenders().find(function(sender){return sender.dtmf});if(chosenSender){this.log("Using RTCRtpSender#dtmf");this._dtmfSender=chosenSender.dtmf;return this._dtmfSender}}if(typeof pc.createDTMFSender==="function"&&typeof pc.getLocalStreams==="function"){var track=pc.getLocalStreams().map(function(stream){var tracks=self._getAudioTracks(stream);return tracks&&tracks[0]})[0];if(!track){this.log("No local audio MediaStreamTrack available on the RTCPeerConnection to pass to createDTMFSender");return null}this.log("Creating RTCDTMFSender");this._dtmfSender=pc.createDTMFSender(track);return this._dtmfSender}this.log("RTCPeerConnection does not support RTCDTMFSender");this._dtmfSenderUnsupported=true;return null};PeerConnection.prototype._canStopMediaStreamTrack=function(){return typeof MediaStreamTrack.prototype.stop==="function"};PeerConnection.prototype._getAudioTracks=function(stream){return typeof stream.getAudioTracks==="function"?stream.getAudioTracks():stream.audioTracks};PeerConnection.prototype._getProtocol=function(){return PeerConnection.protocol};PeerConnection.protocol=function(){return RTCPC.test()?new RTCPC:null}();function addStream(pc,stream){if(typeof pc.addTrack==="function"){stream.getAudioTracks().forEach(function(track){pc.addTrack(track,stream)})}else{pc.addStream(stream)}}function cloneStream(oldStream){var newStream=typeof MediaStream!=="undefined"?new MediaStream:new webkitMediaStream;oldStream.getAudioTracks().forEach(newStream.addTrack,newStream);return newStream}function removeStream(pc,stream){if(typeof pc.removeTrack==="function"){pc.getSenders().forEach(function(sender){pc.removeTrack(sender)})}else{pc.removeStream(stream)}}function setAudioSource(audio,stream){if(typeof audio.srcObject!=="undefined"){audio.srcObject=stream}else if(typeof audio.mozSrcObject!=="undefined"){audio.mozSrcObject=stream}else if(typeof audio.src!=="undefined"){var _window=audio.options.window||window;audio.src=(_window.URL||_window.webkitURL).createObjectURL(stream)}else{return false}return true}PeerConnection.enabled=!!PeerConnection.protocol;module.exports=PeerConnection},{"../log":8,"../statemachine":25,"../util":28,"./rtcpc":19}],19:[function(require,module,exports){(function(global){var RTCPeerConnectionShim=require("rtcpeerconnection-shim");var util=require("../util");function RTCPC(){if(typeof window==="undefined"){this.log("No RTCPeerConnection implementation available. The window object was not found.");return}if(util.isEdge()){this.RTCPeerConnection=new RTCPeerConnectionShim(typeof window!=="undefined"?window:global)}else if(typeof window.RTCPeerConnection==="function"){this.RTCPeerConnection=window.RTCPeerConnection}else if(typeof window.webkitRTCPeerConnection==="function"){this.RTCPeerConnection=webkitRTCPeerConnection}else if(typeof window.mozRTCPeerConnection==="function"){this.RTCPeerConnection=mozRTCPeerConnection;window.RTCSessionDescription=mozRTCSessionDescription;window.RTCIceCandidate=mozRTCIceCandidate}else{this.log("No RTCPeerConnection implementation available")}}RTCPC.prototype.create=function(log,rtcConstraints,iceServers){this.log=log;this.pc=new this.RTCPeerConnection({iceServers:iceServers},rtcConstraints)};RTCPC.prototype.createModernConstraints=function(c){if(typeof c==="undefined"){return null}var nc={};if(typeof webkitRTCPeerConnection!=="undefined"&&!util.isEdge()){nc.mandatory={};if(typeof c.audio!=="undefined"){nc.mandatory.OfferToReceiveAudio=c.audio}if(typeof c.video!=="undefined"){nc.mandatory.OfferToReceiveVideo=c.video}}else{if(typeof c.audio!=="undefined"){nc.offerToReceiveAudio=c.audio}if(typeof c.video!=="undefined"){nc.offerToReceiveVideo=c.video}}return nc};RTCPC.prototype.createOffer=function(constraints,onSuccess,onError){var self=this;constraints=this.createModernConstraints(constraints);promisifyCreate(this.pc.createOffer,this.pc)(constraints).then(function(sd){return self.pc&&promisifySet(self.pc.setLocalDescription,self.pc)(new RTCSessionDescription(sd))}).then(onSuccess,onError)};RTCPC.prototype.createAnswer=function(constraints,onSuccess,onError){var self=this;constraints=this.createModernConstraints(constraints);promisifyCreate(this.pc.createAnswer,this.pc)(constraints).then(function(sd){return self.pc&&promisifySet(self.pc.setLocalDescription,self.pc)(new RTCSessionDescription(sd))}).then(onSuccess,onError)};RTCPC.prototype.processSDP=function(sdp,constraints,onSuccess,onError){var self=this;var desc=new RTCSessionDescription({sdp:sdp,type:"offer"});promisifySet(this.pc.setRemoteDescription,this.pc)(desc).then(function(){self.createAnswer(constraints,onSuccess,onError)})};RTCPC.prototype.getSDP=function(){return this.pc.localDescription.sdp};RTCPC.prototype.processAnswer=function(sdp,onSuccess,onError){if(!this.pc){return}promisifySet(this.pc.setRemoteDescription,this.pc)(new RTCSessionDescription({sdp:sdp,type:"answer"})).then(onSuccess,onError)};RTCPC.test=function(){if(typeof navigator==="object"){var getUserMedia=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.getUserMedia;if(getUserMedia&&typeof window.RTCPeerConnection==="function"){return true}else if(getUserMedia&&typeof window.webkitRTCPeerConnection==="function"){return true}else if(getUserMedia&&typeof window.mozRTCPeerConnection==="function"){try{var test_1=new window.mozRTCPeerConnection;if(typeof test_1.getLocalStreams!=="function")return false}catch(e){return false}return true}else if(typeof RTCIceGatherer!=="undefined"){return true}}return false};function promisify(fn,ctx,areCallbacksFirst){return function(){var args=Array.prototype.slice.call(arguments);return new Promise(function(resolve){resolve(fn.apply(ctx,args))}).catch(function(){return new Promise(function(resolve,reject){fn.apply(ctx,areCallbacksFirst?[resolve,reject].concat(args):args.concat([resolve,reject]))})})}}function promisifyCreate(fn,ctx){return promisify(fn,ctx,true)}function promisifySet(fn,ctx){return promisify(fn,ctx,false)}module.exports=RTCPC}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"../util":28,"rtcpeerconnection-shim":51}],20:[function(require,module,exports){var MockRTCStatsReport=require("./mockrtcstatsreport");var ERROR_PEER_CONNECTION_NULL="PeerConnection is null";var ERROR_WEB_RTC_UNSUPPORTED="WebRTC statistics are unsupported";var SIGNED_SHORT=32767;var isChrome=false;if(typeof window!=="undefined"){var isCriOS=!!window.navigator.userAgent.match("CriOS");var isElectron=!!window.navigator.userAgent.match("Electron");var isGoogle=typeof window.chrome!=="undefined"&&window.navigator.vendor==="Google Inc."&&window.navigator.userAgent.indexOf("OPR")===-1&&window.navigator.userAgent.indexOf("Edge")===-1;isChrome=isCriOS||isElectron||isGoogle}function getStatistics(peerConnection,options){options=Object.assign({createRTCSample:createRTCSample},options);if(!peerConnection){return Promise.reject(new Error(ERROR_PEER_CONNECTION_NULL))}if(typeof peerConnection.getStats!=="function"){return Promise.reject(new Error(ERROR_WEB_RTC_UNSUPPORTED))}if(isChrome){return new Promise(function(resolve,reject){return peerConnection.getStats(resolve,reject)}).then(MockRTCStatsReport.fromRTCStatsResponse).then(options.createRTCSample)}var promise;try{promise=peerConnection.getStats()}catch(e){promise=new Promise(function(resolve,reject){return peerConnection.getStats(resolve,reject)}).then(MockRTCStatsReport.fromRTCStatsResponse)}return promise.then(options.createRTCSample)}function RTCSample(){}function createRTCSample(statsReport){var activeTransportId=null;var sample=new RTCSample;var fallbackTimestamp;Array.from(statsReport.values()).forEach(function(stats){var type=stats.type.replace("-","");fallbackTimestamp=fallbackTimestamp||stats.timestamp;switch(type){case"inboundrtp":sample.timestamp=sample.timestamp||stats.timestamp;sample.jitter=stats.jitter*1e3;sample.packetsLost=stats.packetsLost;sample.packetsReceived=stats.packetsReceived;sample.bytesReceived=stats.bytesReceived;var inboundTrack=statsReport.get(stats.trackId);if(inboundTrack){sample.audioOutputLevel=inboundTrack.audioLevel*SIGNED_SHORT}break;case"outboundrtp":sample.timestamp=stats.timestamp;sample.packetsSent=stats.packetsSent;sample.bytesSent=stats.bytesSent;if(stats.codecId&&statsReport.get(stats.codecId)){var mimeType=statsReport.get(stats.codecId).mimeType;sample.codecName=mimeType&&mimeType.match(/(.*\/)?(.*)/)[2]}var outboundTrack=statsReport.get(stats.trackId);if(outboundTrack){sample.audioInputLevel=outboundTrack.audioLevel*SIGNED_SHORT}break;case"transport":if(stats.dtlsState==="connected"){activeTransportId=stats.id}break}});if(!sample.timestamp){sample.timestamp=fallbackTimestamp}var activeTransport=statsReport.get(activeTransportId);if(!activeTransport){return sample}var selectedCandidatePair=statsReport.get(activeTransport.selectedCandidatePairId);if(!selectedCandidatePair){return sample}var localCandidate=statsReport.get(selectedCandidatePair.localCandidateId);var remoteCandidate=statsReport.get(selectedCandidatePair.remoteCandidateId);Object.assign(sample,{localAddress:localCandidate&&localCandidate.ip,remoteAddress:remoteCandidate&&remoteCandidate.ip,rtt:selectedCandidatePair&&selectedCandidatePair.currentRoundTripTime*1e3});return sample}module.exports=getStatistics},{"./mockrtcstatsreport":15}],21:[function(require,module,exports){var EventEmitter=require("events").EventEmitter;function EventTarget(){Object.defineProperties(this,{_eventEmitter:{value:new EventEmitter},_handlers:{value:{}}})}EventTarget.prototype.dispatchEvent=function dispatchEvent(event){return this._eventEmitter.emit(event.type,event)};EventTarget.prototype.addEventListener=function addEventListener(){return(_a=this._eventEmitter).addListener.apply(_a,arguments);var _a};EventTarget.prototype.removeEventListener=function removeEventListener(){return(_a=this._eventEmitter).removeListener.apply(_a,arguments);var _a};EventTarget.prototype._defineEventHandler=function _defineEventHandler(eventName){var self=this;Object.defineProperty(this,"on"+eventName,{get:function(){return self._handlers[eventName]},set:function(newHandler){var oldHandler=self._handlers[eventName];if(oldHandler&&(typeof newHandler==="function"||typeof newHandler==="undefined"||newHandler===null)){self._handlers[eventName]=null;self.removeEventListener(eventName,oldHandler)}if(typeof newHandler==="function"){self._handlers[eventName]=newHandler;self.addEventListener(eventName,newHandler)}}})};module.exports=EventTarget},{events:43}],22:[function(require,module,exports){function MediaDeviceInfoShim(options){Object.defineProperties(this,{deviceId:{get:function(){return options.deviceId}},groupId:{get:function(){return options.groupId}},kind:{get:function(){return options.kind}},label:{get:function(){return options.label}}})}module.exports=MediaDeviceInfoShim},{}],23:[function(require,module,exports){var EventTarget=require("./eventtarget");var inherits=require("util").inherits;var POLL_INTERVAL_MS=500;var nativeMediaDevices=typeof navigator!=="undefined"&&navigator.mediaDevices;function MediaDevicesShim(){EventTarget.call(this);this._defineEventHandler("devicechange");this._defineEventHandler("deviceinfochange");var knownDevices=[];Object.defineProperties(this,{_deviceChangeIsNative:{value:reemitNativeEvent(this,"devicechange")},_deviceInfoChangeIsNative:{value:reemitNativeEvent(this,"deviceinfochange")},_knownDevices:{value:knownDevices},_pollInterval:{value:null,writable:true}});if(typeof nativeMediaDevices.enumerateDevices==="function"){nativeMediaDevices.enumerateDevices().then(function(devices){devices.sort(sortDevicesById).forEach([].push,knownDevices)})}this._eventEmitter.on("newListener",function maybeStartPolling(eventName){if(eventName!=="devicechange"&&eventName!=="deviceinfochange"){return}this._pollInterval=this._pollInterval||setInterval(sampleDevices.bind(null,this),POLL_INTERVAL_MS)}.bind(this));this._eventEmitter.on("removeListener",function maybeStopPolling(){if(this._pollInterval&&!hasChangeListeners(this)){clearInterval(this._pollInterval);this._pollInterval=null}}.bind(this))}inherits(MediaDevicesShim,EventTarget);if(nativeMediaDevices&&typeof nativeMediaDevices.enumerateDevices==="function"){MediaDevicesShim.prototype.enumerateDevices=function enumerateDevices(){return nativeMediaDevices.enumerateDevices.apply(nativeMediaDevices,arguments)}}MediaDevicesShim.prototype.getUserMedia=function getUserMedia(){return nativeMediaDevices.getUserMedia.apply(nativeMediaDevices,arguments)};function deviceInfosHaveChanged(newDevices,oldDevices){var oldLabels=oldDevices.reduce(function(map,device){return map.set(device.deviceId,device.label||null)},new Map);return newDevices.some(function(newDevice){var oldLabel=oldLabels.get(newDevice.deviceId);return typeof oldLabel!=="undefined"&&oldLabel!==newDevice.label})}function devicesHaveChanged(newDevices,oldDevices){return newDevices.length!==oldDevices.length||propertyHasChanged("deviceId",newDevices,oldDevices)}function hasChangeListeners(mediaDevices){return["devicechange","deviceinfochange"].reduce(function(count,event){return count+mediaDevices._eventEmitter.listenerCount(event)},0)>0}function sampleDevices(mediaDevices){nativeMediaDevices.enumerateDevices().then(function(newDevices){var knownDevices=mediaDevices._knownDevices;var oldDevices=knownDevices.slice();[].splice.apply(knownDevices,[0,knownDevices.length].concat(newDevices.sort(sortDevicesById)));if(!mediaDevices._deviceChangeIsNative&&devicesHaveChanged(knownDevices,oldDevices)){mediaDevices.dispatchEvent(new Event("devicechange"))}if(!mediaDevices._deviceInfoChangeIsNative&&deviceInfosHaveChanged(knownDevices,oldDevices)){mediaDevices.dispatchEvent(new Event("deviceinfochange"))}})}function propertyHasChanged(propertyName,as,bs){return as.some(function(a,i){return a[propertyName]!==bs[i][propertyName]})}function reemitNativeEvent(mediaDevices,eventName){var methodName="on"+eventName;function dispatchEvent(event){mediaDevices.dispatchEvent(event)}if(methodName in nativeMediaDevices){if("addEventListener"in nativeMediaDevices){nativeMediaDevices.addEventListener(eventName,dispatchEvent)}else{nativeMediaDevices[methodName]=dispatchEvent}return true}return false}function sortDevicesById(a,b){return a.deviceId<b.deviceId}module.exports=function shimMediaDevices(){return nativeMediaDevices?new MediaDevicesShim:null}()},{"./eventtarget":21,util:55}],24:[function(require,module,exports){var AudioPlayer=require("AudioPlayer");function Sound(name,url,options){if(!(this instanceof Sound)){return new Sound(name,url,options)}if(!name||!url){throw new Error("name and url are required arguments")}options=Object.assign({AudioFactory:typeof Audio!=="undefined"?Audio:null,maxDuration:0,shouldLoop:false},options);options.AudioPlayer=options.audioContext?AudioPlayer.bind(AudioPlayer,options.audioContext):options.AudioFactory;Object.defineProperties(this,{_activeEls:{value:new Set},_Audio:{value:options.AudioPlayer},_isSinkSupported:{value:options.AudioFactory!==null&&typeof options.AudioFactory.prototype.setSinkId==="function"},_maxDuration:{value:options.maxDuration},_maxDurationTimeout:{value:null,writable:true},_playPromise:{value:null,writable:true},_shouldLoop:{value:options.shouldLoop},_sinkIds:{value:["default"]},isPlaying:{enumerable:true,get:function(){return!!this._playPromise}},name:{enumerable:true,value:name},url:{enumerable:true,value:url}});if(this._Audio){preload(this._Audio,url)}}function preload(AudioFactory,url){var el=new AudioFactory(url);el.preload="auto";el.muted=true;el.play()}Sound.prototype.setSinkIds=function setSinkIds(ids){if(!this._isSinkSupported){return}ids=ids.forEach?ids:[ids];[].splice.apply(this._sinkIds,[0,this._sinkIds.length].concat(ids))};Sound.prototype.stop=function stop(){this._activeEls.forEach(function(audioEl){audioEl.pause();audioEl.src="";audioEl.load()});this._activeEls.clear();clearTimeout(this._maxDurationTimeout);this._playPromise=null;this._maxDurationTimeout=null};Sound.prototype.play=function play(){if(this.isPlaying){this.stop()}if(this._maxDuration>0){this._maxDurationTimeout=setTimeout(this.stop.bind(this),this._maxDuration)}var self=this;var playPromise=this._playPromise=Promise.all(this._sinkIds.map(function createAudioElement(sinkId){if(!self._Audio){return Promise.resolve()}var audioElement=new self._Audio(self.url);audioElement.loop=self._shouldLoop;audioElement.addEventListener("ended",function(){self._activeEls.delete(audioElement)});return new Promise(function(resolve){audioElement.addEventListener("canplaythrough",resolve)}).then(function(){if(!self.isPlaying||self._playPromise!==playPromise){return Promise.resolve()}return(self._isSinkSupported?audioElement.setSinkId(sinkId):Promise.resolve()).then(function setSinkIdSuccess(){self._activeEls.add(audioElement);return audioElement.play()}).then(function playSuccess(){return audioElement},function playFailure(reason){self._activeEls.delete(audioElement);throw reason})})}));return playPromise};module.exports=Sound},{AudioPlayer:33}],25:[function(require,module,exports){var inherits=require("util").inherits;function StateMachine(states,initialState){if(!(this instanceof StateMachine)){return new StateMachine(states,initialState)}var currentState=initialState;Object.defineProperties(this,{_currentState:{get:function(){return currentState},set:function(_currentState){currentState=_currentState}},currentState:{enumerable:true,get:function(){return currentState}},states:{enumerable:true,value:states},transitions:{enumerable:true,value:[]}});Object.freeze(this)}StateMachine.prototype.transition=function transition(to){var from=this.currentState;var valid=this.states[from];var newTransition=valid&&valid.indexOf(to)!==-1?new StateTransition(from,to):new InvalidStateTransition(from,to);this.transitions.push(newTransition);this._currentState=to;if(newTransition instanceof InvalidStateTransition){throw newTransition}return this};function StateTransition(from,to){Object.defineProperties(this,{from:{enumerable:true,value:from},to:{enumerable:true,value:to}})}function InvalidStateTransition(from,to){if(!(this instanceof InvalidStateTransition)){return new InvalidStateTransition(from,to)}Error.call(this);StateTransition.call(this,from,to);var errorMessage="Invalid transition from "+(typeof from==="string"?'"'+from+'"':"null")+' to "'+to+'"';Object.defineProperties(this,{message:{enumerable:true,value:errorMessage}});Object.freeze(this)}inherits(InvalidStateTransition,Error);module.exports=StateMachine},{util:55}],26:[function(require,module,exports){exports.SOUNDS_DEPRECATION_WARNING="Device.sounds is deprecated and will be removed in the next breaking "+"release. Please use the new functionality available on Device.audio.";function generateEventWarning(event,name,maxListeners){return"The number of "+event+" listeners on "+name+" exceeds the recommended number of "+maxListeners+". While twilio.js will continue to function normally, this may be indicative of an application error. Note that "+event+" listeners exist for the lifetime of the "+name+"."}exports.generateEventWarning=generateEventWarning},{}],27:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var LogLevel;(function(LogLevel){LogLevel["Off"]="off";LogLevel["Debug"]="debug";LogLevel["Info"]="info";LogLevel["Warn"]="warn";LogLevel["Error"]="error"})(LogLevel=exports.LogLevel||(exports.LogLevel={}));var logLevelMethods=(_a={},_a[LogLevel.Debug]="info",_a[LogLevel.Info]="info",_a[LogLevel.Warn]="warn",_a[LogLevel.Error]="error",_a);var logLevelRanks=(_b={},_b[LogLevel.Debug]=0,_b[LogLevel.Info]=1,_b[LogLevel.Warn]=2,_b[LogLevel.Error]=3,_b[LogLevel.Off]=4,_b);var Log=function(){function Log(_logLevel,options){this._logLevel=_logLevel;this._console=console;if(options&&options.console){this._console=options.console}}Object.defineProperty(Log.prototype,"logLevel",{get:function(){return this._logLevel},enumerable:true,configurable:true});Log.prototype.debug=function(){var args=[];for(var _i=0;_i<arguments.length;_i++){args[_i]=arguments[_i]}this.log.apply(this,[LogLevel.Debug].concat(args))};Log.prototype.error=function(){var args=[];for(var _i=0;_i<arguments.length;_i++){args[_i]=arguments[_i]}this.log.apply(this,[LogLevel.Error].concat(args))};Log.prototype.info=function(){var args=[];for(var _i=0;_i<arguments.length;_i++){args[_i]=arguments[_i]}this.log.apply(this,[LogLevel.Info].concat(args))};Log.prototype.log=function(logLevel){var args=[];for(var _i=1;_i<arguments.length;_i++){args[_i-1]=arguments[_i]}var methodName=logLevelMethods[logLevel];if(methodName&&logLevelRanks[this.logLevel]<=logLevelRanks[logLevel]){(_a=this._console)[methodName].apply(_a,args)}var _a};Log.prototype.setLogLevel=function(logLevel){this._logLevel=logLevel};Log.prototype.warn=function(){var args=[];for(var _i=0;_i<arguments.length;_i++){args[_i]=arguments[_i]}this.log.apply(this,[LogLevel.Warn].concat(args))};return Log}();exports.default=Log;var _a,_b},{}],28:[function(require,module,exports){(function(global,Buffer){var EventEmitter=require("events").EventEmitter;var generateEventWarning=require("./strings").generateEventWarning;var pkg=require("../../package.json");function getReleaseVersion(){return pkg.version}function getSoundVersion(){return"1.0.0"}function getTwilioRoot(){return"https://media.twiliocdn.com/sdk/js/client/"}function TwilioException(message){if(!(this instanceof TwilioException)){return new TwilioException(message)}this.message=message}TwilioException.prototype.toString=function(){return"Twilio.Exception: "+this.message};function memoize(fn){return function(){var args=Array.prototype.slice.call(arguments,0);fn.memo=fn.memo||{};if(!fn.memo[args]){fn.memo[args]=fn.apply(void 0,args)}return fn.memo[args]}}function decodePayload(encodedPayload){var remainder=encodedPayload.length%4;if(remainder>0){var padlen=4-remainder;encodedPayload+=new Array(padlen+1).join("=")}encodedPayload=encodedPayload.replace(/-/g,"+").replace(/_/g,"/");var decodedPayload=_atob(encodedPayload);return JSON.parse(decodedPayload)}var memoizedDecodePayload=memoize(decodePayload);function decode(token){var segs=token.split(".");if(segs.length!==3){throw new TwilioException("Wrong number of segments")}var encodedPayload=segs[1];var payload=memoizedDecodePayload(encodedPayload);return payload}function makedict(params){if(params==="")return{};if(params.indexOf("&")===-1&&params.indexOf("=")===-1)return params;var pairs=params.split("&");var result={};for(var i=0;i<pairs.length;i++){var pair=pairs[i].split("=");result[decodeURIComponent(pair[0])]=makedict(decodeURIComponent(pair[1]))}return result}function makescope(uri){var parts=uri.match(/^scope:(\w+):(\w+)\??(.*)$/);if(!(parts&&parts.length===4)){throw new TwilioException("Bad scope URI")}return{service:parts[1],privilege:parts[2],params:makedict(parts[3])}}function urlencode(paramsDict,doseq){var parts=[];var value;doseq=doseq||false;for(var key in paramsDict){if(doseq&&paramsDict[key]instanceof Array){for(var index in paramsDict[key]){value=paramsDict[key][index];parts.push(encodeURIComponent(key)+"="+encodeURIComponent(value))}}else{value=paramsDict[key];parts.push(encodeURIComponent(key)+"="+encodeURIComponent(value))}}return parts.join("&")}function objectize(token){var jwt=decode(token);var scopes=jwt.scope.length===0?[]:jwt.scope.split(" ");var newscopes={};for(var i=0;i<scopes.length;i++){var scope=makescope(scopes[i]);newscopes[scope.service+":"+scope.privilege]=scope}jwt.scope=newscopes;return jwt}var memoizedObjectize=memoize(objectize);function _btoa(message){try{return btoa(message)}catch(e){return new Buffer(message).toString("base64")}}function _atob(encoded){try{return atob(encoded)}catch(e){try{return new Buffer(encoded,"base64").toString("ascii")}catch(e2){return base64.decode(encoded)}}}function dummyToken(payload){var tokenDefaults={iss:"AC1111111111111111111111111111111",exp:14e8};for(var k in tokenDefaults){payload[k]=payload[k]||tokenDefaults[k]}var encodedPayload=_btoa(JSON.stringify(payload));encodedPayload=encodedPayload.replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_");return["*",encodedPayload,"*"].join(".")}function bind(fn,ctx){var applied=Array.prototype.slice.call(arguments,2);return function(){var args=[];for(var _i=0;_i<arguments.length;_i++){args[_i]=arguments[_i]}var extra=Array.prototype.slice.call(args);return fn.apply(ctx,applied.concat(extra))}}function getSystemInfo(){var nav=typeof navigator!=="undefined"?navigator:{};var info={p:"browser",v:getReleaseVersion(),browser:{userAgent:nav.userAgent||"unknown",platform:nav.platform||"unknown"},plugin:"rtc"};return info}function trim(str){if(typeof str!=="string")return"";return str.trim?str.trim():str.replace(/^\s+|\s+$/g,"")}function splitObjects(json){var trimmed=trim(json);return trimmed.length===0?[]:trimmed.split("\n")}function generateConnectionUUID(){return"TJSxxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=Math.random()*16|0;var v=c==="x"?r:r&3|8;return v.toString(16)})}function monitorEventEmitter(name,object){object.setMaxListeners(0);var MAX_LISTENERS=10;function monitor(event){var n=EventEmitter.listenerCount(object,event);var warning=generateEventWarning(event,name,MAX_LISTENERS);if(n>=MAX_LISTENERS){if(typeof console!=="undefined"){if(console.warn){console.warn(warning)}else if(console.log){console.log(warning)}}object.removeListener("newListener",monitor)}}object.on("newListener",monitor)}function deepEqual(a,b){if(a===b){return true}else if(typeof a!==typeof b){return false}else if(a instanceof Date&&b instanceof Date){return a.getTime()===b.getTime()}else if(typeof a!=="object"&&typeof b!=="object"){return a===b}return objectDeepEqual(a,b)}var objectKeys=typeof Object.keys==="function"?Object.keys:function(obj){var keys=[];for(var key in obj){keys.push(key)}return keys};function isUndefinedOrNull(a){return typeof a==="undefined"||a===null}function objectDeepEqual(a,b){if(isUndefinedOrNull(a)||isUndefinedOrNull(b)){return false}else if(a.prototype!==b.prototype){return false}var ka;var kb;try{ka=objectKeys(a);kb=objectKeys(b)}catch(e){return false}if(ka.length!==kb.length){return false}ka.sort();kb.sort();for(var i=ka.length-1;i>=0;i--){var k=ka[i];if(!deepEqual(a[k],b[k])){return false}}return true}function average(values){return values.reduce(function(t,v){return t+v})/values.length}function difference(lefts,rights,getKey){getKey=getKey||function(a){return a};var rightKeys=new Set(rights.map(getKey));return lefts.filter(function(left){return!rightKeys.has(getKey(left))})}function encodescope(service,privilege,params){var capability=["scope",service,privilege].join(":");var empty=true;for(var _ in params){void _;empty=false;break}return empty?capability:capability+"?"+buildquery(params)}function buildquery(params){var pairs=[];for(var name_1 in params){var value=typeof params[name_1]==="object"?buildquery(params[name_1]):params[name_1];pairs.push(encodeURIComponent(name_1)+"="+encodeURIComponent(value))}}function isFirefox(navigator){navigator=navigator||(typeof window==="undefined"?global.navigator:window.navigator);return navigator&&typeof navigator.userAgent==="string"&&/firefox|fxios/i.test(navigator.userAgent)}function isEdge(navigator){navigator=navigator||(typeof window==="undefined"?global.navigator:window.navigator);return navigator&&typeof navigator.userAgent==="string"&&/edge\/\d+/i.test(navigator.userAgent)}exports.getReleaseVersion=getReleaseVersion;exports.getSoundVersion=getSoundVersion;exports.dummyToken=dummyToken;exports.Exception=TwilioException;exports.decode=decode;exports.btoa=_btoa;exports.atob=_atob;exports.objectize=memoizedObjectize;exports.urlencode=urlencode;exports.encodescope=encodescope;exports.Set=Set;exports.bind=bind;exports.getSystemInfo=getSystemInfo;exports.splitObjects=splitObjects;exports.generateConnectionUUID=generateConnectionUUID;exports.getTwilioRoot=getTwilioRoot;exports.monitorEventEmitter=monitorEventEmitter;exports.deepEqual=deepEqual;exports.average=average;exports.difference=difference;exports.isFirefox=isFirefox;exports.isEdge=isEdge}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{},require("buffer").Buffer)},{"../../package.json":56,"./strings":26,buffer:42,events:43}],29:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p]};return function(d,b){extendStatics(d,b);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:true});var events_1=require("events");var WebSocket=require("ws");var tslog_1=require("./tslog");var Backoff=require("backoff");var CONNECT_SUCCESS_TIMEOUT=1e4;var CONNECT_TIMEOUT=5e3;var HEARTBEAT_TIMEOUT=15e3;var WSTransportState;(function(WSTransportState){WSTransportState["Connecting"]="connecting";WSTransportState["Closed"]="closed";WSTransportState["Open"]="open"})(WSTransportState=exports.WSTransportState||(exports.WSTransportState={}));var WSTransport=function(_super){__extends(WSTransport,_super);function WSTransport(uri,options){if(options===void 0){options={}}var _this=_super.call(this)||this;_this.state=WSTransportState.Closed;_this._backoff=Backoff.exponential({factor:1.5,initialDelay:30,maxDelay:3e3,randomisationFactor:.25});_this._onSocketClose=function(){_this._closeSocket()};_this._onSocketError=function(err){_this._log.info("WebSocket received error: "+err.message);_this.emit("error",{code:31e3,message:err.message||"WSTransport socket error"})};_this._onSocketMessage=function(message){_this._setHeartbeatTimeout();if(_this._socket&&message.data==="\n"){_this._socket.send("\n");return}_this.emit("message",message)};_this._onSocketOpen=function(){_this._log.info("WebSocket opened successfully.");_this._timeOpened=Date.now();_this.state=WSTransportState.Open;clearTimeout(_this._connectTimeout);_this._setHeartbeatTimeout();_this.emit("open")};_this._log=new tslog_1.default(options.logLevel||tslog_1.LogLevel.Off);_this._uri=uri;_this._WebSocket=options.WebSocket||WebSocket;_this._backoff.on("backoff",function(_,delay){if(_this.state===WSTransportState.Closed){return}_this._log.info("Will attempt to reconnect WebSocket in "+delay+"ms")});_this._backoff.on("ready",function(attempt){if(_this.state===WSTransportState.Closed){return}_this._connect(attempt+1)});return _this}WSTransport.prototype.close=function(){this._log.info("WSTransport.close() called...");this._close()};WSTransport.prototype.open=function(){this._log.info("WSTransport.open() called...");if(this._socket&&(this._socket.readyState===WebSocket.CONNECTING||this._socket.readyState===WebSocket.OPEN)){this._log.info("WebSocket already open.");return}this._connect()};WSTransport.prototype.send=function(message){if(!this._socket||this._socket.readyState!==WebSocket.OPEN){return false}try{this._socket.send(message)}catch(e){this._log.info("Error while sending message:",e.message);this._closeSocket();return false}return true};WSTransport.prototype._close=function(){this.state=WSTransportState.Closed;this._closeSocket()};WSTransport.prototype._closeSocket=function(){clearTimeout(this._connectTimeout);clearTimeout(this._heartbeatTimeout);this._log.info("Closing and cleaning up WebSocket...");if(!this._socket){this._log.info("No WebSocket to clean up.");return}this._socket.removeEventListener("close",this._onSocketClose);this._socket.removeEventListener("error",this._onSocketError);this._socket.removeEventListener("message",this._onSocketMessage);this._socket.removeEventListener("open",this._onSocketOpen);if(this._socket.readyState===WebSocket.CONNECTING||this._socket.readyState===WebSocket.OPEN){this._socket.close()}if(this._timeOpened&&Date.now()-this._timeOpened>CONNECT_SUCCESS_TIMEOUT){this._backoff.reset()}this._backoff.backoff();delete this._socket;this.emit("close")};WSTransport.prototype._connect=function(retryCount){var _this=this;if(retryCount){this._log.info("Attempting to reconnect (retry #"+retryCount+")...")}else{this._log.info("Attempting to connect...")}this._closeSocket();this.state=WSTransportState.Connecting;var socket=null;try{socket=new this._WebSocket(this._uri)}catch(e){this._log.info("Could not connect to endpoint:",e.message);this._close();this.emit("error",{code:31e3,message:e.message||"Could not connect to "+this._uri});return}delete this._timeOpened;this._connectTimeout=setTimeout(function(){_this._log.info("WebSocket connection attempt timed out.");_this._closeSocket()},CONNECT_TIMEOUT);socket.addEventListener("close",this._onSocketClose);socket.addEventListener("error",this._onSocketError);socket.addEventListener("message",this._onSocketMessage);socket.addEventListener("open",this._onSocketOpen);this._socket=socket};WSTransport.prototype._setHeartbeatTimeout=function(){var _this=this;clearTimeout(this._heartbeatTimeout);this._heartbeatTimeout=setTimeout(function(){_this._log.info("No messages received in "+HEARTBEAT_TIMEOUT/1e3+" seconds. Reconnecting...");_this._closeSocket()},HEARTBEAT_TIMEOUT)};return WSTransport}(events_1.EventEmitter);exports.default=WSTransport},{"./tslog":27,backoff:35,events:43,ws:1}],30:[function(require,module,exports){"use strict";var _regenerator=require("babel-runtime/regenerator");var _regenerator2=_interopRequireDefault(_regenerator);var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return call&&(typeof call==="object"||typeof call==="function")?call:self}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}var __awaiter=undefined&&undefined.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator["throw"](value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})};Object.defineProperty(exports,"__esModule",{value:true});var Deferred_1=require("./Deferred");var EventTarget_1=require("./EventTarget");var AudioPlayer=function(_EventTarget_1$defaul){_inherits(AudioPlayer,_EventTarget_1$defaul);function AudioPlayer(audioContext){var srcOrOptions=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var options=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};_classCallCheck(this,AudioPlayer);var _this=_possibleConstructorReturn(this,(AudioPlayer.__proto__||Object.getPrototypeOf(AudioPlayer)).call(this));_this._audioNode=null;_this._pendingPlayDeferreds=[];_this._loop=false;_this._src="";_this._sinkId="default";if(typeof srcOrOptions!=="string"){options=srcOrOptions}_this._audioContext=audioContext;_this._audioElement=new(options.AudioFactory||Audio);_this._bufferPromise=_this._createPlayDeferred().promise;_this._destination=_this._audioContext.destination;_this._gainNode=_this._audioContext.createGain();_this._gainNode.connect(_this._destination);_this._XMLHttpRequest=options.XMLHttpRequestFactory||XMLHttpRequest;_this.addEventListener("canplaythrough",function(){_this._resolvePlayDeferreds()});if(typeof srcOrOptions==="string"){_this.src=srcOrOptions}return _this}_createClass(AudioPlayer,[{key:"load",value:function load(){this._load(this._src)}},{key:"pause",value:function pause(){if(this.paused){return}this._audioElement.pause();this._audioNode.stop();this._audioNode.disconnect(this._gainNode);this._audioNode=null;this._rejectPlayDeferreds(new Error("The play() request was interrupted by a call to pause()."))}},{key:"play",value:function play(){return __awaiter(this,void 0,void 0,_regenerator2.default.mark(function _callee(){var _this2=this;var buffer;return _regenerator2.default.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(this.paused){_context.next=6;break}_context.next=3;return this._bufferPromise;case 3:if(this.paused){_context.next=5;break}return _context.abrupt("return");case 5:throw new Error("The play() request was interrupted by a call to pause().");case 6:this._audioNode=this._audioContext.createBufferSource();this._audioNode.loop=this.loop;this._audioNode.addEventListener("ended",function(){if(_this2._audioNode&&_this2._audioNode.loop){return}_this2.dispatchEvent("ended")});_context.next=11;return this._bufferPromise;case 11:buffer=_context.sent;if(!this.paused){_context.next=14;break}throw new Error("The play() request was interrupted by a call to pause().");case 14:this._audioNode.buffer=buffer;this._audioNode.connect(this._gainNode);this._audioNode.start();if(!this._audioElement.srcObject){_context.next=19;break}return _context.abrupt("return",this._audioElement.play());case 19:case"end":return _context.stop()}}},_callee,this)}))}},{key:"setSinkId",value:function setSinkId(sinkId){return __awaiter(this,void 0,void 0,_regenerator2.default.mark(function _callee2(){return _regenerator2.default.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:if(!(typeof this._audioElement.setSinkId!=="function")){_context2.next=2;break}throw new Error("This browser does not support setSinkId.");case 2:if(!(sinkId===this.sinkId)){_context2.next=4;break}return _context2.abrupt("return");case 4:if(!(sinkId==="default")){_context2.next=11;break}if(!this.paused){this._gainNode.disconnect(this._destination)}this._audioElement.srcObject=null;this._destination=this._audioContext.destination;this._gainNode.connect(this._destination);this._sinkId=sinkId;return _context2.abrupt("return");case 11:_context2.next=13;return this._audioElement.setSinkId(sinkId);case 13:if(!this._audioElement.srcObject){_context2.next=15;break}return _context2.abrupt("return");case 15:this._gainNode.disconnect(this._audioContext.destination);this._destination=this._audioContext.createMediaStreamDestination();this._audioElement.srcObject=this._destination.stream;this._sinkId=sinkId;this._gainNode.connect(this._destination);case 20:case"end":return _context2.stop()}}},_callee2,this)}))}},{key:"_createPlayDeferred",value:function _createPlayDeferred(){var deferred=new Deferred_1.default;this._pendingPlayDeferreds.push(deferred);return deferred}},{key:"_load",value:function _load(src){var _this3=this;if(this._src&&this._src!==src){this.pause()}this._src=src;this._bufferPromise=new Promise(function(resolve,reject){return __awaiter(_this3,void 0,void 0,_regenerator2.default.mark(function _callee3(){var buffer;return _regenerator2.default.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:if(src){_context3.next=2;break}return _context3.abrupt("return",this._createPlayDeferred().promise);case 2:_context3.next=4;return bufferSound(this._audioContext,this._XMLHttpRequest,src);case 4:buffer=_context3.sent;this.dispatchEvent("canplaythrough");resolve(buffer);case 7:case"end":return _context3.stop()}}},_callee3,this)}))})}},{key:"_rejectPlayDeferreds",value:function _rejectPlayDeferreds(reason){var deferreds=this._pendingPlayDeferreds;deferreds.splice(0,deferreds.length).forEach(function(_ref){var reject=_ref.reject;return reject(reason)})}},{key:"_resolvePlayDeferreds",value:function _resolvePlayDeferreds(result){var deferreds=this._pendingPlayDeferreds;deferreds.splice(0,deferreds.length).forEach(function(_ref2){var resolve=_ref2.resolve;return resolve(result)})}},{key:"destination",get:function get(){return this._destination}},{key:"loop",get:function get(){return this._loop},set:function set(shouldLoop){if(!shouldLoop&&this.loop&&!this.paused){var _pauseAfterPlaythrough=function _pauseAfterPlaythrough(){self._audioNode.removeEventListener("ended",_pauseAfterPlaythrough);self.pause()};var self=this;this._audioNode.addEventListener("ended",_pauseAfterPlaythrough)}this._loop=shouldLoop}},{key:"muted",get:function get(){return this._gainNode.gain.value===0},set:function set(shouldBeMuted){this._gainNode.gain.value=shouldBeMuted?0:1}},{key:"paused",get:function get(){return this._audioNode===null}},{key:"src",get:function get(){return this._src},set:function set(src){this._load(src)}},{key:"sinkId",get:function get(){return this._sinkId}}]);return AudioPlayer}(EventTarget_1.default);exports.default=AudioPlayer;function bufferSound(context,RequestFactory,src){return __awaiter(this,void 0,void 0,_regenerator2.default.mark(function _callee4(){var request,event;return _regenerator2.default.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:request=new RequestFactory;request.open("GET",src,true);request.responseType="arraybuffer";_context4.next=5;return new Promise(function(resolve){request.addEventListener("load",resolve);request.send()});case 5:event=_context4.sent;_context4.prev=6;return _context4.abrupt("return",context.decodeAudioData(event.target.response));case 10:_context4.prev=10;_context4.t0=_context4["catch"](6);return _context4.abrupt("return",new Promise(function(resolve){context.decodeAudioData(event.target.response,resolve)}));case 13:case"end":return _context4.stop()}}},_callee4,this,[[6,10]])}))}},{"./Deferred":31,"./EventTarget":32,"babel-runtime/regenerator":34}],31:[function(require,module,exports){"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}Object.defineProperty(exports,"__esModule",{value:true});var Deferred=function(){function Deferred(){var _this=this;_classCallCheck(this,Deferred);this.promise=new Promise(function(resolve,reject){_this._resolve=resolve;_this._reject=reject})}_createClass(Deferred,[{key:"reject",get:function get(){return this._reject}},{key:"resolve",get:function get(){return this._resolve}}]);return Deferred}();exports.default=Deferred},{}],32:[function(require,module,exports){"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}Object.defineProperty(exports,"__esModule",{value:true});var events_1=require("events");var EventTarget=function(){function EventTarget(){_classCallCheck(this,EventTarget);this._eventEmitter=new events_1.EventEmitter}_createClass(EventTarget,[{key:"addEventListener",value:function addEventListener(name,handler){return this._eventEmitter.addListener(name,handler)}},{key:"dispatchEvent",value:function dispatchEvent(name){var _eventEmitter;for(var _len=arguments.length,args=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){args[_key-1]=arguments[_key]}return(_eventEmitter=this._eventEmitter).emit.apply(_eventEmitter,[name].concat(args))}},{key:"removeEventListener",value:function removeEventListener(name,handler){return this._eventEmitter.removeListener(name,handler)}}]);return EventTarget}();exports.default=EventTarget},{events:43}],33:[function(require,module,exports){"use strict";var AudioPlayer=require("./AudioPlayer");module.exports=AudioPlayer.default},{"./AudioPlayer":30}],34:[function(require,module,exports){module.exports=require("regenerator-runtime")},{"regenerator-runtime":49}],35:[function(require,module,exports){var Backoff=require("./lib/backoff");var ExponentialBackoffStrategy=require("./lib/strategy/exponential");var FibonacciBackoffStrategy=require("./lib/strategy/fibonacci");var FunctionCall=require("./lib/function_call.js");module.exports.Backoff=Backoff;module.exports.FunctionCall=FunctionCall;module.exports.FibonacciStrategy=FibonacciBackoffStrategy;module.exports.ExponentialStrategy=ExponentialBackoffStrategy;module.exports.fibonacci=function(options){return new Backoff(new FibonacciBackoffStrategy(options))};module.exports.exponential=function(options){return new Backoff(new ExponentialBackoffStrategy(options))};module.exports.call=function(fn,vargs,callback){var args=Array.prototype.slice.call(arguments);fn=args[0];vargs=args.slice(1,args.length-1);callback=args[args.length-1];return new FunctionCall(fn,vargs,callback)}},{"./lib/backoff":36,"./lib/function_call.js":37,"./lib/strategy/exponential":38,"./lib/strategy/fibonacci":39}],36:[function(require,module,exports){var events=require("events");var precond=require("precond");var util=require("util");function Backoff(backoffStrategy){events.EventEmitter.call(this);this.backoffStrategy_=backoffStrategy;this.maxNumberOfRetry_=-1;this.backoffNumber_=0;this.backoffDelay_=0;this.timeoutID_=-1;this.handlers={backoff:this.onBackoff_.bind(this)}}util.inherits(Backoff,events.EventEmitter);Backoff.prototype.failAfter=function(maxNumberOfRetry){precond.checkArgument(maxNumberOfRetry>0,"Expected a maximum number of retry greater than 0 but got %s.",maxNumberOfRetry);this.maxNumberOfRetry_=maxNumberOfRetry};Backoff.prototype.backoff=function(err){precond.checkState(this.timeoutID_===-1,"Backoff in progress.");if(this.backoffNumber_===this.maxNumberOfRetry_){this.emit("fail",err);this.reset()}else{this.backoffDelay_=this.backoffStrategy_.next();this.timeoutID_=setTimeout(this.handlers.backoff,this.backoffDelay_);this.emit("backoff",this.backoffNumber_,this.backoffDelay_,err)}};Backoff.prototype.onBackoff_=function(){this.timeoutID_=-1;this.emit("ready",this.backoffNumber_,this.backoffDelay_);this.backoffNumber_++};Backoff.prototype.reset=function(){this.backoffNumber_=0;this.backoffStrategy_.reset();clearTimeout(this.timeoutID_);this.timeoutID_=-1};module.exports=Backoff},{events:43,precond:45,util:55}],37:[function(require,module,exports){var events=require("events");var precond=require("precond");var util=require("util");var Backoff=require("./backoff");var FibonacciBackoffStrategy=require("./strategy/fibonacci");function FunctionCall(fn,args,callback){events.EventEmitter.call(this);precond.checkIsFunction(fn,"Expected fn to be a function.");precond.checkIsArray(args,"Expected args to be an array.");precond.checkIsFunction(callback,"Expected callback to be a function.");this.function_=fn;this.arguments_=args;this.callback_=callback;this.lastResult_=[];this.numRetries_=0;this.backoff_=null;this.strategy_=null;this.failAfter_=-1;this.retryPredicate_=FunctionCall.DEFAULT_RETRY_PREDICATE_;this.state_=FunctionCall.State_.PENDING}util.inherits(FunctionCall,events.EventEmitter);FunctionCall.State_={PENDING:0,RUNNING:1,COMPLETED:2,ABORTED:3};FunctionCall.DEFAULT_RETRY_PREDICATE_=function(err){return true};FunctionCall.prototype.isPending=function(){return this.state_==FunctionCall.State_.PENDING};FunctionCall.prototype.isRunning=function(){return this.state_==FunctionCall.State_.RUNNING};FunctionCall.prototype.isCompleted=function(){return this.state_==FunctionCall.State_.COMPLETED};FunctionCall.prototype.isAborted=function(){return this.state_==FunctionCall.State_.ABORTED};FunctionCall.prototype.setStrategy=function(strategy){precond.checkState(this.isPending(),"FunctionCall in progress.");this.strategy_=strategy;return this};FunctionCall.prototype.retryIf=function(retryPredicate){precond.checkState(this.isPending(),"FunctionCall in progress.");this.retryPredicate_=retryPredicate;return this};FunctionCall.prototype.getLastResult=function(){return this.lastResult_.concat()};FunctionCall.prototype.getNumRetries=function(){return this.numRetries_};FunctionCall.prototype.failAfter=function(maxNumberOfRetry){precond.checkState(this.isPending(),"FunctionCall in progress.");this.failAfter_=maxNumberOfRetry;return this};FunctionCall.prototype.abort=function(){if(this.isCompleted()||this.isAborted()){return}if(this.isRunning()){this.backoff_.reset()}this.state_=FunctionCall.State_.ABORTED;this.lastResult_=[new Error("Backoff aborted.")];this.emit("abort");this.doCallback_()};FunctionCall.prototype.start=function(backoffFactory){precond.checkState(!this.isAborted(),"FunctionCall is aborted.");precond.checkState(this.isPending(),"FunctionCall already started.");var strategy=this.strategy_||new FibonacciBackoffStrategy;this.backoff_=backoffFactory?backoffFactory(strategy):new Backoff(strategy);this.backoff_.on("ready",this.doCall_.bind(this,true));this.backoff_.on("fail",this.doCallback_.bind(this));this.backoff_.on("backoff",this.handleBackoff_.bind(this));if(this.failAfter_>0){this.backoff_.failAfter(this.failAfter_)}this.state_=FunctionCall.State_.RUNNING;this.doCall_(false)};FunctionCall.prototype.doCall_=function(isRetry){if(isRetry){this.numRetries_++}var eventArgs=["call"].concat(this.arguments_);events.EventEmitter.prototype.emit.apply(this,eventArgs);var callback=this.handleFunctionCallback_.bind(this);this.function_.apply(null,this.arguments_.concat(callback))};FunctionCall.prototype.doCallback_=function(){this.callback_.apply(null,this.lastResult_)};FunctionCall.prototype.handleFunctionCallback_=function(){if(this.isAborted()){return}var args=Array.prototype.slice.call(arguments);this.lastResult_=args;events.EventEmitter.prototype.emit.apply(this,["callback"].concat(args));var err=args[0];if(err&&this.retryPredicate_(err)){this.backoff_.backoff(err)}else{this.state_=FunctionCall.State_.COMPLETED;this.doCallback_()}};FunctionCall.prototype.handleBackoff_=function(number,delay,err){this.emit("backoff",number,delay,err)};module.exports=FunctionCall},{"./backoff":36,"./strategy/fibonacci":39,events:43,precond:45,util:55}],38:[function(require,module,exports){var util=require("util");var precond=require("precond");var BackoffStrategy=require("./strategy");function ExponentialBackoffStrategy(options){BackoffStrategy.call(this,options);this.backoffDelay_=0;this.nextBackoffDelay_=this.getInitialDelay();this.factor_=ExponentialBackoffStrategy.DEFAULT_FACTOR;if(options&&options.factor!==undefined){precond.checkArgument(options.factor>1,"Exponential factor should be greater than 1 but got %s.",options.factor);this.factor_=options.factor}}util.inherits(ExponentialBackoffStrategy,BackoffStrategy);ExponentialBackoffStrategy.DEFAULT_FACTOR=2;ExponentialBackoffStrategy.prototype.next_=function(){this.backoffDelay_=Math.min(this.nextBackoffDelay_,this.getMaxDelay());this.nextBackoffDelay_=this.backoffDelay_*this.factor_;return this.backoffDelay_};ExponentialBackoffStrategy.prototype.reset_=function(){this.backoffDelay_=0;this.nextBackoffDelay_=this.getInitialDelay()};module.exports=ExponentialBackoffStrategy},{"./strategy":40,precond:45,util:55}],39:[function(require,module,exports){var util=require("util");var BackoffStrategy=require("./strategy");function FibonacciBackoffStrategy(options){BackoffStrategy.call(this,options);this.backoffDelay_=0;this.nextBackoffDelay_=this.getInitialDelay()}util.inherits(FibonacciBackoffStrategy,BackoffStrategy);FibonacciBackoffStrategy.prototype.next_=function(){var backoffDelay=Math.min(this.nextBackoffDelay_,this.getMaxDelay());this.nextBackoffDelay_+=this.backoffDelay_;this.backoffDelay_=backoffDelay;return backoffDelay};FibonacciBackoffStrategy.prototype.reset_=function(){this.nextBackoffDelay_=this.getInitialDelay();this.backoffDelay_=0};module.exports=FibonacciBackoffStrategy},{"./strategy":40,util:55}],40:[function(require,module,exports){var events=require("events");var util=require("util");function isDef(value){return value!==undefined&&value!==null}function BackoffStrategy(options){options=options||{};if(isDef(options.initialDelay)&&options.initialDelay<1){throw new Error("The initial timeout must be greater than 0.")}else if(isDef(options.maxDelay)&&options.maxDelay<1){throw new Error("The maximal timeout must be greater than 0.")}this.initialDelay_=options.initialDelay||100;this.maxDelay_=options.maxDelay||1e4;if(this.maxDelay_<=this.initialDelay_){throw new Error("The maximal backoff delay must be "+"greater than the initial backoff delay.")}if(isDef(options.randomisationFactor)&&(options.randomisationFactor<0||options.randomisationFactor>1)){throw new Error("The randomisation factor must be between 0 and 1.")}this.randomisationFactor_=options.randomisationFactor||0}BackoffStrategy.prototype.getMaxDelay=function(){return this.maxDelay_};BackoffStrategy.prototype.getInitialDelay=function(){return this.initialDelay_};BackoffStrategy.prototype.next=function(){var backoffDelay=this.next_();var randomisationMultiple=1+Math.random()*this.randomisationFactor_;var randomizedDelay=Math.round(backoffDelay*randomisationMultiple);return randomizedDelay};BackoffStrategy.prototype.next_=function(){throw new Error("BackoffStrategy.next_() unimplemented.")};BackoffStrategy.prototype.reset=function(){this.reset_()};BackoffStrategy.prototype.reset_=function(){throw new Error("BackoffStrategy.reset_() unimplemented.")};module.exports=BackoffStrategy},{events:43,util:55}],41:[function(require,module,exports){"use strict";exports.byteLength=byteLength;exports.toByteArray=toByteArray;exports.fromByteArray=fromByteArray;var lookup=[];var revLookup=[];var Arr=typeof Uint8Array!=="undefined"?Uint8Array:Array;var code="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var i=0,len=code.length;i<len;++i){lookup[i]=code[i];revLookup[code.charCodeAt(i)]=i}revLookup["-".charCodeAt(0)]=62;revLookup["_".charCodeAt(0)]=63;function getLens(b64){var len=b64.length;if(len%4>0){throw new Error("Invalid string. Length must be a multiple of 4")}var validLen=b64.indexOf("=");if(validLen===-1)validLen=len;var placeHoldersLen=validLen===len?0:4-validLen%4;return[validLen,placeHoldersLen]}function byteLength(b64){var lens=getLens(b64);var validLen=lens[0];var placeHoldersLen=lens[1];return(validLen+placeHoldersLen)*3/4-placeHoldersLen}function _byteLength(b64,validLen,placeHoldersLen){return(validLen+placeHoldersLen)*3/4-placeHoldersLen}function toByteArray(b64){var tmp;var lens=getLens(b64);var validLen=lens[0];var placeHoldersLen=lens[1];var arr=new Arr(_byteLength(b64,validLen,placeHoldersLen));var curByte=0;var len=placeHoldersLen>0?validLen-4:validLen;for(var i=0;i<len;i+=4){tmp=revLookup[b64.charCodeAt(i)]<<18|revLookup[b64.charCodeAt(i+1)]<<12|revLookup[b64.charCodeAt(i+2)]<<6|revLookup[b64.charCodeAt(i+3)];arr[curByte++]=tmp>>16&255;arr[curByte++]=tmp>>8&255;arr[curByte++]=tmp&255}if(placeHoldersLen===2){tmp=revLookup[b64.charCodeAt(i)]<<2|revLookup[b64.charCodeAt(i+1)]>>4;arr[curByte++]=tmp&255}if(placeHoldersLen===1){tmp=revLookup[b64.charCodeAt(i)]<<10|revLookup[b64.charCodeAt(i+1)]<<4|revLookup[b64.charCodeAt(i+2)]>>2;arr[curByte++]=tmp>>8&255;arr[curByte++]=tmp&255}return arr}function tripletToBase64(num){return lookup[num>>18&63]+lookup[num>>12&63]+lookup[num>>6&63]+lookup[num&63]}function encodeChunk(uint8,start,end){var tmp;var output=[];for(var i=start;i<end;i+=3){tmp=(uint8[i]<<16&16711680)+(uint8[i+1]<<8&65280)+(uint8[i+2]&255);output.push(tripletToBase64(tmp))}return output.join("")}function fromByteArray(uint8){var tmp;var len=uint8.length;var extraBytes=len%3;var parts=[];var maxChunkLength=16383;for(var i=0,len2=len-extraBytes;i<len2;i+=maxChunkLength){parts.push(encodeChunk(uint8,i,i+maxChunkLength>len2?len2:i+maxChunkLength))}if(extraBytes===1){tmp=uint8[len-1];parts.push(lookup[tmp>>2]+lookup[tmp<<4&63]+"==")}else if(extraBytes===2){tmp=(uint8[len-2]<<8)+uint8[len-1];parts.push(lookup[tmp>>10]+lookup[tmp>>4&63]+lookup[tmp<<2&63]+"=")}return parts.join("")}},{}],42:[function(require,module,exports){"use strict";var base64=require("base64-js");var ieee754=require("ieee754");exports.Buffer=Buffer;exports.SlowBuffer=SlowBuffer;exports.INSPECT_MAX_BYTES=50;var K_MAX_LENGTH=2147483647;exports.kMaxLength=K_MAX_LENGTH;Buffer.TYPED_ARRAY_SUPPORT=typedArraySupport();if(!Buffer.TYPED_ARRAY_SUPPORT&&typeof console!=="undefined"&&typeof console.error==="function"){console.error("This browser lacks typed array (Uint8Array) support which is required by "+"`buffer` v5.x. Use `buffer` v4.x if you require old browser support.")}function typedArraySupport(){try{var arr=new Uint8Array(1);arr.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}};return arr.foo()===42}catch(e){return false}}Object.defineProperty(Buffer.prototype,"parent",{get:function(){if(!(this instanceof Buffer)){return undefined}return this.buffer}});Object.defineProperty(Buffer.prototype,"offset",{get:function(){if(!(this instanceof Buffer)){return undefined}return this.byteOffset}});function createBuffer(length){if(length>K_MAX_LENGTH){throw new RangeError("Invalid typed array length")}var buf=new Uint8Array(length);buf.__proto__=Buffer.prototype;return buf}function Buffer(arg,encodingOrOffset,length){if(typeof arg==="number"){if(typeof encodingOrOffset==="string"){throw new Error("If encoding is specified then the first argument must be a string")}return allocUnsafe(arg)}return from(arg,encodingOrOffset,length)}if(typeof Symbol!=="undefined"&&Symbol.species&&Buffer[Symbol.species]===Buffer){Object.defineProperty(Buffer,Symbol.species,{value:null,configurable:true,enumerable:false,writable:false})}Buffer.poolSize=8192;function from(value,encodingOrOffset,length){if(typeof value==="number"){throw new TypeError('"value" argument must not be a number')}if(isArrayBuffer(value)||value&&isArrayBuffer(value.buffer)){return fromArrayBuffer(value,encodingOrOffset,length)}if(typeof value==="string"){return fromString(value,encodingOrOffset)}return fromObject(value)}Buffer.from=function(value,encodingOrOffset,length){return from(value,encodingOrOffset,length)};Buffer.prototype.__proto__=Uint8Array.prototype;Buffer.__proto__=Uint8Array;function assertSize(size){if(typeof size!=="number"){throw new TypeError('"size" argument must be of type number')}else if(size<0){throw new RangeError('"size" argument must not be negative')}}function alloc(size,fill,encoding){assertSize(size);if(size<=0){return createBuffer(size)}if(fill!==undefined){return typeof encoding==="string"?createBuffer(size).fill(fill,encoding):createBuffer(size).fill(fill)}return createBuffer(size)}Buffer.alloc=function(size,fill,encoding){return alloc(size,fill,encoding)};function allocUnsafe(size){assertSize(size);return createBuffer(size<0?0:checked(size)|0)}Buffer.allocUnsafe=function(size){return allocUnsafe(size)};Buffer.allocUnsafeSlow=function(size){return allocUnsafe(size)};function fromString(string,encoding){if(typeof encoding!=="string"||encoding===""){encoding="utf8"}if(!Buffer.isEncoding(encoding)){throw new TypeError("Unknown encoding: "+encoding)}var length=byteLength(string,encoding)|0;var buf=createBuffer(length);var actual=buf.write(string,encoding);if(actual!==length){buf=buf.slice(0,actual)}return buf}function fromArrayLike(array){var length=array.length<0?0:checked(array.length)|0;var buf=createBuffer(length);for(var i=0;i<length;i+=1){buf[i]=array[i]&255}return buf}function fromArrayBuffer(array,byteOffset,length){if(byteOffset<0||array.byteLength<byteOffset){throw new RangeError('"offset" is outside of buffer bounds')}if(array.byteLength<byteOffset+(length||0)){throw new RangeError('"length" is outside of buffer bounds')}var buf;if(byteOffset===undefined&&length===undefined){buf=new Uint8Array(array)}else if(length===undefined){buf=new Uint8Array(array,byteOffset)}else{buf=new Uint8Array(array,byteOffset,length)}buf.__proto__=Buffer.prototype;return buf}function fromObject(obj){if(Buffer.isBuffer(obj)){var len=checked(obj.length)|0;var buf=createBuffer(len);if(buf.length===0){return buf}obj.copy(buf,0,0,len);return buf}if(obj){if(ArrayBuffer.isView(obj)||"length"in obj){if(typeof obj.length!=="number"||numberIsNaN(obj.length)){return createBuffer(0)}return fromArrayLike(obj)}if(obj.type==="Buffer"&&Array.isArray(obj.data)){return fromArrayLike(obj.data)}}throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object.")}function checked(length){if(length>=K_MAX_LENGTH){throw new RangeError("Attempt to allocate Buffer larger than maximum "+"size: 0x"+K_MAX_LENGTH.toString(16)+" bytes")}return length|0}function SlowBuffer(length){if(+length!=length){length=0}return Buffer.alloc(+length)}Buffer.isBuffer=function isBuffer(b){return b!=null&&b._isBuffer===true};Buffer.compare=function compare(a,b){if(!Buffer.isBuffer(a)||!Buffer.isBuffer(b)){throw new TypeError("Arguments must be Buffers")}if(a===b)return 0;var x=a.length;var y=b.length;for(var i=0,len=Math.min(x,y);i<len;++i){if(a[i]!==b[i]){x=a[i];y=b[i];break}}if(x<y)return-1;if(y<x)return 1;return 0};Buffer.isEncoding=function isEncoding(encoding){switch(String(encoding).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return true;default:return false}};Buffer.concat=function concat(list,length){if(!Array.isArray(list)){throw new TypeError('"list" argument must be an Array of Buffers')}if(list.length===0){return Buffer.alloc(0)}var i;if(length===undefined){length=0;for(i=0;i<list.length;++i){length+=list[i].length}}var buffer=Buffer.allocUnsafe(length);var pos=0;for(i=0;i<list.length;++i){var buf=list[i];if(ArrayBuffer.isView(buf)){buf=Buffer.from(buf)}if(!Buffer.isBuffer(buf)){throw new TypeError('"list" argument must be an Array of Buffers')}buf.copy(buffer,pos);pos+=buf.length}return buffer};function byteLength(string,encoding){if(Buffer.isBuffer(string)){return string.length}if(ArrayBuffer.isView(string)||isArrayBuffer(string)){return string.byteLength}if(typeof string!=="string"){string=""+string}var len=string.length;if(len===0)return 0;var loweredCase=false;for(;;){switch(encoding){case"ascii":case"latin1":case"binary":return len;case"utf8":case"utf-8":case undefined:return utf8ToBytes(string).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return len*2;case"hex":return len>>>1;case"base64":return base64ToBytes(string).length;default:if(loweredCase)return utf8ToBytes(string).length;encoding=(""+encoding).toLowerCase();loweredCase=true}}}Buffer.byteLength=byteLength;function slowToString(encoding,start,end){var loweredCase=false;if(start===undefined||start<0){start=0}if(start>this.length){return""}if(end===undefined||end>this.length){end=this.length}if(end<=0){return""}end>>>=0;start>>>=0;if(end<=start){return""}if(!encoding)encoding="utf8";while(true){switch(encoding){case"hex":return hexSlice(this,start,end);case"utf8":case"utf-8":return utf8Slice(this,start,end);case"ascii":return asciiSlice(this,start,end);case"latin1":case"binary":return latin1Slice(this,start,end);case"base64":return base64Slice(this,start,end);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return utf16leSlice(this,start,end);default:if(loweredCase)throw new TypeError("Unknown encoding: "+encoding);encoding=(encoding+"").toLowerCase();loweredCase=true}}}Buffer.prototype._isBuffer=true;function swap(b,n,m){var i=b[n];b[n]=b[m];b[m]=i}Buffer.prototype.swap16=function swap16(){var len=this.length;if(len%2!==0){throw new RangeError("Buffer size must be a multiple of 16-bits")}for(var i=0;i<len;i+=2){swap(this,i,i+1)}return this};Buffer.prototype.swap32=function swap32(){var len=this.length;if(len%4!==0){throw new RangeError("Buffer size must be a multiple of 32-bits")}for(var i=0;i<len;i+=4){swap(this,i,i+3);swap(this,i+1,i+2)}return this};Buffer.prototype.swap64=function swap64(){var len=this.length;if(len%8!==0){throw new RangeError("Buffer size must be a multiple of 64-bits")}for(var i=0;i<len;i+=8){swap(this,i,i+7);swap(this,i+1,i+6);swap(this,i+2,i+5);swap(this,i+3,i+4)}return this};Buffer.prototype.toString=function toString(){var length=this.length;if(length===0)return"";if(arguments.length===0)return utf8Slice(this,0,length);return slowToString.apply(this,arguments)};Buffer.prototype.toLocaleString=Buffer.prototype.toString;Buffer.prototype.equals=function equals(b){if(!Buffer.isBuffer(b))throw new TypeError("Argument must be a Buffer");if(this===b)return true;return Buffer.compare(this,b)===0};Buffer.prototype.inspect=function inspect(){var str="";var max=exports.INSPECT_MAX_BYTES;if(this.length>0){str=this.toString("hex",0,max).match(/.{2}/g).join(" ");if(this.length>max)str+=" ... "}return"<Buffer "+str+">"};Buffer.prototype.compare=function compare(target,start,end,thisStart,thisEnd){if(!Buffer.isBuffer(target)){throw new TypeError("Argument must be a Buffer")}if(start===undefined){start=0}if(end===undefined){end=target?target.length:0}if(thisStart===undefined){thisStart=0}if(thisEnd===undefined){thisEnd=this.length}if(start<0||end>target.length||thisStart<0||thisEnd>this.length){throw new RangeError("out of range index")}if(thisStart>=thisEnd&&start>=end){return 0}if(thisStart>=thisEnd){return-1}if(start>=end){return 1}start>>>=0;end>>>=0;thisStart>>>=0;thisEnd>>>=0;if(this===target)return 0;var x=thisEnd-thisStart;var y=end-start;var len=Math.min(x,y);var thisCopy=this.slice(thisStart,thisEnd);var targetCopy=target.slice(start,end);for(var i=0;i<len;++i){if(thisCopy[i]!==targetCopy[i]){x=thisCopy[i];y=targetCopy[i];break}}if(x<y)return-1;if(y<x)return 1;return 0};function bidirectionalIndexOf(buffer,val,byteOffset,encoding,dir){if(buffer.length===0)return-1;if(typeof byteOffset==="string"){encoding=byteOffset;byteOffset=0}else if(byteOffset>2147483647){byteOffset=2147483647}else if(byteOffset<-2147483648){byteOffset=-2147483648}byteOffset=+byteOffset;if(numberIsNaN(byteOffset)){byteOffset=dir?0:buffer.length-1}if(byteOffset<0)byteOffset=buffer.length+byteOffset;if(byteOffset>=buffer.length){if(dir)return-1;else byteOffset=buffer.length-1}else if(byteOffset<0){if(dir)byteOffset=0;else return-1}if(typeof val==="string"){val=Buffer.from(val,encoding)}if(Buffer.isBuffer(val)){if(val.length===0){return-1}return arrayIndexOf(buffer,val,byteOffset,encoding,dir)}else if(typeof val==="number"){val=val&255;if(typeof Uint8Array.prototype.indexOf==="function"){if(dir){return Uint8Array.prototype.indexOf.call(buffer,val,byteOffset)}else{return Uint8Array.prototype.lastIndexOf.call(buffer,val,byteOffset)}}return arrayIndexOf(buffer,[val],byteOffset,encoding,dir)}throw new TypeError("val must be string, number or Buffer")}function arrayIndexOf(arr,val,byteOffset,encoding,dir){var indexSize=1;var arrLength=arr.length;var valLength=val.length;if(encoding!==undefined){encoding=String(encoding).toLowerCase();if(encoding==="ucs2"||encoding==="ucs-2"||encoding==="utf16le"||encoding==="utf-16le"){if(arr.length<2||val.length<2){return-1}indexSize=2;arrLength/=2;valLength/=2;byteOffset/=2}}function read(buf,i){if(indexSize===1){return buf[i]}else{return buf.readUInt16BE(i*indexSize)}}var i;if(dir){var foundIndex=-1;for(i=byteOffset;i<arrLength;i++){if(read(arr,i)===read(val,foundIndex===-1?0:i-foundIndex)){if(foundIndex===-1)foundIndex=i;if(i-foundIndex+1===valLength)return foundIndex*indexSize}else{if(foundIndex!==-1)i-=i-foundIndex;foundIndex=-1}}}else{if(byteOffset+valLength>arrLength)byteOffset=arrLength-valLength;for(i=byteOffset;i>=0;i--){var found=true;for(var j=0;j<valLength;j++){if(read(arr,i+j)!==read(val,j)){found=false;break}}if(found)return i}}return-1}Buffer.prototype.includes=function includes(val,byteOffset,encoding){return this.indexOf(val,byteOffset,encoding)!==-1};Buffer.prototype.indexOf=function indexOf(val,byteOffset,encoding){return bidirectionalIndexOf(this,val,byteOffset,encoding,true)};Buffer.prototype.lastIndexOf=function lastIndexOf(val,byteOffset,encoding){return bidirectionalIndexOf(this,val,byteOffset,encoding,false)};function hexWrite(buf,string,offset,length){offset=Number(offset)||0;var remaining=buf.length-offset;if(!length){length=remaining}else{length=Number(length);if(length>remaining){length=remaining}}var strLen=string.length;if(length>strLen/2){length=strLen/2}for(var i=0;i<length;++i){var parsed=parseInt(string.substr(i*2,2),16);if(numberIsNaN(parsed))return i;buf[offset+i]=parsed}return i}function utf8Write(buf,string,offset,length){return blitBuffer(utf8ToBytes(string,buf.length-offset),buf,offset,length)}function asciiWrite(buf,string,offset,length){return blitBuffer(asciiToBytes(string),buf,offset,length)}function latin1Write(buf,string,offset,length){return asciiWrite(buf,string,offset,length)}function base64Write(buf,string,offset,length){return blitBuffer(base64ToBytes(string),buf,offset,length)}function ucs2Write(buf,string,offset,length){return blitBuffer(utf16leToBytes(string,buf.length-offset),buf,offset,length)}Buffer.prototype.write=function write(string,offset,length,encoding){if(offset===undefined){encoding="utf8";length=this.length;offset=0}else if(length===undefined&&typeof offset==="string"){encoding=offset;length=this.length;offset=0}else if(isFinite(offset)){offset=offset>>>0;if(isFinite(length)){length=length>>>0;if(encoding===undefined)encoding="utf8"}else{encoding=length;length=undefined}}else{throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported")}var remaining=this.length-offset;if(length===undefined||length>remaining)length=remaining;if(string.length>0&&(length<0||offset<0)||offset>this.length){throw new RangeError("Attempt to write outside buffer bounds")}if(!encoding)encoding="utf8";var loweredCase=false;for(;;){switch(encoding){case"hex":return hexWrite(this,string,offset,length);case"utf8":case"utf-8":return utf8Write(this,string,offset,length);case"ascii":return asciiWrite(this,string,offset,length);case"latin1":case"binary":return latin1Write(this,string,offset,length);case"base64":return base64Write(this,string,offset,length);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return ucs2Write(this,string,offset,length);default:if(loweredCase)throw new TypeError("Unknown encoding: "+encoding);encoding=(""+encoding).toLowerCase();loweredCase=true}}};Buffer.prototype.toJSON=function toJSON(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function base64Slice(buf,start,end){if(start===0&&end===buf.length){return base64.fromByteArray(buf)}else{return base64.fromByteArray(buf.slice(start,end))}}function utf8Slice(buf,start,end){end=Math.min(buf.length,end);var res=[];var i=start;while(i<end){var firstByte=buf[i];var codePoint=null;var bytesPerSequence=firstByte>239?4:firstByte>223?3:firstByte>191?2:1;if(i+bytesPerSequence<=end){var secondByte,thirdByte,fourthByte,tempCodePoint;switch(bytesPerSequence){case 1:if(firstByte<128){codePoint=firstByte}break;case 2:secondByte=buf[i+1];if((secondByte&192)===128){tempCodePoint=(firstByte&31)<<6|secondByte&63;if(tempCodePoint>127){codePoint=tempCodePoint}}break;case 3:secondByte=buf[i+1];thirdByte=buf[i+2];if((secondByte&192)===128&&(thirdByte&192)===128){tempCodePoint=(firstByte&15)<<12|(secondByte&63)<<6|thirdByte&63;if(tempCodePoint>2047&&(tempCodePoint<55296||tempCodePoint>57343)){codePoint=tempCodePoint}}break;case 4:secondByte=buf[i+1];thirdByte=buf[i+2];fourthByte=buf[i+3];if((secondByte&192)===128&&(thirdByte&192)===128&&(fourthByte&192)===128){tempCodePoint=(firstByte&15)<<18|(secondByte&63)<<12|(thirdByte&63)<<6|fourthByte&63;if(tempCodePoint>65535&&tempCodePoint<1114112){codePoint=tempCodePoint}}}}if(codePoint===null){codePoint=65533;bytesPerSequence=1}else if(codePoint>65535){codePoint-=65536;res.push(codePoint>>>10&1023|55296);codePoint=56320|codePoint&1023}res.push(codePoint);i+=bytesPerSequence}return decodeCodePointsArray(res)}var MAX_ARGUMENTS_LENGTH=4096;function decodeCodePointsArray(codePoints){var len=codePoints.length;if(len<=MAX_ARGUMENTS_LENGTH){return String.fromCharCode.apply(String,codePoints)}var res="";var i=0;while(i<len){res+=String.fromCharCode.apply(String,codePoints.slice(i,i+=MAX_ARGUMENTS_LENGTH))}return res}function asciiSlice(buf,start,end){var ret="";end=Math.min(buf.length,end);for(var i=start;i<end;++i){ret+=String.fromCharCode(buf[i]&127)}return ret}function latin1Slice(buf,start,end){var ret="";end=Math.min(buf.length,end);for(var i=start;i<end;++i){ret+=String.fromCharCode(buf[i])}return ret}function hexSlice(buf,start,end){var len=buf.length;if(!start||start<0)start=0;if(!end||end<0||end>len)end=len;var out="";for(var i=start;i<end;++i){out+=toHex(buf[i])}return out}function utf16leSlice(buf,start,end){var bytes=buf.slice(start,end);var res="";for(var i=0;i<bytes.length;i+=2){res+=String.fromCharCode(bytes[i]+bytes[i+1]*256)}return res}Buffer.prototype.slice=function slice(start,end){var len=this.length;start=~~start;end=end===undefined?len:~~end;if(start<0){start+=len;if(start<0)start=0}else if(start>len){start=len}if(end<0){end+=len;if(end<0)end=0}else if(end>len){end=len}if(end<start)end=start;var newBuf=this.subarray(start,end);newBuf.__proto__=Buffer.prototype;return newBuf};function checkOffset(offset,ext,length){if(offset%1!==0||offset<0)throw new RangeError("offset is not uint");if(offset+ext>length)throw new RangeError("Trying to access beyond buffer length")}Buffer.prototype.readUIntLE=function readUIntLE(offset,byteLength,noAssert){offset=offset>>>0;byteLength=byteLength>>>0;if(!noAssert)checkOffset(offset,byteLength,this.length);var val=this[offset];var mul=1;var i=0;while(++i<byteLength&&(mul*=256)){val+=this[offset+i]*mul}return val};Buffer.prototype.readUIntBE=function readUIntBE(offset,byteLength,noAssert){offset=offset>>>0;byteLength=byteLength>>>0;if(!noAssert){checkOffset(offset,byteLength,this.length)}var val=this[offset+--byteLength];var mul=1;while(byteLength>0&&(mul*=256)){val+=this[offset+--byteLength]*mul}return val};Buffer.prototype.readUInt8=function readUInt8(offset,noAssert){offset=offset>>>0;if(!noAssert)checkOffset(offset,1,this.length);return this[offset]};Buffer.prototype.readUInt16LE=function readUInt16LE(offset,noAssert){offset=offset>>>0;if(!noAssert)checkOffset(offset,2,this.length);return this[offset]|this[offset+1]<<8};Buffer.prototype.readUInt16BE=function readUInt16BE(offset,noAssert){offset=offset>>>0;if(!noAssert)checkOffset(offset,2,this.length);return this[offset]<<8|this[offset+1]};Buffer.prototype.readUInt32LE=function readUInt32LE(offset,noAssert){offset=offset>>>0;if(!noAssert)checkOffset(offset,4,this.length);return(this[offset]|this[offset+1]<<8|this[offset+2]<<16)+this[offset+3]*16777216};Buffer.prototype.readUInt32BE=function readUInt32BE(offset,noAssert){offset=offset>>>0;if(!noAssert)checkOffset(offset,4,this.length);return this[offset]*16777216+(this[offset+1]<<16|this[offset+2]<<8|this[offset+3])};Buffer.prototype.readIntLE=function readIntLE(offset,byteLength,noAssert){offset=offset>>>0;byteLength=byteLength>>>0;if(!noAssert)checkOffset(offset,byteLength,this.length);var val=this[offset];var mul=1;var i=0;while(++i<byteLength&&(mul*=256)){val+=this[offset+i]*mul}mul*=128;if(val>=mul)val-=Math.pow(2,8*byteLength);return val};Buffer.prototype.readIntBE=function readIntBE(offset,byteLength,noAssert){offset=offset>>>0;byteLength=byteLength>>>0;if(!noAssert)checkOffset(offset,byteLength,this.length);var i=byteLength;var mul=1;var val=this[offset+--i];while(i>0&&(mul*=256)){val+=this[offset+--i]*mul}mul*=128;if(val>=mul)val-=Math.pow(2,8*byteLength);return val};Buffer.prototype.readInt8=function readInt8(offset,noAssert){offset=offset>>>0;if(!noAssert)checkOffset(offset,1,this.length);if(!(this[offset]&128))return this[offset];return(255-this[offset]+1)*-1};Buffer.prototype.readInt16LE=function readInt16LE(offset,noAssert){offset=offset>>>0;if(!noAssert)checkOffset(offset,2,this.length);var val=this[offset]|this[offset+1]<<8;return val&32768?val|4294901760:val};Buffer.prototype.readInt16BE=function readInt16BE(offset,noAssert){offset=offset>>>0;if(!noAssert)checkOffset(offset,2,this.length);var val=this[offset+1]|this[offset]<<8;return val&32768?val|4294901760:val};Buffer.prototype.readInt32LE=function readInt32LE(offset,noAssert){offset=offset>>>0;if(!noAssert)checkOffset(offset,4,this.length);return this[offset]|this[offset+1]<<8|this[offset+2]<<16|this[offset+3]<<24};Buffer.prototype.readInt32BE=function readInt32BE(offset,noAssert){offset=offset>>>0;if(!noAssert)checkOffset(offset,4,this.length);return this[offset]<<24|this[offset+1]<<16|this[offset+2]<<8|this[offset+3]};Buffer.prototype.readFloatLE=function readFloatLE(offset,noAssert){offset=offset>>>0;if(!noAssert)checkOffset(offset,4,this.length);return ieee754.read(this,offset,true,23,4)};Buffer.prototype.readFloatBE=function readFloatBE(offset,noAssert){offset=offset>>>0;if(!noAssert)checkOffset(offset,4,this.length);return ieee754.read(this,offset,false,23,4)};Buffer.prototype.readDoubleLE=function readDoubleLE(offset,noAssert){offset=offset>>>0;if(!noAssert)checkOffset(offset,8,this.length);return ieee754.read(this,offset,true,52,8)};Buffer.prototype.readDoubleBE=function readDoubleBE(offset,noAssert){offset=offset>>>0;if(!noAssert)checkOffset(offset,8,this.length);return ieee754.read(this,offset,false,52,8)};function checkInt(buf,value,offset,ext,max,min){if(!Buffer.isBuffer(buf))throw new TypeError('"buffer" argument must be a Buffer instance');if(value>max||value<min)throw new RangeError('"value" argument is out of bounds');if(offset+ext>buf.length)throw new RangeError("Index out of range")}Buffer.prototype.writeUIntLE=function writeUIntLE(value,offset,byteLength,noAssert){value=+value;offset=offset>>>0;byteLength=byteLength>>>0;if(!noAssert){var maxBytes=Math.pow(2,8*byteLength)-1;checkInt(this,value,offset,byteLength,maxBytes,0)}var mul=1;var i=0;this[offset]=value&255;while(++i<byteLength&&(mul*=256)){this[offset+i]=value/mul&255}return offset+byteLength};Buffer.prototype.writeUIntBE=function writeUIntBE(value,offset,byteLength,noAssert){value=+value;offset=offset>>>0;byteLength=byteLength>>>0;if(!noAssert){var maxBytes=Math.pow(2,8*byteLength)-1;checkInt(this,value,offset,byteLength,maxBytes,0)}var i=byteLength-1;var mul=1;this[offset+i]=value&255;while(--i>=0&&(mul*=256)){this[offset+i]=value/mul&255}return offset+byteLength};Buffer.prototype.writeUInt8=function writeUInt8(value,offset,noAssert){value=+value;offset=offset>>>0;if(!noAssert)checkInt(this,value,offset,1,255,0);this[offset]=value&255;return offset+1};Buffer.prototype.writeUInt16LE=function writeUInt16LE(value,offset,noAssert){value=+value;offset=offset>>>0;if(!noAssert)checkInt(this,value,offset,2,65535,0);this[offset]=value&255;this[offset+1]=value>>>8;return offset+2};Buffer.prototype.writeUInt16BE=function writeUInt16BE(value,offset,noAssert){value=+value;offset=offset>>>0;if(!noAssert)checkInt(this,value,offset,2,65535,0);this[offset]=value>>>8;this[offset+1]=value&255;return offset+2};Buffer.prototype.writeUInt32LE=function writeUInt32LE(value,offset,noAssert){value=+value;offset=offset>>>0;if(!noAssert)checkInt(this,value,offset,4,4294967295,0);this[offset+3]=value>>>24;this[offset+2]=value>>>16;this[offset+1]=value>>>8;this[offset]=value&255;return offset+4};Buffer.prototype.writeUInt32BE=function writeUInt32BE(value,offset,noAssert){value=+value;offset=offset>>>0;if(!noAssert)checkInt(this,value,offset,4,4294967295,0);this[offset]=value>>>24;this[offset+1]=value>>>16;this[offset+2]=value>>>8;this[offset+3]=value&255;return offset+4};Buffer.prototype.writeIntLE=function writeIntLE(value,offset,byteLength,noAssert){value=+value;offset=offset>>>0;if(!noAssert){var limit=Math.pow(2,8*byteLength-1);checkInt(this,value,offset,byteLength,limit-1,-limit)}var i=0;var mul=1;var sub=0;this[offset]=value&255;while(++i<byteLength&&(mul*=256)){if(value<0&&sub===0&&this[offset+i-1]!==0){sub=1}this[offset+i]=(value/mul>>0)-sub&255}return offset+byteLength};Buffer.prototype.writeIntBE=function writeIntBE(value,offset,byteLength,noAssert){value=+value;offset=offset>>>0;if(!noAssert){var limit=Math.pow(2,8*byteLength-1);checkInt(this,value,offset,byteLength,limit-1,-limit)}var i=byteLength-1;var mul=1;var sub=0;this[offset+i]=value&255;while(--i>=0&&(mul*=256)){if(value<0&&sub===0&&this[offset+i+1]!==0){sub=1}this[offset+i]=(value/mul>>0)-sub&255}return offset+byteLength};Buffer.prototype.writeInt8=function writeInt8(value,offset,noAssert){value=+value;offset=offset>>>0;if(!noAssert)checkInt(this,value,offset,1,127,-128);if(value<0)value=255+value+1;this[offset]=value&255;return offset+1};Buffer.prototype.writeInt16LE=function writeInt16LE(value,offset,noAssert){value=+value;offset=offset>>>0;if(!noAssert)checkInt(this,value,offset,2,32767,-32768);this[offset]=value&255;this[offset+1]=value>>>8;return offset+2};Buffer.prototype.writeInt16BE=function writeInt16BE(value,offset,noAssert){value=+value;offset=offset>>>0;if(!noAssert)checkInt(this,value,offset,2,32767,-32768);this[offset]=value>>>8;this[offset+1]=value&255;return offset+2};Buffer.prototype.writeInt32LE=function writeInt32LE(value,offset,noAssert){value=+value;offset=offset>>>0;if(!noAssert)checkInt(this,value,offset,4,2147483647,-2147483648);this[offset]=value&255;this[offset+1]=value>>>8;this[offset+2]=value>>>16;this[offset+3]=value>>>24;return offset+4};Buffer.prototype.writeInt32BE=function writeInt32BE(value,offset,noAssert){value=+value;offset=offset>>>0;if(!noAssert)checkInt(this,value,offset,4,2147483647,-2147483648);if(value<0)value=4294967295+value+1;this[offset]=value>>>24;this[offset+1]=value>>>16;this[offset+2]=value>>>8;this[offset+3]=value&255;return offset+4};function checkIEEE754(buf,value,offset,ext,max,min){if(offset+ext>buf.length)throw new RangeError("Index out of range");if(offset<0)throw new RangeError("Index out of range")}function writeFloat(buf,value,offset,littleEndian,noAssert){value=+value;offset=offset>>>0;if(!noAssert){checkIEEE754(buf,value,offset,4,3.4028234663852886e38,-3.4028234663852886e38)}ieee754.write(buf,value,offset,littleEndian,23,4);return offset+4}Buffer.prototype.writeFloatLE=function writeFloatLE(value,offset,noAssert){return writeFloat(this,value,offset,true,noAssert)};Buffer.prototype.writeFloatBE=function writeFloatBE(value,offset,noAssert){return writeFloat(this,value,offset,false,noAssert)};function writeDouble(buf,value,offset,littleEndian,noAssert){value=+value;offset=offset>>>0;if(!noAssert){checkIEEE754(buf,value,offset,8,1.7976931348623157e308,-1.7976931348623157e308)}ieee754.write(buf,value,offset,littleEndian,52,8);return offset+8}Buffer.prototype.writeDoubleLE=function writeDoubleLE(value,offset,noAssert){return writeDouble(this,value,offset,true,noAssert)};Buffer.prototype.writeDoubleBE=function writeDoubleBE(value,offset,noAssert){return writeDouble(this,value,offset,false,noAssert)};Buffer.prototype.copy=function copy(target,targetStart,start,end){if(!Buffer.isBuffer(target))throw new TypeError("argument should be a Buffer");if(!start)start=0;if(!end&&end!==0)end=this.length;if(targetStart>=target.length)targetStart=target.length;if(!targetStart)targetStart=0;if(end>0&&end<start)end=start;if(end===start)return 0;if(target.length===0||this.length===0)return 0;if(targetStart<0){throw new RangeError("targetStart out of bounds")}if(start<0||start>=this.length)throw new RangeError("Index out of range");if(end<0)throw new RangeError("sourceEnd out of bounds");if(end>this.length)end=this.length;if(target.length-targetStart<end-start){end=target.length-targetStart+start}var len=end-start;if(this===target&&typeof Uint8Array.prototype.copyWithin==="function"){this.copyWithin(targetStart,start,end)}else if(this===target&&start<targetStart&&targetStart<end){for(var i=len-1;i>=0;--i){target[i+targetStart]=this[i+start]}}else{Uint8Array.prototype.set.call(target,this.subarray(start,end),targetStart)}return len};Buffer.prototype.fill=function fill(val,start,end,encoding){if(typeof val==="string"){if(typeof start==="string"){encoding=start;start=0;end=this.length}else if(typeof end==="string"){encoding=end;end=this.length}if(encoding!==undefined&&typeof encoding!=="string"){throw new TypeError("encoding must be a string")}if(typeof encoding==="string"&&!Buffer.isEncoding(encoding)){throw new TypeError("Unknown encoding: "+encoding)}if(val.length===1){var code=val.charCodeAt(0);if(encoding==="utf8"&&code<128||encoding==="latin1"){val=code}}}else if(typeof val==="number"){val=val&255}if(start<0||this.length<start||this.length<end){throw new RangeError("Out of range index")}if(end<=start){return this}start=start>>>0;end=end===undefined?this.length:end>>>0;if(!val)val=0;var i;if(typeof val==="number"){for(i=start;i<end;++i){this[i]=val}}else{var bytes=Buffer.isBuffer(val)?val:new Buffer(val,encoding);var len=bytes.length;if(len===0){throw new TypeError('The value "'+val+'" is invalid for argument "value"')}for(i=0;i<end-start;++i){this[i+start]=bytes[i%len]}}return this};var INVALID_BASE64_RE=/[^+/0-9A-Za-z-_]/g;function base64clean(str){str=str.split("=")[0];str=str.trim().replace(INVALID_BASE64_RE,"");if(str.length<2)return"";while(str.length%4!==0){str=str+"="}return str}function toHex(n){if(n<16)return"0"+n.toString(16);return n.toString(16)}function utf8ToBytes(string,units){units=units||Infinity;var codePoint;var length=string.length;var leadSurrogate=null;var bytes=[];for(var i=0;i<length;++i){codePoint=string.charCodeAt(i);if(codePoint>55295&&codePoint<57344){if(!leadSurrogate){if(codePoint>56319){if((units-=3)>-1)bytes.push(239,191,189);continue}else if(i+1===length){if((units-=3)>-1)bytes.push(239,191,189);continue}leadSurrogate=codePoint;continue}if(codePoint<56320){if((units-=3)>-1)bytes.push(239,191,189);leadSurrogate=codePoint;continue}codePoint=(leadSurrogate-55296<<10|codePoint-56320)+65536}else if(leadSurrogate){if((units-=3)>-1)bytes.push(239,191,189)}leadSurrogate=null;if(codePoint<128){if((units-=1)<0)break;bytes.push(codePoint)}else if(codePoint<2048){if((units-=2)<0)break;bytes.push(codePoint>>6|192,codePoint&63|128)}else if(codePoint<65536){if((units-=3)<0)break;bytes.push(codePoint>>12|224,codePoint>>6&63|128,codePoint&63|128)}else if(codePoint<1114112){if((units-=4)<0)break;bytes.push(codePoint>>18|240,codePoint>>12&63|128,codePoint>>6&63|128,codePoint&63|128)}else{throw new Error("Invalid code point")}}return bytes}function asciiToBytes(str){var byteArray=[];for(var i=0;i<str.length;++i){byteArray.push(str.charCodeAt(i)&255)}return byteArray}function utf16leToBytes(str,units){var c,hi,lo;var byteArray=[];for(var i=0;i<str.length;++i){if((units-=2)<0)break;c=str.charCodeAt(i);hi=c>>8;lo=c%256;byteArray.push(lo);byteArray.push(hi)}return byteArray}function base64ToBytes(str){return base64.toByteArray(base64clean(str))}function blitBuffer(src,dst,offset,length){for(var i=0;i<length;++i){if(i+offset>=dst.length||i>=src.length)break;dst[i+offset]=src[i]}return i}function isArrayBuffer(obj){return obj instanceof ArrayBuffer||obj!=null&&obj.constructor!=null&&obj.constructor.name==="ArrayBuffer"&&typeof obj.byteLength==="number"}function numberIsNaN(obj){return obj!==obj}},{"base64-js":41,ieee754:44}],43:[function(require,module,exports){function EventEmitter(){this._events=this._events||{};this._maxListeners=this._maxListeners||undefined}module.exports=EventEmitter;EventEmitter.EventEmitter=EventEmitter;EventEmitter.prototype._events=undefined;EventEmitter.prototype._maxListeners=undefined;EventEmitter.defaultMaxListeners=10;EventEmitter.prototype.setMaxListeners=function(n){if(!isNumber(n)||n<0||isNaN(n))throw TypeError("n must be a positive number");this._maxListeners=n;return this};EventEmitter.prototype.emit=function(type){var er,handler,len,args,i,listeners;if(!this._events)this._events={};if(type==="error"){if(!this._events.error||isObject(this._events.error)&&!this._events.error.length){er=arguments[1];if(er instanceof Error){throw er}else{var err=new Error('Uncaught, unspecified "error" event. ('+er+")");err.context=er;throw err}}}handler=this._events[type];if(isUndefined(handler))return false;if(isFunction(handler)){switch(arguments.length){case 1:handler.call(this);break;case 2:handler.call(this,arguments[1]);break;case 3:handler.call(this,arguments[1],arguments[2]);break;default:args=Array.prototype.slice.call(arguments,1);handler.apply(this,args)}}else if(isObject(handler)){args=Array.prototype.slice.call(arguments,1);listeners=handler.slice();len=listeners.length;for(i=0;i<len;i++)listeners[i].apply(this,args)}return true};EventEmitter.prototype.addListener=function(type,listener){var m;if(!isFunction(listener))throw TypeError("listener must be a function");if(!this._events)this._events={};if(this._events.newListener)this.emit("newListener",type,isFunction(listener.listener)?listener.listener:listener);if(!this._events[type])this._events[type]=listener;else if(isObject(this._events[type]))this._events[type].push(listener);else this._events[type]=[this._events[type],listener];if(isObject(this._events[type])&&!this._events[type].warned){if(!isUndefined(this._maxListeners)){m=this._maxListeners}else{m=EventEmitter.defaultMaxListeners}if(m&&m>0&&this._events[type].length>m){this._events[type].warned=true;console.error("(node) warning: possible EventEmitter memory "+"leak detected. %d listeners added. "+"Use emitter.setMaxListeners() to increase limit.",this._events[type].length);if(typeof console.trace==="function"){console.trace()}}}return this};EventEmitter.prototype.on=EventEmitter.prototype.addListener;EventEmitter.prototype.once=function(type,listener){if(!isFunction(listener))throw TypeError("listener must be a function");var fired=false;function g(){this.removeListener(type,g);if(!fired){fired=true;listener.apply(this,arguments)}}g.listener=listener;this.on(type,g);return this};EventEmitter.prototype.removeListener=function(type,listener){var list,position,length,i;if(!isFunction(listener))throw TypeError("listener must be a function");if(!this._events||!this._events[type])return this;list=this._events[type];length=list.length;position=-1;if(list===listener||isFunction(list.listener)&&list.listener===listener){delete this._events[type];if(this._events.removeListener)this.emit("removeListener",type,listener)}else if(isObject(list)){for(i=length;i-- >0;){if(list[i]===listener||list[i].listener&&list[i].listener===listener){position=i;break}}if(position<0)return this;if(list.length===1){list.length=0;delete this._events[type]}else{list.splice(position,1)}if(this._events.removeListener)this.emit("removeListener",type,listener)}return this};EventEmitter.prototype.removeAllListeners=function(type){var key,listeners;if(!this._events)return this;if(!this._events.removeListener){if(arguments.length===0)this._events={};else if(this._events[type])delete this._events[type];return this}if(arguments.length===0){for(key in this._events){if(key==="removeListener")continue;this.removeAllListeners(key)}this.removeAllListeners("removeListener");this._events={};return this}listeners=this._events[type];if(isFunction(listeners)){this.removeListener(type,listeners)}else if(listeners){while(listeners.length)this.removeListener(type,listeners[listeners.length-1])}delete this._events[type];return this};EventEmitter.prototype.listeners=function(type){var ret;if(!this._events||!this._events[type])ret=[];else if(isFunction(this._events[type]))ret=[this._events[type]];else ret=this._events[type].slice();return ret};EventEmitter.prototype.listenerCount=function(type){if(this._events){var evlistener=this._events[type];if(isFunction(evlistener))return 1;else if(evlistener)return evlistener.length}return 0};EventEmitter.listenerCount=function(emitter,type){return emitter.listenerCount(type)};function isFunction(arg){return typeof arg==="function"}function isNumber(arg){return typeof arg==="number"}function isObject(arg){return typeof arg==="object"&&arg!==null}function isUndefined(arg){return arg===void 0}},{}],44:[function(require,module,exports){exports.read=function(buffer,offset,isLE,mLen,nBytes){var e,m;var eLen=nBytes*8-mLen-1;var eMax=(1<<eLen)-1;var eBias=eMax>>1;var nBits=-7;var i=isLE?nBytes-1:0;var d=isLE?-1:1;var s=buffer[offset+i];i+=d;e=s&(1<<-nBits)-1;s>>=-nBits;nBits+=eLen;for(;nBits>0;e=e*256+buffer[offset+i],i+=d,nBits-=8){}m=e&(1<<-nBits)-1;e>>=-nBits;nBits+=mLen;for(;nBits>0;m=m*256+buffer[offset+i],i+=d,nBits-=8){}if(e===0){e=1-eBias}else if(e===eMax){return m?NaN:(s?-1:1)*Infinity}else{m=m+Math.pow(2,mLen);e=e-eBias}return(s?-1:1)*m*Math.pow(2,e-mLen)};exports.write=function(buffer,value,offset,isLE,mLen,nBytes){var e,m,c;var eLen=nBytes*8-mLen-1;var eMax=(1<<eLen)-1;var eBias=eMax>>1;var rt=mLen===23?Math.pow(2,-24)-Math.pow(2,-77):0;var i=isLE?0:nBytes-1;var d=isLE?1:-1;var s=value<0||value===0&&1/value<0?1:0;value=Math.abs(value);if(isNaN(value)||value===Infinity){m=isNaN(value)?1:0;e=eMax}else{e=Math.floor(Math.log(value)/Math.LN2);if(value*(c=Math.pow(2,-e))<1){e--;c*=2}if(e+eBias>=1){value+=rt/c}else{value+=rt*Math.pow(2,1-eBias)}if(value*c>=2){e++;c/=2}if(e+eBias>=eMax){m=0;e=eMax}else if(e+eBias>=1){m=(value*c-1)*Math.pow(2,mLen);e=e+eBias}else{m=value*Math.pow(2,eBias-1)*Math.pow(2,mLen);e=0}}for(;mLen>=8;buffer[offset+i]=m&255,i+=d,m/=256,mLen-=8){}e=e<<mLen|m;eLen+=mLen;for(;eLen>0;buffer[offset+i]=e&255,i+=d,e/=256,eLen-=8){}buffer[offset+i-d]|=s*128}},{}],45:[function(require,module,exports){module.exports=require("./lib/checks")},{"./lib/checks":46}],46:[function(require,module,exports){var util=require("util");var errors=module.exports=require("./errors");function failCheck(ExceptionConstructor,callee,messageFormat,formatArgs){messageFormat=messageFormat||"";var message=util.format.apply(this,[messageFormat].concat(formatArgs));var error=new ExceptionConstructor(message);Error.captureStackTrace(error,callee);throw error}function failArgumentCheck(callee,message,formatArgs){failCheck(errors.IllegalArgumentError,callee,message,formatArgs)}function failStateCheck(callee,message,formatArgs){failCheck(errors.IllegalStateError,callee,message,formatArgs)}module.exports.checkArgument=function(value,message){if(!value){failArgumentCheck(arguments.callee,message,Array.prototype.slice.call(arguments,2))}};module.exports.checkState=function(value,message){if(!value){failStateCheck(arguments.callee,message,Array.prototype.slice.call(arguments,2))}};module.exports.checkIsDef=function(value,message){if(value!==undefined){return value}failArgumentCheck(arguments.callee,message||"Expected value to be defined but was undefined.",Array.prototype.slice.call(arguments,2))};module.exports.checkIsDefAndNotNull=function(value,message){if(value!=null){return value}failArgumentCheck(arguments.callee,message||'Expected value to be defined and not null but got "'+typeOf(value)+'".',Array.prototype.slice.call(arguments,2))};function typeOf(value){var s=typeof value;if(s=="object"){if(!value){return"null"}else if(value instanceof Array){return"array"}}return s}function typeCheck(expect){return function(value,message){var type=typeOf(value);if(type==expect){return value}failArgumentCheck(arguments.callee,message||'Expected "'+expect+'" but got "'+type+'".',Array.prototype.slice.call(arguments,2))}}module.exports.checkIsString=typeCheck("string");module.exports.checkIsArray=typeCheck("array");module.exports.checkIsNumber=typeCheck("number");module.exports.checkIsBoolean=typeCheck("boolean");module.exports.checkIsFunction=typeCheck("function");module.exports.checkIsObject=typeCheck("object")},{"./errors":47,util:55}],47:[function(require,module,exports){var util=require("util");function IllegalArgumentError(message){Error.call(this,message);this.message=message}util.inherits(IllegalArgumentError,Error);IllegalArgumentError.prototype.name="IllegalArgumentError";function IllegalStateError(message){Error.call(this,message);this.message=message}util.inherits(IllegalStateError,Error);IllegalStateError.prototype.name="IllegalStateError";module.exports.IllegalStateError=IllegalStateError;module.exports.IllegalArgumentError=IllegalArgumentError},{util:55}],48:[function(require,module,exports){var process=module.exports={};var cachedSetTimeout;var cachedClearTimeout;function defaultSetTimout(){throw new Error("setTimeout has not been defined")}function defaultClearTimeout(){throw new Error("clearTimeout has not been defined")}(function(){try{if(typeof setTimeout==="function"){cachedSetTimeout=setTimeout}else{cachedSetTimeout=defaultSetTimout}}catch(e){cachedSetTimeout=defaultSetTimout}try{if(typeof clearTimeout==="function"){cachedClearTimeout=clearTimeout}else{cachedClearTimeout=defaultClearTimeout}}catch(e){cachedClearTimeout=defaultClearTimeout}})();function runTimeout(fun){if(cachedSetTimeout===setTimeout){return setTimeout(fun,0)}if((cachedSetTimeout===defaultSetTimout||!cachedSetTimeout)&&setTimeout){cachedSetTimeout=setTimeout;return setTimeout(fun,0)}try{return cachedSetTimeout(fun,0)}catch(e){try{return cachedSetTimeout.call(null,fun,0)}catch(e){return cachedSetTimeout.call(this,fun,0)}}}function runClearTimeout(marker){if(cachedClearTimeout===clearTimeout){return clearTimeout(marker)}if((cachedClearTimeout===defaultClearTimeout||!cachedClearTimeout)&&clearTimeout){cachedClearTimeout=clearTimeout;return clearTimeout(marker)}try{return cachedClearTimeout(marker)}catch(e){try{return cachedClearTimeout.call(null,marker)}catch(e){return cachedClearTimeout.call(this,marker)}}}var queue=[];var draining=false;var currentQueue;var queueIndex=-1;function cleanUpNextTick(){if(!draining||!currentQueue){return}draining=false;if(currentQueue.length){queue=currentQueue.concat(queue)}else{queueIndex=-1}if(queue.length){drainQueue()}}function drainQueue(){if(draining){return}var timeout=runTimeout(cleanUpNextTick);draining=true;var len=queue.length;while(len){currentQueue=queue;queue=[];while(++queueIndex<len){if(currentQueue){currentQueue[queueIndex].run()}}queueIndex=-1;len=queue.length}currentQueue=null;draining=false;runClearTimeout(timeout)}process.nextTick=function(fun){var args=new Array(arguments.length-1);if(arguments.length>1){for(var i=1;i<arguments.length;i++){args[i-1]=arguments[i]}}queue.push(new Item(fun,args));if(queue.length===1&&!draining){runTimeout(drainQueue)}};function Item(fun,array){this.fun=fun;this.array=array}Item.prototype.run=function(){this.fun.apply(null,this.array)};process.title="browser";process.browser=true;process.env={};process.argv=[];process.version="";process.versions={};function noop(){}process.on=noop;process.addListener=noop;process.once=noop;process.off=noop;process.removeListener=noop;process.removeAllListeners=noop;process.emit=noop;process.prependListener=noop;process.prependOnceListener=noop;process.listeners=function(name){return[]};process.binding=function(name){throw new Error("process.binding is not supported")};process.cwd=function(){return"/"};process.chdir=function(dir){throw new Error("process.chdir is not supported")};process.umask=function(){return 0}},{}],49:[function(require,module,exports){var g=function(){return this}()||Function("return this")();var hadRuntime=g.regeneratorRuntime&&Object.getOwnPropertyNames(g).indexOf("regeneratorRuntime")>=0;var oldRuntime=hadRuntime&&g.regeneratorRuntime;g.regeneratorRuntime=undefined;module.exports=require("./runtime");if(hadRuntime){g.regeneratorRuntime=oldRuntime}else{try{delete g.regeneratorRuntime}catch(e){g.regeneratorRuntime=undefined}}},{"./runtime":50}],50:[function(require,module,exports){!function(global){"use strict";var Op=Object.prototype;var hasOwn=Op.hasOwnProperty;var undefined;var $Symbol=typeof Symbol==="function"?Symbol:{};var iteratorSymbol=$Symbol.iterator||"@@iterator";var asyncIteratorSymbol=$Symbol.asyncIterator||"@@asyncIterator";var toStringTagSymbol=$Symbol.toStringTag||"@@toStringTag";var inModule=typeof module==="object";var runtime=global.regeneratorRuntime;if(runtime){if(inModule){module.exports=runtime}return}runtime=global.regeneratorRuntime=inModule?module.exports:{};function wrap(innerFn,outerFn,self,tryLocsList){var protoGenerator=outerFn&&outerFn.prototype instanceof Generator?outerFn:Generator;var generator=Object.create(protoGenerator.prototype);var context=new Context(tryLocsList||[]);generator._invoke=makeInvokeMethod(innerFn,self,context);return generator}runtime.wrap=wrap;function tryCatch(fn,obj,arg){try{return{type:"normal",arg:fn.call(obj,arg)}}catch(err){return{type:"throw",arg:err}}}var GenStateSuspendedStart="suspendedStart";var GenStateSuspendedYield="suspendedYield";var GenStateExecuting="executing";var GenStateCompleted="completed";var ContinueSentinel={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var IteratorPrototype={};IteratorPrototype[iteratorSymbol]=function(){return this};var getProto=Object.getPrototypeOf;var NativeIteratorPrototype=getProto&&getProto(getProto(values([])));if(NativeIteratorPrototype&&NativeIteratorPrototype!==Op&&hasOwn.call(NativeIteratorPrototype,iteratorSymbol)){IteratorPrototype=NativeIteratorPrototype}var Gp=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(IteratorPrototype);GeneratorFunction.prototype=Gp.constructor=GeneratorFunctionPrototype;GeneratorFunctionPrototype.constructor=GeneratorFunction;GeneratorFunctionPrototype[toStringTagSymbol]=GeneratorFunction.displayName="GeneratorFunction";function defineIteratorMethods(prototype){["next","throw","return"].forEach(function(method){prototype[method]=function(arg){return this._invoke(method,arg)}})}runtime.isGeneratorFunction=function(genFun){var ctor=typeof genFun==="function"&&genFun.constructor;return ctor?ctor===GeneratorFunction||(ctor.displayName||ctor.name)==="GeneratorFunction":false};runtime.mark=function(genFun){if(Object.setPrototypeOf){Object.setPrototypeOf(genFun,GeneratorFunctionPrototype)}else{genFun.__proto__=GeneratorFunctionPrototype;if(!(toStringTagSymbol in genFun)){genFun[toStringTagSymbol]="GeneratorFunction"}}genFun.prototype=Object.create(Gp);return genFun};runtime.awrap=function(arg){return{__await:arg}};function AsyncIterator(generator){function invoke(method,arg,resolve,reject){var record=tryCatch(generator[method],generator,arg);if(record.type==="throw"){reject(record.arg)}else{var result=record.arg;var value=result.value;if(value&&typeof value==="object"&&hasOwn.call(value,"__await")){return Promise.resolve(value.__await).then(function(value){invoke("next",value,resolve,reject)},function(err){invoke("throw",err,resolve,reject)})}return Promise.resolve(value).then(function(unwrapped){result.value=unwrapped;resolve(result)},reject)}}var previousPromise;function enqueue(method,arg){function callInvokeWithMethodAndArg(){return new Promise(function(resolve,reject){invoke(method,arg,resolve,reject)})}return previousPromise=previousPromise?previousPromise.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}this._invoke=enqueue}defineIteratorMethods(AsyncIterator.prototype);AsyncIterator.prototype[asyncIteratorSymbol]=function(){return this};runtime.AsyncIterator=AsyncIterator;runtime.async=function(innerFn,outerFn,self,tryLocsList){var iter=new AsyncIterator(wrap(innerFn,outerFn,self,tryLocsList));return runtime.isGeneratorFunction(outerFn)?iter:iter.next().then(function(result){return result.done?result.value:iter.next()})};function makeInvokeMethod(innerFn,self,context){var state=GenStateSuspendedStart;return function invoke(method,arg){if(state===GenStateExecuting){throw new Error("Generator is already running")}if(state===GenStateCompleted){if(method==="throw"){throw arg}return doneResult()}context.method=method;context.arg=arg;while(true){var delegate=context.delegate;if(delegate){var delegateResult=maybeInvokeDelegate(delegate,context);if(delegateResult){if(delegateResult===ContinueSentinel)continue;return delegateResult}}if(context.method==="next"){context.sent=context._sent=context.arg}else if(context.method==="throw"){if(state===GenStateSuspendedStart){state=GenStateCompleted;throw context.arg}context.dispatchException(context.arg)}else if(context.method==="return"){context.abrupt("return",context.arg)}state=GenStateExecuting;var record=tryCatch(innerFn,self,context);if(record.type==="normal"){state=context.done?GenStateCompleted:GenStateSuspendedYield;if(record.arg===ContinueSentinel){continue}return{value:record.arg,done:context.done}}else if(record.type==="throw"){state=GenStateCompleted;context.method="throw";context.arg=record.arg}}}}function maybeInvokeDelegate(delegate,context){var method=delegate.iterator[context.method];if(method===undefined){context.delegate=null;if(context.method==="throw"){if(delegate.iterator.return){context.method="return";context.arg=undefined;maybeInvokeDelegate(delegate,context);if(context.method==="throw"){return ContinueSentinel}}context.method="throw";context.arg=new TypeError("The iterator does not provide a 'throw' method")}return ContinueSentinel}var record=tryCatch(method,delegate.iterator,context.arg);if(record.type==="throw"){context.method="throw";context.arg=record.arg;context.delegate=null;return ContinueSentinel}var info=record.arg;if(!info){context.method="throw";context.arg=new TypeError("iterator result is not an object");context.delegate=null;return ContinueSentinel}if(info.done){context[delegate.resultName]=info.value;context.next=delegate.nextLoc;if(context.method!=="return"){context.method="next";context.arg=undefined}}else{return info}context.delegate=null;return ContinueSentinel}defineIteratorMethods(Gp);Gp[toStringTagSymbol]="Generator";Gp[iteratorSymbol]=function(){return this};Gp.toString=function(){return"[object Generator]"};function pushTryEntry(locs){var entry={tryLoc:locs[0]};if(1 in locs){entry.catchLoc=locs[1]}if(2 in locs){entry.finallyLoc=locs[2];entry.afterLoc=locs[3]}this.tryEntries.push(entry)}function resetTryEntry(entry){var record=entry.completion||{};record.type="normal";delete record.arg;entry.completion=record}function Context(tryLocsList){this.tryEntries=[{tryLoc:"root"}];tryLocsList.forEach(pushTryEntry,this);this.reset(true)}runtime.keys=function(object){var keys=[];for(var key in object){keys.push(key)}keys.reverse();return function next(){while(keys.length){var key=keys.pop();if(key in object){next.value=key;next.done=false;return next}}next.done=true;return next}};function values(iterable){if(iterable){var iteratorMethod=iterable[iteratorSymbol];if(iteratorMethod){return iteratorMethod.call(iterable)}if(typeof iterable.next==="function"){return iterable}if(!isNaN(iterable.length)){var i=-1,next=function next(){while(++i<iterable.length){if(hasOwn.call(iterable,i)){next.value=iterable[i];next.done=false;return next}}next.value=undefined;next.done=true;return next};return next.next=next}}return{next:doneResult}}runtime.values=values;function doneResult(){return{value:undefined,done:true}}Context.prototype={constructor:Context,reset:function(skipTempReset){this.prev=0;this.next=0;this.sent=this._sent=undefined;this.done=false;this.delegate=null;this.method="next";this.arg=undefined;this.tryEntries.forEach(resetTryEntry);if(!skipTempReset){for(var name in this){if(name.charAt(0)==="t"&&hasOwn.call(this,name)&&!isNaN(+name.slice(1))){this[name]=undefined}}}},stop:function(){this.done=true;var rootEntry=this.tryEntries[0];var rootRecord=rootEntry.completion;if(rootRecord.type==="throw"){throw rootRecord.arg}return this.rval},dispatchException:function(exception){if(this.done){throw exception}var context=this;function handle(loc,caught){record.type="throw";record.arg=exception;context.next=loc;if(caught){context.method="next";context.arg=undefined}return!!caught}for(var i=this.tryEntries.length-1;i>=0;--i){var entry=this.tryEntries[i];var record=entry.completion;if(entry.tryLoc==="root"){return handle("end")}if(entry.tryLoc<=this.prev){var hasCatch=hasOwn.call(entry,"catchLoc");var hasFinally=hasOwn.call(entry,"finallyLoc");if(hasCatch&&hasFinally){if(this.prev<entry.catchLoc){return handle(entry.catchLoc,true)}else if(this.prev<entry.finallyLoc){return handle(entry.finallyLoc)}}else if(hasCatch){if(this.prev<entry.catchLoc){return handle(entry.catchLoc,true)}}else if(hasFinally){if(this.prev<entry.finallyLoc){return handle(entry.finallyLoc)}}else{throw new Error("try statement without catch or finally")}}}},abrupt:function(type,arg){for(var i=this.tryEntries.length-1;i>=0;--i){var entry=this.tryEntries[i];if(entry.tryLoc<=this.prev&&hasOwn.call(entry,"finallyLoc")&&this.prev<entry.finallyLoc){var finallyEntry=entry;break}}if(finallyEntry&&(type==="break"||type==="continue")&&finallyEntry.tryLoc<=arg&&arg<=finallyEntry.finallyLoc){finallyEntry=null}var record=finallyEntry?finallyEntry.completion:{};record.type=type;record.arg=arg;if(finallyEntry){this.method="next";this.next=finallyEntry.finallyLoc;return ContinueSentinel}return this.complete(record)},complete:function(record,afterLoc){if(record.type==="throw"){throw record.arg}if(record.type==="break"||record.type==="continue"){this.next=record.arg}else if(record.type==="return"){this.rval=this.arg=record.arg;this.method="return";this.next="end"}else if(record.type==="normal"&&afterLoc){this.next=afterLoc}return ContinueSentinel},finish:function(finallyLoc){for(var i=this.tryEntries.length-1;i>=0;--i){var entry=this.tryEntries[i];if(entry.finallyLoc===finallyLoc){this.complete(entry.completion,entry.afterLoc);resetTryEntry(entry);return ContinueSentinel}}},catch:function(tryLoc){for(var i=this.tryEntries.length-1;i>=0;--i){var entry=this.tryEntries[i];if(entry.tryLoc===tryLoc){var record=entry.completion;if(record.type==="throw"){var thrown=record.arg;resetTryEntry(entry)}return thrown}}throw new Error("illegal catch attempt")},delegateYield:function(iterable,resultName,nextLoc){this.delegate={iterator:values(iterable),resultName:resultName,nextLoc:nextLoc};if(this.method==="next"){this.arg=undefined}return ContinueSentinel}}}(function(){return this}()||Function("return this")())},{}],51:[function(require,module,exports){"use strict";var SDPUtils=require("sdp");function fixStatsType(stat){return{inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[stat.type]||stat.type}function writeMediaSection(transceiver,caps,type,stream,dtlsRole){var sdp=SDPUtils.writeRtpDescription(transceiver.kind,caps);sdp+=SDPUtils.writeIceParameters(transceiver.iceGatherer.getLocalParameters());sdp+=SDPUtils.writeDtlsParameters(transceiver.dtlsTransport.getLocalParameters(),type==="offer"?"actpass":dtlsRole||"active");sdp+="a=mid:"+transceiver.mid+"\r\n";if(transceiver.rtpSender&&transceiver.rtpReceiver){sdp+="a=sendrecv\r\n"}else if(transceiver.rtpSender){sdp+="a=sendonly\r\n"}else if(transceiver.rtpReceiver){sdp+="a=recvonly\r\n"}else{sdp+="a=inactive\r\n"}if(transceiver.rtpSender){var trackId=transceiver.rtpSender._initialTrackId||transceiver.rtpSender.track.id;transceiver.rtpSender._initialTrackId=trackId;var msid="msid:"+(stream?stream.id:"-")+" "+trackId+"\r\n";sdp+="a="+msid;sdp+="a=ssrc:"+transceiver.sendEncodingParameters[0].ssrc+" "+msid;if(transceiver.sendEncodingParameters[0].rtx){sdp+="a=ssrc:"+transceiver.sendEncodingParameters[0].rtx.ssrc+" "+msid;sdp+="a=ssrc-group:FID "+transceiver.sendEncodingParameters[0].ssrc+" "+transceiver.sendEncodingParameters[0].rtx.ssrc+"\r\n"}}sdp+="a=ssrc:"+transceiver.sendEncodingParameters[0].ssrc+" cname:"+SDPUtils.localCName+"\r\n";if(transceiver.rtpSender&&transceiver.sendEncodingParameters[0].rtx){sdp+="a=ssrc:"+transceiver.sendEncodingParameters[0].rtx.ssrc+" cname:"+SDPUtils.localCName+"\r\n"}return sdp}function filterIceServers(iceServers,edgeVersion){var hasTurn=false;iceServers=JSON.parse(JSON.stringify(iceServers));return iceServers.filter(function(server){if(server&&(server.urls||server.url)){var urls=server.urls||server.url;if(server.url&&!server.urls){console.warn("RTCIceServer.url is deprecated! Use urls instead.")}var isString=typeof urls==="string";if(isString){urls=[urls]}urls=urls.filter(function(url){var validTurn=url.indexOf("turn:")===0&&url.indexOf("transport=udp")!==-1&&url.indexOf("turn:[")===-1&&!hasTurn;if(validTurn){hasTurn=true;return true}return url.indexOf("stun:")===0&&edgeVersion>=14393&&url.indexOf("?transport=udp")===-1});delete server.url;server.urls=isString?urls[0]:urls;return!!urls.length}})}function getCommonCapabilities(localCapabilities,remoteCapabilities){var commonCapabilities={codecs:[],headerExtensions:[],fecMechanisms:[]};var findCodecByPayloadType=function(pt,codecs){pt=parseInt(pt,10);for(var i=0;i<codecs.length;i++){if(codecs[i].payloadType===pt||codecs[i].preferredPayloadType===pt){return codecs[i]}}};var rtxCapabilityMatches=function(lRtx,rRtx,lCodecs,rCodecs){var lCodec=findCodecByPayloadType(lRtx.parameters.apt,lCodecs);var rCodec=findCodecByPayloadType(rRtx.parameters.apt,rCodecs);return lCodec&&rCodec&&lCodec.name.toLowerCase()===rCodec.name.toLowerCase()};localCapabilities.codecs.forEach(function(lCodec){for(var i=0;i<remoteCapabilities.codecs.length;i++){var rCodec=remoteCapabilities.codecs[i];if(lCodec.name.toLowerCase()===rCodec.name.toLowerCase()&&lCodec.clockRate===rCodec.clockRate){if(lCodec.name.toLowerCase()==="rtx"&&lCodec.parameters&&rCodec.parameters.apt){if(!rtxCapabilityMatches(lCodec,rCodec,localCapabilities.codecs,remoteCapabilities.codecs)){continue}}rCodec=JSON.parse(JSON.stringify(rCodec));rCodec.numChannels=Math.min(lCodec.numChannels,rCodec.numChannels);commonCapabilities.codecs.push(rCodec);rCodec.rtcpFeedback=rCodec.rtcpFeedback.filter(function(fb){for(var j=0;j<lCodec.rtcpFeedback.length;j++){if(lCodec.rtcpFeedback[j].type===fb.type&&lCodec.rtcpFeedback[j].parameter===fb.parameter){return true}}return false});break}}});localCapabilities.headerExtensions.forEach(function(lHeaderExtension){for(var i=0;i<remoteCapabilities.headerExtensions.length;i++){var rHeaderExtension=remoteCapabilities.headerExtensions[i];if(lHeaderExtension.uri===rHeaderExtension.uri){commonCapabilities.headerExtensions.push(rHeaderExtension);break}}});return commonCapabilities}function isActionAllowedInSignalingState(action,type,signalingState){return{offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[type][action].indexOf(signalingState)!==-1}function maybeAddCandidate(iceTransport,candidate){var alreadyAdded=iceTransport.getRemoteCandidates().find(function(remoteCandidate){return candidate.foundation===remoteCandidate.foundation&&candidate.ip===remoteCandidate.ip&&candidate.port===remoteCandidate.port&&candidate.priority===remoteCandidate.priority&&candidate.protocol===remoteCandidate.protocol&&candidate.type===remoteCandidate.type});if(!alreadyAdded){iceTransport.addRemoteCandidate(candidate)}return!alreadyAdded}function makeError(name,description){var e=new Error(description);e.name=name;e.code={NotSupportedError:9,InvalidStateError:11,InvalidAccessError:15,TypeError:undefined,OperationError:undefined}[name];return e}module.exports=function(window,edgeVersion){function addTrackToStreamAndFireEvent(track,stream){stream.addTrack(track);stream.dispatchEvent(new window.MediaStreamTrackEvent("addtrack",{track:track}))}function removeTrackFromStreamAndFireEvent(track,stream){stream.removeTrack(track);stream.dispatchEvent(new window.MediaStreamTrackEvent("removetrack",{track:track}))}function fireAddTrack(pc,track,receiver,streams){var trackEvent=new Event("track");trackEvent.track=track;trackEvent.receiver=receiver;trackEvent.transceiver={receiver:receiver};trackEvent.streams=streams;window.setTimeout(function(){pc._dispatchEvent("track",trackEvent)})}var RTCPeerConnection=function(config){var pc=this;var _eventTarget=document.createDocumentFragment();["addEventListener","removeEventListener","dispatchEvent"].forEach(function(method){pc[method]=_eventTarget[method].bind(_eventTarget)});this.canTrickleIceCandidates=null;this.needNegotiation=false;this.localStreams=[];this.remoteStreams=[];this.localDescription=null;this.remoteDescription=null;this.signalingState="stable";this.iceConnectionState="new";this.connectionState="new";this.iceGatheringState="new";config=JSON.parse(JSON.stringify(config||{}));this.usingBundle=config.bundlePolicy==="max-bundle";if(config.rtcpMuxPolicy==="negotiate"){throw makeError("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported")}else if(!config.rtcpMuxPolicy){config.rtcpMuxPolicy="require"}switch(config.iceTransportPolicy){case"all":case"relay":break;default:config.iceTransportPolicy="all";break}switch(config.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:config.bundlePolicy="balanced";break}config.iceServers=filterIceServers(config.iceServers||[],edgeVersion);this._iceGatherers=[];if(config.iceCandidatePoolSize){for(var i=config.iceCandidatePoolSize;i>0;i--){this._iceGatherers.push(new window.RTCIceGatherer({iceServers:config.iceServers,gatherPolicy:config.iceTransportPolicy}))}}else{config.iceCandidatePoolSize=0}this._config=config;this.transceivers=[];this._sdpSessionId=SDPUtils.generateSessionId();this._sdpSessionVersion=0;this._dtlsRole=undefined;this._isClosed=false};RTCPeerConnection.prototype.onicecandidate=null;RTCPeerConnection.prototype.onaddstream=null;RTCPeerConnection.prototype.ontrack=null;RTCPeerConnection.prototype.onremovestream=null;RTCPeerConnection.prototype.onsignalingstatechange=null;RTCPeerConnection.prototype.oniceconnectionstatechange=null;RTCPeerConnection.prototype.onconnectionstatechange=null;RTCPeerConnection.prototype.onicegatheringstatechange=null;RTCPeerConnection.prototype.onnegotiationneeded=null;RTCPeerConnection.prototype.ondatachannel=null;RTCPeerConnection.prototype._dispatchEvent=function(name,event){if(this._isClosed){return}this.dispatchEvent(event);if(typeof this["on"+name]==="function"){this["on"+name](event)}};RTCPeerConnection.prototype._emitGatheringStateChange=function(){var event=new Event("icegatheringstatechange");this._dispatchEvent("icegatheringstatechange",event)};RTCPeerConnection.prototype.getConfiguration=function(){return this._config};RTCPeerConnection.prototype.getLocalStreams=function(){return this.localStreams};RTCPeerConnection.prototype.getRemoteStreams=function(){return this.remoteStreams};RTCPeerConnection.prototype._createTransceiver=function(kind,doNotAdd){var hasBundleTransport=this.transceivers.length>0;var transceiver={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:kind,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:true};if(this.usingBundle&&hasBundleTransport){transceiver.iceTransport=this.transceivers[0].iceTransport;transceiver.dtlsTransport=this.transceivers[0].dtlsTransport}else{var transports=this._createIceAndDtlsTransports();transceiver.iceTransport=transports.iceTransport;transceiver.dtlsTransport=transports.dtlsTransport}if(!doNotAdd){this.transceivers.push(transceiver)}return transceiver};RTCPeerConnection.prototype.addTrack=function(track,stream){if(this._isClosed){throw makeError("InvalidStateError","Attempted to call addTrack on a closed peerconnection.")}var alreadyExists=this.transceivers.find(function(s){return s.track===track});if(alreadyExists){throw makeError("InvalidAccessError","Track already exists.")}var transceiver;for(var i=0;i<this.transceivers.length;i++){if(!this.transceivers[i].track&&this.transceivers[i].kind===track.kind){transceiver=this.transceivers[i]}}if(!transceiver){transceiver=this._createTransceiver(track.kind)}this._maybeFireNegotiationNeeded();if(this.localStreams.indexOf(stream)===-1){this.localStreams.push(stream)}transceiver.track=track;transceiver.stream=stream;transceiver.rtpSender=new window.RTCRtpSender(track,transceiver.dtlsTransport);return transceiver.rtpSender};RTCPeerConnection.prototype.addStream=function(stream){var pc=this;if(edgeVersion>=15025){stream.getTracks().forEach(function(track){pc.addTrack(track,stream)})}else{var clonedStream=stream.clone();stream.getTracks().forEach(function(track,idx){var clonedTrack=clonedStream.getTracks()[idx];track.addEventListener("enabled",function(event){clonedTrack.enabled=event.enabled})});clonedStream.getTracks().forEach(function(track){pc.addTrack(track,clonedStream)})}};RTCPeerConnection.prototype.removeTrack=function(sender){if(this._isClosed){throw makeError("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.")}if(!(sender instanceof window.RTCRtpSender)){throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack "+"does not implement interface RTCRtpSender.")}var transceiver=this.transceivers.find(function(t){return t.rtpSender===sender});if(!transceiver){throw makeError("InvalidAccessError","Sender was not created by this connection.")}var stream=transceiver.stream;transceiver.rtpSender.stop();transceiver.rtpSender=null;transceiver.track=null;transceiver.stream=null;var localStreams=this.transceivers.map(function(t){return t.stream});if(localStreams.indexOf(stream)===-1&&this.localStreams.indexOf(stream)>-1){this.localStreams.splice(this.localStreams.indexOf(stream),1)}this._maybeFireNegotiationNeeded()};RTCPeerConnection.prototype.removeStream=function(stream){var pc=this;stream.getTracks().forEach(function(track){var sender=pc.getSenders().find(function(s){return s.track===track});if(sender){pc.removeTrack(sender)}})};RTCPeerConnection.prototype.getSenders=function(){return this.transceivers.filter(function(transceiver){return!!transceiver.rtpSender}).map(function(transceiver){return transceiver.rtpSender})};RTCPeerConnection.prototype.getReceivers=function(){return this.transceivers.filter(function(transceiver){return!!transceiver.rtpReceiver}).map(function(transceiver){return transceiver.rtpReceiver})};RTCPeerConnection.prototype._createIceGatherer=function(sdpMLineIndex,usingBundle){var pc=this;if(usingBundle&&sdpMLineIndex>0){return this.transceivers[0].iceGatherer}else if(this._iceGatherers.length){return this._iceGatherers.shift()}var iceGatherer=new window.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});Object.defineProperty(iceGatherer,"state",{value:"new",writable:true});this.transceivers[sdpMLineIndex].bufferedCandidateEvents=[];this.transceivers[sdpMLineIndex].bufferCandidates=function(event){var end=!event.candidate||Object.keys(event.candidate).length===0;iceGatherer.state=end?"completed":"gathering";if(pc.transceivers[sdpMLineIndex].bufferedCandidateEvents!==null){pc.transceivers[sdpMLineIndex].bufferedCandidateEvents.push(event)}};iceGatherer.addEventListener("localcandidate",this.transceivers[sdpMLineIndex].bufferCandidates);return iceGatherer};RTCPeerConnection.prototype._gather=function(mid,sdpMLineIndex){var pc=this;var iceGatherer=this.transceivers[sdpMLineIndex].iceGatherer;if(iceGatherer.onlocalcandidate){return}var bufferedCandidateEvents=this.transceivers[sdpMLineIndex].bufferedCandidateEvents;this.transceivers[sdpMLineIndex].bufferedCandidateEvents=null;iceGatherer.removeEventListener("localcandidate",this.transceivers[sdpMLineIndex].bufferCandidates);iceGatherer.onlocalcandidate=function(evt){if(pc.usingBundle&&sdpMLineIndex>0){return}var event=new Event("icecandidate");event.candidate={sdpMid:mid,sdpMLineIndex:sdpMLineIndex};var cand=evt.candidate;var end=!cand||Object.keys(cand).length===0;if(end){if(iceGatherer.state==="new"||iceGatherer.state==="gathering"){iceGatherer.state="completed"}}else{if(iceGatherer.state==="new"){iceGatherer.state="gathering"}cand.component=1;cand.ufrag=iceGatherer.getLocalParameters().usernameFragment;var serializedCandidate=SDPUtils.writeCandidate(cand);event.candidate=Object.assign(event.candidate,SDPUtils.parseCandidate(serializedCandidate));event.candidate.candidate=serializedCandidate;event.candidate.toJSON=function(){return{candidate:event.candidate.candidate,sdpMid:event.candidate.sdpMid,sdpMLineIndex:event.candidate.sdpMLineIndex,usernameFragment:event.candidate.usernameFragment}}}var sections=SDPUtils.getMediaSections(pc.localDescription.sdp);if(!end){sections[event.candidate.sdpMLineIndex]+="a="+event.candidate.candidate+"\r\n"}else{sections[event.candidate.sdpMLineIndex]+="a=end-of-candidates\r\n"}pc.localDescription.sdp=SDPUtils.getDescription(pc.localDescription.sdp)+sections.join("");var complete=pc.transceivers.every(function(transceiver){return transceiver.iceGatherer&&transceiver.iceGatherer.state==="completed"});if(pc.iceGatheringState!=="gathering"){pc.iceGatheringState="gathering";pc._emitGatheringStateChange()}if(!end){pc._dispatchEvent("icecandidate",event)}if(complete){pc._dispatchEvent("icecandidate",new Event("icecandidate"));pc.iceGatheringState="complete";pc._emitGatheringStateChange()}};window.setTimeout(function(){bufferedCandidateEvents.forEach(function(e){iceGatherer.onlocalcandidate(e)})},0)};RTCPeerConnection.prototype._createIceAndDtlsTransports=function(){var pc=this;var iceTransport=new window.RTCIceTransport(null);iceTransport.onicestatechange=function(){pc._updateIceConnectionState();pc._updateConnectionState()};var dtlsTransport=new window.RTCDtlsTransport(iceTransport);dtlsTransport.ondtlsstatechange=function(){pc._updateConnectionState()};dtlsTransport.onerror=function(){Object.defineProperty(dtlsTransport,"state",{value:"failed",writable:true});pc._updateConnectionState()};return{iceTransport:iceTransport,dtlsTransport:dtlsTransport}};RTCPeerConnection.prototype._disposeIceAndDtlsTransports=function(sdpMLineIndex){var iceGatherer=this.transceivers[sdpMLineIndex].iceGatherer;if(iceGatherer){delete iceGatherer.onlocalcandidate;delete this.transceivers[sdpMLineIndex].iceGatherer}var iceTransport=this.transceivers[sdpMLineIndex].iceTransport;if(iceTransport){delete iceTransport.onicestatechange;delete this.transceivers[sdpMLineIndex].iceTransport}var dtlsTransport=this.transceivers[sdpMLineIndex].dtlsTransport;if(dtlsTransport){delete dtlsTransport.ondtlsstatechange;delete dtlsTransport.onerror;delete this.transceivers[sdpMLineIndex].dtlsTransport}};RTCPeerConnection.prototype._transceive=function(transceiver,send,recv){var params=getCommonCapabilities(transceiver.localCapabilities,transceiver.remoteCapabilities);if(send&&transceiver.rtpSender){params.encodings=transceiver.sendEncodingParameters;params.rtcp={cname:SDPUtils.localCName,compound:transceiver.rtcpParameters.compound};if(transceiver.recvEncodingParameters.length){params.rtcp.ssrc=transceiver.recvEncodingParameters[0].ssrc}transceiver.rtpSender.send(params)}if(recv&&transceiver.rtpReceiver&&params.codecs.length>0){if(transceiver.kind==="video"&&transceiver.recvEncodingParameters&&edgeVersion<15019){transceiver.recvEncodingParameters.forEach(function(p){delete p.rtx})}if(transceiver.recvEncodingParameters.length){params.encodings=transceiver.recvEncodingParameters}else{params.encodings=[{}]}params.rtcp={compound:transceiver.rtcpParameters.compound};if(transceiver.rtcpParameters.cname){params.rtcp.cname=transceiver.rtcpParameters.cname}if(transceiver.sendEncodingParameters.length){params.rtcp.ssrc=transceiver.sendEncodingParameters[0].ssrc}transceiver.rtpReceiver.receive(params)}};RTCPeerConnection.prototype.setLocalDescription=function(description){var pc=this;if(["offer","answer"].indexOf(description.type)===-1){return Promise.reject(makeError("TypeError",'Unsupported type "'+description.type+'"'))}if(!isActionAllowedInSignalingState("setLocalDescription",description.type,pc.signalingState)||pc._isClosed){return Promise.reject(makeError("InvalidStateError","Can not set local "+description.type+" in state "+pc.signalingState))}var sections;var sessionpart;if(description.type==="offer"){sections=SDPUtils.splitSections(description.sdp);sessionpart=sections.shift();sections.forEach(function(mediaSection,sdpMLineIndex){var caps=SDPUtils.parseRtpParameters(mediaSection);pc.transceivers[sdpMLineIndex].localCapabilities=caps});pc.transceivers.forEach(function(transceiver,sdpMLineIndex){pc._gather(transceiver.mid,sdpMLineIndex)})}else if(description.type==="answer"){sections=SDPUtils.splitSections(pc.remoteDescription.sdp);sessionpart=sections.shift();var isIceLite=SDPUtils.matchPrefix(sessionpart,"a=ice-lite").length>0;sections.forEach(function(mediaSection,sdpMLineIndex){var transceiver=pc.transceivers[sdpMLineIndex];var iceGatherer=transceiver.iceGatherer;var iceTransport=transceiver.iceTransport;var dtlsTransport=transceiver.dtlsTransport;var localCapabilities=transceiver.localCapabilities;var remoteCapabilities=transceiver.remoteCapabilities;var rejected=SDPUtils.isRejected(mediaSection)&&SDPUtils.matchPrefix(mediaSection,"a=bundle-only").length===0;if(!rejected&&!transceiver.rejected){var remoteIceParameters=SDPUtils.getIceParameters(mediaSection,sessionpart);var remoteDtlsParameters=SDPUtils.getDtlsParameters(mediaSection,sessionpart);if(isIceLite){remoteDtlsParameters.role="server"}if(!pc.usingBundle||sdpMLineIndex===0){pc._gather(transceiver.mid,sdpMLineIndex);if(iceTransport.state==="new"){iceTransport.start(iceGatherer,remoteIceParameters,isIceLite?"controlling":"controlled")}if(dtlsTransport.state==="new"){dtlsTransport.start(remoteDtlsParameters)}}var params=getCommonCapabilities(localCapabilities,remoteCapabilities);pc._transceive(transceiver,params.codecs.length>0,false)}})}pc.localDescription={type:description.type,sdp:description.sdp};if(description.type==="offer"){pc._updateSignalingState("have-local-offer")}else{pc._updateSignalingState("stable")}return Promise.resolve()};RTCPeerConnection.prototype.setRemoteDescription=function(description){var pc=this;if(["offer","answer"].indexOf(description.type)===-1){return Promise.reject(makeError("TypeError",'Unsupported type "'+description.type+'"'))}if(!isActionAllowedInSignalingState("setRemoteDescription",description.type,pc.signalingState)||pc._isClosed){return Promise.reject(makeError("InvalidStateError","Can not set remote "+description.type+" in state "+pc.signalingState))}var streams={};pc.remoteStreams.forEach(function(stream){streams[stream.id]=stream});var receiverList=[];var sections=SDPUtils.splitSections(description.sdp);var sessionpart=sections.shift();var isIceLite=SDPUtils.matchPrefix(sessionpart,"a=ice-lite").length>0;var usingBundle=SDPUtils.matchPrefix(sessionpart,"a=group:BUNDLE ").length>0;pc.usingBundle=usingBundle;var iceOptions=SDPUtils.matchPrefix(sessionpart,"a=ice-options:")[0];if(iceOptions){pc.canTrickleIceCandidates=iceOptions.substr(14).split(" ").indexOf("trickle")>=0}else{pc.canTrickleIceCandidates=false}sections.forEach(function(mediaSection,sdpMLineIndex){var lines=SDPUtils.splitLines(mediaSection);var kind=SDPUtils.getKind(mediaSection);var rejected=SDPUtils.isRejected(mediaSection)&&SDPUtils.matchPrefix(mediaSection,"a=bundle-only").length===0;var protocol=lines[0].substr(2).split(" ")[2];var direction=SDPUtils.getDirection(mediaSection,sessionpart);var remoteMsid=SDPUtils.parseMsid(mediaSection);var mid=SDPUtils.getMid(mediaSection)||SDPUtils.generateIdentifier();if(kind==="application"&&protocol==="DTLS/SCTP"||rejected){pc.transceivers[sdpMLineIndex]={mid:mid,kind:kind,rejected:true};return}if(!rejected&&pc.transceivers[sdpMLineIndex]&&pc.transceivers[sdpMLineIndex].rejected){pc.transceivers[sdpMLineIndex]=pc._createTransceiver(kind,true)}var transceiver;var iceGatherer;var iceTransport;var dtlsTransport;var rtpReceiver;var sendEncodingParameters;var recvEncodingParameters;var localCapabilities;var track;var remoteCapabilities=SDPUtils.parseRtpParameters(mediaSection);var remoteIceParameters;var remoteDtlsParameters;if(!rejected){remoteIceParameters=SDPUtils.getIceParameters(mediaSection,sessionpart);remoteDtlsParameters=SDPUtils.getDtlsParameters(mediaSection,sessionpart);remoteDtlsParameters.role="client"}recvEncodingParameters=SDPUtils.parseRtpEncodingParameters(mediaSection);var rtcpParameters=SDPUtils.parseRtcpParameters(mediaSection);var isComplete=SDPUtils.matchPrefix(mediaSection,"a=end-of-candidates",sessionpart).length>0;var cands=SDPUtils.matchPrefix(mediaSection,"a=candidate:").map(function(cand){return SDPUtils.parseCandidate(cand)}).filter(function(cand){return cand.component===1});if((description.type==="offer"||description.type==="answer")&&!rejected&&usingBundle&&sdpMLineIndex>0&&pc.transceivers[sdpMLineIndex]){pc._disposeIceAndDtlsTransports(sdpMLineIndex);pc.transceivers[sdpMLineIndex].iceGatherer=pc.transceivers[0].iceGatherer;pc.transceivers[sdpMLineIndex].iceTransport=pc.transceivers[0].iceTransport;pc.transceivers[sdpMLineIndex].dtlsTransport=pc.transceivers[0].dtlsTransport;if(pc.transceivers[sdpMLineIndex].rtpSender){pc.transceivers[sdpMLineIndex].rtpSender.setTransport(pc.transceivers[0].dtlsTransport)}if(pc.transceivers[sdpMLineIndex].rtpReceiver){pc.transceivers[sdpMLineIndex].rtpReceiver.setTransport(pc.transceivers[0].dtlsTransport)}}if(description.type==="offer"&&!rejected){transceiver=pc.transceivers[sdpMLineIndex]||pc._createTransceiver(kind);transceiver.mid=mid;if(!transceiver.iceGatherer){transceiver.iceGatherer=pc._createIceGatherer(sdpMLineIndex,usingBundle)}if(cands.length&&transceiver.iceTransport.state==="new"){if(isComplete&&(!usingBundle||sdpMLineIndex===0)){transceiver.iceTransport.setRemoteCandidates(cands)}else{cands.forEach(function(candidate){maybeAddCandidate(transceiver.iceTransport,candidate)})}}localCapabilities=window.RTCRtpReceiver.getCapabilities(kind);if(edgeVersion<15019){localCapabilities.codecs=localCapabilities.codecs.filter(function(codec){return codec.name!=="rtx"})}sendEncodingParameters=transceiver.sendEncodingParameters||[{ssrc:(2*sdpMLineIndex+2)*1001}];var isNewTrack=false;if(direction==="sendrecv"||direction==="sendonly"){isNewTrack=!transceiver.rtpReceiver;rtpReceiver=transceiver.rtpReceiver||new window.RTCRtpReceiver(transceiver.dtlsTransport,kind);if(isNewTrack){var stream;track=rtpReceiver.track;if(remoteMsid&&remoteMsid.stream==="-"){}else if(remoteMsid){if(!streams[remoteMsid.stream]){streams[remoteMsid.stream]=new window.MediaStream;Object.defineProperty(streams[remoteMsid.stream],"id",{get:function(){return remoteMsid.stream}})}Object.defineProperty(track,"id",{get:function(){return remoteMsid.track}});stream=streams[remoteMsid.stream]}else{if(!streams.default){streams.default=new window.MediaStream}stream=streams.default}if(stream){addTrackToStreamAndFireEvent(track,stream);transceiver.associatedRemoteMediaStreams.push(stream)}receiverList.push([track,rtpReceiver,stream])}}else if(transceiver.rtpReceiver&&transceiver.rtpReceiver.track){transceiver.associatedRemoteMediaStreams.forEach(function(s){var nativeTrack=s.getTracks().find(function(t){return t.id===transceiver.rtpReceiver.track.id});if(nativeTrack){removeTrackFromStreamAndFireEvent(nativeTrack,s)}});transceiver.associatedRemoteMediaStreams=[]}transceiver.localCapabilities=localCapabilities;transceiver.remoteCapabilities=remoteCapabilities;transceiver.rtpReceiver=rtpReceiver;transceiver.rtcpParameters=rtcpParameters;transceiver.sendEncodingParameters=sendEncodingParameters;transceiver.recvEncodingParameters=recvEncodingParameters;pc._transceive(pc.transceivers[sdpMLineIndex],false,isNewTrack)}else if(description.type==="answer"&&!rejected){transceiver=pc.transceivers[sdpMLineIndex];iceGatherer=transceiver.iceGatherer;iceTransport=transceiver.iceTransport;dtlsTransport=transceiver.dtlsTransport;rtpReceiver=transceiver.rtpReceiver;sendEncodingParameters=transceiver.sendEncodingParameters;localCapabilities=transceiver.localCapabilities;pc.transceivers[sdpMLineIndex].recvEncodingParameters=recvEncodingParameters;pc.transceivers[sdpMLineIndex].remoteCapabilities=remoteCapabilities;pc.transceivers[sdpMLineIndex].rtcpParameters=rtcpParameters;if(cands.length&&iceTransport.state==="new"){if((isIceLite||isComplete)&&(!usingBundle||sdpMLineIndex===0)){iceTransport.setRemoteCandidates(cands)}else{cands.forEach(function(candidate){maybeAddCandidate(transceiver.iceTransport,candidate)})}}if(!usingBundle||sdpMLineIndex===0){if(iceTransport.state==="new"){iceTransport.start(iceGatherer,remoteIceParameters,"controlling")}if(dtlsTransport.state==="new"){dtlsTransport.start(remoteDtlsParameters)}}pc._transceive(transceiver,direction==="sendrecv"||direction==="recvonly",direction==="sendrecv"||direction==="sendonly");if(rtpReceiver&&(direction==="sendrecv"||direction==="sendonly")){track=rtpReceiver.track;if(remoteMsid){if(!streams[remoteMsid.stream]){streams[remoteMsid.stream]=new window.MediaStream}addTrackToStreamAndFireEvent(track,streams[remoteMsid.stream]);receiverList.push([track,rtpReceiver,streams[remoteMsid.stream]])}else{if(!streams.default){streams.default=new window.MediaStream}addTrackToStreamAndFireEvent(track,streams.default);receiverList.push([track,rtpReceiver,streams.default])}}else{delete transceiver.rtpReceiver}}});if(pc._dtlsRole===undefined){pc._dtlsRole=description.type==="offer"?"active":"passive"}pc.remoteDescription={type:description.type,sdp:description.sdp};if(description.type==="offer"){pc._updateSignalingState("have-remote-offer")}else{pc._updateSignalingState("stable")}Object.keys(streams).forEach(function(sid){var stream=streams[sid];if(stream.getTracks().length){if(pc.remoteStreams.indexOf(stream)===-1){pc.remoteStreams.push(stream);var event=new Event("addstream");event.stream=stream;window.setTimeout(function(){pc._dispatchEvent("addstream",event)})}receiverList.forEach(function(item){var track=item[0];var receiver=item[1];if(stream.id!==item[2].id){return}fireAddTrack(pc,track,receiver,[stream])})}});receiverList.forEach(function(item){if(item[2]){return}fireAddTrack(pc,item[0],item[1],[])});window.setTimeout(function(){if(!(pc&&pc.transceivers)){return}pc.transceivers.forEach(function(transceiver){if(transceiver.iceTransport&&transceiver.iceTransport.state==="new"&&transceiver.iceTransport.getRemoteCandidates().length>0){console.warn("Timeout for addRemoteCandidate. Consider sending "+"an end-of-candidates notification");transceiver.iceTransport.addRemoteCandidate({})}})},4e3);return Promise.resolve()};RTCPeerConnection.prototype.close=function(){this.transceivers.forEach(function(transceiver){if(transceiver.iceTransport){transceiver.iceTransport.stop()}if(transceiver.dtlsTransport){transceiver.dtlsTransport.stop()}if(transceiver.rtpSender){transceiver.rtpSender.stop()}if(transceiver.rtpReceiver){transceiver.rtpReceiver.stop()}});this._isClosed=true;this._updateSignalingState("closed")};RTCPeerConnection.prototype._updateSignalingState=function(newState){this.signalingState=newState;var event=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",event)};RTCPeerConnection.prototype._maybeFireNegotiationNeeded=function(){var pc=this;if(this.signalingState!=="stable"||this.needNegotiation===true){return}this.needNegotiation=true;window.setTimeout(function(){if(pc.needNegotiation){pc.needNegotiation=false;var event=new Event("negotiationneeded");pc._dispatchEvent("negotiationneeded",event)}},0)};RTCPeerConnection.prototype._updateIceConnectionState=function(){var newState;var states={new:0,closed:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};this.transceivers.forEach(function(transceiver){states[transceiver.iceTransport.state]++});newState="new";if(states.failed>0){newState="failed"}else if(states.checking>0){newState="checking"}else if(states.disconnected>0){newState="disconnected"}else if(states.new>0){newState="new"}else if(states.connected>0){newState="connected"}else if(states.completed>0){newState="completed"}if(newState!==this.iceConnectionState){this.iceConnectionState=newState;var event=new Event("iceconnectionstatechange");this._dispatchEvent("iceconnectionstatechange",event)}};RTCPeerConnection.prototype._updateConnectionState=function(){var newState;var states={new:0,closed:0,connecting:0,connected:0,completed:0,disconnected:0,failed:0};this.transceivers.forEach(function(transceiver){states[transceiver.iceTransport.state]++;states[transceiver.dtlsTransport.state]++});states.connected+=states.completed;newState="new";if(states.failed>0){newState="failed"}else if(states.connecting>0){newState="connecting"}else if(states.disconnected>0){newState="disconnected"}else if(states.new>0){newState="new"}else if(states.connected>0){newState="connected"}if(newState!==this.connectionState){this.connectionState=newState;var event=new Event("connectionstatechange");this._dispatchEvent("connectionstatechange",event)}};RTCPeerConnection.prototype.createOffer=function(){var pc=this;if(pc._isClosed){return Promise.reject(makeError("InvalidStateError","Can not call createOffer after close"))}var numAudioTracks=pc.transceivers.filter(function(t){return t.kind==="audio"}).length;var numVideoTracks=pc.transceivers.filter(function(t){return t.kind==="video"}).length;var offerOptions=arguments[0];if(offerOptions){if(offerOptions.mandatory||offerOptions.optional){throw new TypeError("Legacy mandatory/optional constraints not supported.")}if(offerOptions.offerToReceiveAudio!==undefined){if(offerOptions.offerToReceiveAudio===true){numAudioTracks=1}else if(offerOptions.offerToReceiveAudio===false){numAudioTracks=0}else{numAudioTracks=offerOptions.offerToReceiveAudio}}if(offerOptions.offerToReceiveVideo!==undefined){if(offerOptions.offerToReceiveVideo===true){numVideoTracks=1}else if(offerOptions.offerToReceiveVideo===false){numVideoTracks=0}else{numVideoTracks=offerOptions.offerToReceiveVideo}}}pc.transceivers.forEach(function(transceiver){if(transceiver.kind==="audio"){numAudioTracks--;if(numAudioTracks<0){transceiver.wantReceive=false}}else if(transceiver.kind==="video"){numVideoTracks--;if(numVideoTracks<0){transceiver.wantReceive=false}}});while(numAudioTracks>0||numVideoTracks>0){if(numAudioTracks>0){pc._createTransceiver("audio");numAudioTracks--}if(numVideoTracks>0){pc._createTransceiver("video");numVideoTracks--}}var sdp=SDPUtils.writeSessionBoilerplate(pc._sdpSessionId,pc._sdpSessionVersion++);pc.transceivers.forEach(function(transceiver,sdpMLineIndex){var track=transceiver.track;var kind=transceiver.kind;var mid=transceiver.mid||SDPUtils.generateIdentifier();transceiver.mid=mid;if(!transceiver.iceGatherer){transceiver.iceGatherer=pc._createIceGatherer(sdpMLineIndex,pc.usingBundle)}var localCapabilities=window.RTCRtpSender.getCapabilities(kind);if(edgeVersion<15019){localCapabilities.codecs=localCapabilities.codecs.filter(function(codec){return codec.name!=="rtx"})}localCapabilities.codecs.forEach(function(codec){if(codec.name==="H264"&&codec.parameters["level-asymmetry-allowed"]===undefined){codec.parameters["level-asymmetry-allowed"]="1"}if(transceiver.remoteCapabilities&&transceiver.remoteCapabilities.codecs){transceiver.remoteCapabilities.codecs.forEach(function(remoteCodec){if(codec.name.toLowerCase()===remoteCodec.name.toLowerCase()&&codec.clockRate===remoteCodec.clockRate){codec.preferredPayloadType=remoteCodec.payloadType}})}});localCapabilities.headerExtensions.forEach(function(hdrExt){var remoteExtensions=transceiver.remoteCapabilities&&transceiver.remoteCapabilities.headerExtensions||[];remoteExtensions.forEach(function(rHdrExt){if(hdrExt.uri===rHdrExt.uri){hdrExt.id=rHdrExt.id}})});var sendEncodingParameters=transceiver.sendEncodingParameters||[{ssrc:(2*sdpMLineIndex+1)*1001}];if(track){if(edgeVersion>=15019&&kind==="video"&&!sendEncodingParameters[0].rtx){sendEncodingParameters[0].rtx={ssrc:sendEncodingParameters[0].ssrc+1}}}if(transceiver.wantReceive){transceiver.rtpReceiver=new window.RTCRtpReceiver(transceiver.dtlsTransport,kind)}transceiver.localCapabilities=localCapabilities;transceiver.sendEncodingParameters=sendEncodingParameters});if(pc._config.bundlePolicy!=="max-compat"){sdp+="a=group:BUNDLE "+pc.transceivers.map(function(t){return t.mid}).join(" ")+"\r\n"}sdp+="a=ice-options:trickle\r\n";pc.transceivers.forEach(function(transceiver,sdpMLineIndex){sdp+=writeMediaSection(transceiver,transceiver.localCapabilities,"offer",transceiver.stream,pc._dtlsRole);sdp+="a=rtcp-rsize\r\n";if(transceiver.iceGatherer&&pc.iceGatheringState!=="new"&&(sdpMLineIndex===0||!pc.usingBundle)){transceiver.iceGatherer.getLocalCandidates().forEach(function(cand){cand.component=1;sdp+="a="+SDPUtils.writeCandidate(cand)+"\r\n"});if(transceiver.iceGatherer.state==="completed"){sdp+="a=end-of-candidates\r\n"}}});var desc=new window.RTCSessionDescription({type:"offer",sdp:sdp});return Promise.resolve(desc)};RTCPeerConnection.prototype.createAnswer=function(){var pc=this;if(pc._isClosed){return Promise.reject(makeError("InvalidStateError","Can not call createAnswer after close"))}if(!(pc.signalingState==="have-remote-offer"||pc.signalingState==="have-local-pranswer")){return Promise.reject(makeError("InvalidStateError","Can not call createAnswer in signalingState "+pc.signalingState))}var sdp=SDPUtils.writeSessionBoilerplate(pc._sdpSessionId,pc._sdpSessionVersion++);if(pc.usingBundle){sdp+="a=group:BUNDLE "+pc.transceivers.map(function(t){return t.mid}).join(" ")+"\r\n"}var mediaSectionsInOffer=SDPUtils.getMediaSections(pc.remoteDescription.sdp).length;pc.transceivers.forEach(function(transceiver,sdpMLineIndex){if(sdpMLineIndex+1>mediaSectionsInOffer){return}if(transceiver.rejected){if(transceiver.kind==="application"){sdp+="m=application 0 DTLS/SCTP 5000\r\n"}else if(transceiver.kind==="audio"){sdp+="m=audio 0 UDP/TLS/RTP/SAVPF 0\r\n"+"a=rtpmap:0 PCMU/8000\r\n"}else if(transceiver.kind==="video"){sdp+="m=video 0 UDP/TLS/RTP/SAVPF 120\r\n"+"a=rtpmap:120 VP8/90000\r\n"}sdp+="c=IN IP4 0.0.0.0\r\n"+"a=inactive\r\n"+"a=mid:"+transceiver.mid+"\r\n";return}if(transceiver.stream){var localTrack;if(transceiver.kind==="audio"){localTrack=transceiver.stream.getAudioTracks()[0]}else if(transceiver.kind==="video"){localTrack=transceiver.stream.getVideoTracks()[0]}if(localTrack){if(edgeVersion>=15019&&transceiver.kind==="video"&&!transceiver.sendEncodingParameters[0].rtx){transceiver.sendEncodingParameters[0].rtx={ssrc:transceiver.sendEncodingParameters[0].ssrc+1}}}}var commonCapabilities=getCommonCapabilities(transceiver.localCapabilities,transceiver.remoteCapabilities);var hasRtx=commonCapabilities.codecs.filter(function(c){return c.name.toLowerCase()==="rtx"}).length;if(!hasRtx&&transceiver.sendEncodingParameters[0].rtx){delete transceiver.sendEncodingParameters[0].rtx}sdp+=writeMediaSection(transceiver,commonCapabilities,"answer",transceiver.stream,pc._dtlsRole);if(transceiver.rtcpParameters&&transceiver.rtcpParameters.reducedSize){sdp+="a=rtcp-rsize\r\n"}});var desc=new window.RTCSessionDescription({type:"answer",sdp:sdp});return Promise.resolve(desc)};RTCPeerConnection.prototype.addIceCandidate=function(candidate){var pc=this;var sections;if(candidate&&!(candidate.sdpMLineIndex!==undefined||candidate.sdpMid)){return Promise.reject(new TypeError("sdpMLineIndex or sdpMid required"))}return new Promise(function(resolve,reject){if(!pc.remoteDescription){return reject(makeError("InvalidStateError","Can not add ICE candidate without a remote description"))}else if(!candidate||candidate.candidate===""){for(var j=0;j<pc.transceivers.length;j++){if(pc.transceivers[j].rejected){continue}pc.transceivers[j].iceTransport.addRemoteCandidate({});sections=SDPUtils.getMediaSections(pc.remoteDescription.sdp);sections[j]+="a=end-of-candidates\r\n";pc.remoteDescription.sdp=SDPUtils.getDescription(pc.remoteDescription.sdp)+sections.join("");if(pc.usingBundle){break}}}else{var sdpMLineIndex=candidate.sdpMLineIndex;if(candidate.sdpMid){for(var i=0;i<pc.transceivers.length;i++){if(pc.transceivers[i].mid===candidate.sdpMid){sdpMLineIndex=i;break}}}var transceiver=pc.transceivers[sdpMLineIndex];if(transceiver){if(transceiver.rejected){return resolve()}var cand=Object.keys(candidate.candidate).length>0?SDPUtils.parseCandidate(candidate.candidate):{};if(cand.protocol==="tcp"&&(cand.port===0||cand.port===9)){return resolve()}if(cand.component&&cand.component!==1){return resolve()}if(sdpMLineIndex===0||sdpMLineIndex>0&&transceiver.iceTransport!==pc.transceivers[0].iceTransport){if(!maybeAddCandidate(transceiver.iceTransport,cand)){return reject(makeError("OperationError","Can not add ICE candidate"))}}var candidateString=candidate.candidate.trim();if(candidateString.indexOf("a=")===0){candidateString=candidateString.substr(2)}sections=SDPUtils.getMediaSections(pc.remoteDescription.sdp);sections[sdpMLineIndex]+="a="+(cand.type?candidateString:"end-of-candidates")+"\r\n";pc.remoteDescription.sdp=SDPUtils.getDescription(pc.remoteDescription.sdp)+sections.join("")}else{return reject(makeError("OperationError","Can not add ICE candidate"))}}resolve()})};RTCPeerConnection.prototype.getStats=function(selector){if(selector&&selector instanceof window.MediaStreamTrack){var senderOrReceiver=null;this.transceivers.forEach(function(transceiver){if(transceiver.rtpSender&&transceiver.rtpSender.track===selector){senderOrReceiver=transceiver.rtpSender}else if(transceiver.rtpReceiver&&transceiver.rtpReceiver.track===selector){senderOrReceiver=transceiver.rtpReceiver}});if(!senderOrReceiver){throw makeError("InvalidAccessError","Invalid selector.")}return senderOrReceiver.getStats()}var promises=[];this.transceivers.forEach(function(transceiver){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach(function(method){if(transceiver[method]){promises.push(transceiver[method].getStats())}})});return Promise.all(promises).then(function(allStats){var results=new Map;allStats.forEach(function(stats){stats.forEach(function(stat){results.set(stat.id,stat)})});return results})};var ortcObjects=["RTCRtpSender","RTCRtpReceiver","RTCIceGatherer","RTCIceTransport","RTCDtlsTransport"];ortcObjects.forEach(function(ortcObjectName){var obj=window[ortcObjectName];if(obj&&obj.prototype&&obj.prototype.getStats){var nativeGetstats=obj.prototype.getStats;obj.prototype.getStats=function(){return nativeGetstats.apply(this).then(function(nativeStats){var mapStats=new Map;Object.keys(nativeStats).forEach(function(id){nativeStats[id].type=fixStatsType(nativeStats[id]);mapStats.set(id,nativeStats[id])});return mapStats})}}});var methods=["createOffer","createAnswer"];methods.forEach(function(method){var nativeMethod=RTCPeerConnection.prototype[method];RTCPeerConnection.prototype[method]=function(){var args=arguments;if(typeof args[0]==="function"||typeof args[1]==="function"){return nativeMethod.apply(this,[arguments[2]]).then(function(description){if(typeof args[0]==="function"){args[0].apply(null,[description])}},function(error){if(typeof args[1]==="function"){args[1].apply(null,[error])}})}return nativeMethod.apply(this,arguments)}});methods=["setLocalDescription","setRemoteDescription","addIceCandidate"];methods.forEach(function(method){var nativeMethod=RTCPeerConnection.prototype[method];RTCPeerConnection.prototype[method]=function(){var args=arguments;if(typeof args[1]==="function"||typeof args[2]==="function"){return nativeMethod.apply(this,arguments).then(function(){if(typeof args[1]==="function"){args[1].apply(null)}},function(error){if(typeof args[2]==="function"){args[2].apply(null,[error])}})}return nativeMethod.apply(this,arguments)}});["getStats"].forEach(function(method){var nativeMethod=RTCPeerConnection.prototype[method];RTCPeerConnection.prototype[method]=function(){var args=arguments;if(typeof args[1]==="function"){return nativeMethod.apply(this,arguments).then(function(){if(typeof args[1]==="function"){args[1].apply(null)}})}return nativeMethod.apply(this,arguments)}});return RTCPeerConnection}},{sdp:52}],52:[function(require,module,exports){"use strict";var SDPUtils={};SDPUtils.generateIdentifier=function(){return Math.random().toString(36).substr(2,10)};SDPUtils.localCName=SDPUtils.generateIdentifier();SDPUtils.splitLines=function(blob){return blob.trim().split("\n").map(function(line){return line.trim()})};SDPUtils.splitSections=function(blob){var parts=blob.split("\nm=");return parts.map(function(part,index){return(index>0?"m="+part:part).trim()+"\r\n"})};SDPUtils.getDescription=function(blob){var sections=SDPUtils.splitSections(blob);return sections&&sections[0]};SDPUtils.getMediaSections=function(blob){var sections=SDPUtils.splitSections(blob);sections.shift();return sections};SDPUtils.matchPrefix=function(blob,prefix){return SDPUtils.splitLines(blob).filter(function(line){return line.indexOf(prefix)===0})};SDPUtils.parseCandidate=function(line){var parts;if(line.indexOf("a=candidate:")===0){parts=line.substring(12).split(" ")}else{parts=line.substring(10).split(" ")}var candidate={foundation:parts[0],component:parseInt(parts[1],10),protocol:parts[2].toLowerCase(),priority:parseInt(parts[3],10),ip:parts[4],port:parseInt(parts[5],10),type:parts[7]};for(var i=8;i<parts.length;i+=2){switch(parts[i]){case"raddr":candidate.relatedAddress=parts[i+1];break;case"rport":candidate.relatedPort=parseInt(parts[i+1],10);break;case"tcptype":candidate.tcpType=parts[i+1];break;case"ufrag":candidate.ufrag=parts[i+1];candidate.usernameFragment=parts[i+1];break;default:candidate[parts[i]]=parts[i+1];break}}return candidate};SDPUtils.writeCandidate=function(candidate){var sdp=[];sdp.push(candidate.foundation);sdp.push(candidate.component);sdp.push(candidate.protocol.toUpperCase());sdp.push(candidate.priority);sdp.push(candidate.ip);sdp.push(candidate.port);var type=candidate.type;sdp.push("typ");sdp.push(type);if(type!=="host"&&candidate.relatedAddress&&candidate.relatedPort){sdp.push("raddr");sdp.push(candidate.relatedAddress);sdp.push("rport");sdp.push(candidate.relatedPort)}if(candidate.tcpType&&candidate.protocol.toLowerCase()==="tcp"){sdp.push("tcptype");sdp.push(candidate.tcpType)}if(candidate.usernameFragment||candidate.ufrag){sdp.push("ufrag");sdp.push(candidate.usernameFragment||candidate.ufrag)}return"candidate:"+sdp.join(" ")};SDPUtils.parseIceOptions=function(line){return line.substr(14).split(" ")};SDPUtils.parseRtpMap=function(line){var parts=line.substr(9).split(" ");var parsed={payloadType:parseInt(parts.shift(),10)};parts=parts[0].split("/");parsed.name=parts[0];parsed.clockRate=parseInt(parts[1],10);parsed.numChannels=parts.length===3?parseInt(parts[2],10):1;return parsed};SDPUtils.writeRtpMap=function(codec){var pt=codec.payloadType;if(codec.preferredPayloadType!==undefined){pt=codec.preferredPayloadType}return"a=rtpmap:"+pt+" "+codec.name+"/"+codec.clockRate+(codec.numChannels!==1?"/"+codec.numChannels:"")+"\r\n"};SDPUtils.parseExtmap=function(line){var parts=line.substr(9).split(" ");return{id:parseInt(parts[0],10),direction:parts[0].indexOf("/")>0?parts[0].split("/")[1]:"sendrecv",uri:parts[1]}};SDPUtils.writeExtmap=function(headerExtension){return"a=extmap:"+(headerExtension.id||headerExtension.preferredId)+(headerExtension.direction&&headerExtension.direction!=="sendrecv"?"/"+headerExtension.direction:"")+" "+headerExtension.uri+"\r\n"};SDPUtils.parseFmtp=function(line){var parsed={};var kv;var parts=line.substr(line.indexOf(" ")+1).split(";");for(var j=0;j<parts.length;j++){kv=parts[j].trim().split("=");parsed[kv[0].trim()]=kv[1]}return parsed};SDPUtils.writeFmtp=function(codec){var line="";var pt=codec.payloadType;if(codec.preferredPayloadType!==undefined){pt=codec.preferredPayloadType}if(codec.parameters&&Object.keys(codec.parameters).length){var params=[];Object.keys(codec.parameters).forEach(function(param){params.push(param+"="+codec.parameters[param])});line+="a=fmtp:"+pt+" "+params.join(";")+"\r\n"}return line};SDPUtils.parseRtcpFb=function(line){var parts=line.substr(line.indexOf(" ")+1).split(" ");return{type:parts.shift(),parameter:parts.join(" ")}};SDPUtils.writeRtcpFb=function(codec){var lines="";var pt=codec.payloadType;if(codec.preferredPayloadType!==undefined){pt=codec.preferredPayloadType}if(codec.rtcpFeedback&&codec.rtcpFeedback.length){codec.rtcpFeedback.forEach(function(fb){lines+="a=rtcp-fb:"+pt+" "+fb.type+(fb.parameter&&fb.parameter.length?" "+fb.parameter:"")+"\r\n"})}return lines};SDPUtils.parseSsrcMedia=function(line){var sp=line.indexOf(" ");var parts={ssrc:parseInt(line.substr(7,sp-7),10)};var colon=line.indexOf(":",sp);if(colon>-1){parts.attribute=line.substr(sp+1,colon-sp-1);parts.value=line.substr(colon+1)}else{parts.attribute=line.substr(sp+1)}return parts};SDPUtils.getMid=function(mediaSection){var mid=SDPUtils.matchPrefix(mediaSection,"a=mid:")[0];if(mid){return mid.substr(6)}};SDPUtils.parseFingerprint=function(line){var parts=line.substr(14).split(" ");return{algorithm:parts[0].toLowerCase(),value:parts[1]}};SDPUtils.getDtlsParameters=function(mediaSection,sessionpart){var lines=SDPUtils.matchPrefix(mediaSection+sessionpart,"a=fingerprint:");return{role:"auto",fingerprints:lines.map(SDPUtils.parseFingerprint)}};SDPUtils.writeDtlsParameters=function(params,setupType){var sdp="a=setup:"+setupType+"\r\n";params.fingerprints.forEach(function(fp){sdp+="a=fingerprint:"+fp.algorithm+" "+fp.value+"\r\n"});return sdp};SDPUtils.getIceParameters=function(mediaSection,sessionpart){var lines=SDPUtils.splitLines(mediaSection);lines=lines.concat(SDPUtils.splitLines(sessionpart));var iceParameters={usernameFragment:lines.filter(function(line){return line.indexOf("a=ice-ufrag:")===0})[0].substr(12),password:lines.filter(function(line){return line.indexOf("a=ice-pwd:")===0})[0].substr(10)};return iceParameters};SDPUtils.writeIceParameters=function(params){return"a=ice-ufrag:"+params.usernameFragment+"\r\n"+"a=ice-pwd:"+params.password+"\r\n"};SDPUtils.parseRtpParameters=function(mediaSection){var description={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]};var lines=SDPUtils.splitLines(mediaSection);var mline=lines[0].split(" ");for(var i=3;i<mline.length;i++){var pt=mline[i];var rtpmapline=SDPUtils.matchPrefix(mediaSection,"a=rtpmap:"+pt+" ")[0];if(rtpmapline){var codec=SDPUtils.parseRtpMap(rtpmapline);var fmtps=SDPUtils.matchPrefix(mediaSection,"a=fmtp:"+pt+" ");codec.parameters=fmtps.length?SDPUtils.parseFmtp(fmtps[0]):{};codec.rtcpFeedback=SDPUtils.matchPrefix(mediaSection,"a=rtcp-fb:"+pt+" ").map(SDPUtils.parseRtcpFb);description.codecs.push(codec);switch(codec.name.toUpperCase()){case"RED":case"ULPFEC":description.fecMechanisms.push(codec.name.toUpperCase());break;default:break}}}SDPUtils.matchPrefix(mediaSection,"a=extmap:").forEach(function(line){description.headerExtensions.push(SDPUtils.parseExtmap(line))});return description};SDPUtils.writeRtpDescription=function(kind,caps){var sdp="";sdp+="m="+kind+" ";sdp+=caps.codecs.length>0?"9":"0";sdp+=" UDP/TLS/RTP/SAVPF ";sdp+=caps.codecs.map(function(codec){if(codec.preferredPayloadType!==undefined){return codec.preferredPayloadType}return codec.payloadType}).join(" ")+"\r\n";sdp+="c=IN IP4 0.0.0.0\r\n";sdp+="a=rtcp:9 IN IP4 0.0.0.0\r\n";caps.codecs.forEach(function(codec){sdp+=SDPUtils.writeRtpMap(codec);sdp+=SDPUtils.writeFmtp(codec);sdp+=SDPUtils.writeRtcpFb(codec)});var maxptime=0;caps.codecs.forEach(function(codec){if(codec.maxptime>maxptime){maxptime=codec.maxptime}});if(maxptime>0){sdp+="a=maxptime:"+maxptime+"\r\n"}sdp+="a=rtcp-mux\r\n";caps.headerExtensions.forEach(function(extension){sdp+=SDPUtils.writeExtmap(extension)});return sdp};SDPUtils.parseRtpEncodingParameters=function(mediaSection){var encodingParameters=[];var description=SDPUtils.parseRtpParameters(mediaSection);var hasRed=description.fecMechanisms.indexOf("RED")!==-1;var hasUlpfec=description.fecMechanisms.indexOf("ULPFEC")!==-1;var ssrcs=SDPUtils.matchPrefix(mediaSection,"a=ssrc:").map(function(line){return SDPUtils.parseSsrcMedia(line)}).filter(function(parts){return parts.attribute==="cname"});var primarySsrc=ssrcs.length>0&&ssrcs[0].ssrc;var secondarySsrc;var flows=SDPUtils.matchPrefix(mediaSection,"a=ssrc-group:FID").map(function(line){var parts=line.split(" ");parts.shift();return parts.map(function(part){return parseInt(part,10)})});if(flows.length>0&&flows[0].length>1&&flows[0][0]===primarySsrc){secondarySsrc=flows[0][1]}description.codecs.forEach(function(codec){if(codec.name.toUpperCase()==="RTX"&&codec.parameters.apt){var encParam={ssrc:primarySsrc,codecPayloadType:parseInt(codec.parameters.apt,10),rtx:{ssrc:secondarySsrc}};encodingParameters.push(encParam);if(hasRed){encParam=JSON.parse(JSON.stringify(encParam));encParam.fec={ssrc:secondarySsrc,mechanism:hasUlpfec?"red+ulpfec":"red"};encodingParameters.push(encParam)}}});if(encodingParameters.length===0&&primarySsrc){encodingParameters.push({ssrc:primarySsrc})}var bandwidth=SDPUtils.matchPrefix(mediaSection,"b=");if(bandwidth.length){if(bandwidth[0].indexOf("b=TIAS:")===0){bandwidth=parseInt(bandwidth[0].substr(7),10)}else if(bandwidth[0].indexOf("b=AS:")===0){bandwidth=parseInt(bandwidth[0].substr(5),10)*1e3*.95-50*40*8}else{bandwidth=undefined}encodingParameters.forEach(function(params){params.maxBitrate=bandwidth})}return encodingParameters};SDPUtils.parseRtcpParameters=function(mediaSection){var rtcpParameters={};var cname;var remoteSsrc=SDPUtils.matchPrefix(mediaSection,"a=ssrc:").map(function(line){return SDPUtils.parseSsrcMedia(line)}).filter(function(obj){return obj.attribute==="cname"})[0];if(remoteSsrc){rtcpParameters.cname=remoteSsrc.value;rtcpParameters.ssrc=remoteSsrc.ssrc}var rsize=SDPUtils.matchPrefix(mediaSection,"a=rtcp-rsize");rtcpParameters.reducedSize=rsize.length>0;rtcpParameters.compound=rsize.length===0;var mux=SDPUtils.matchPrefix(mediaSection,"a=rtcp-mux");rtcpParameters.mux=mux.length>0;return rtcpParameters};SDPUtils.parseMsid=function(mediaSection){var parts;var spec=SDPUtils.matchPrefix(mediaSection,"a=msid:");if(spec.length===1){parts=spec[0].substr(7).split(" ");return{stream:parts[0],track:parts[1]}}var planB=SDPUtils.matchPrefix(mediaSection,"a=ssrc:").map(function(line){return SDPUtils.parseSsrcMedia(line)}).filter(function(parts){return parts.attribute==="msid"});if(planB.length>0){parts=planB[0].value.split(" ");return{stream:parts[0],track:parts[1]}}};SDPUtils.generateSessionId=function(){return Math.random().toString().substr(2,21)};SDPUtils.writeSessionBoilerplate=function(sessId,sessVer){var sessionId;var version=sessVer!==undefined?sessVer:2;if(sessId){sessionId=sessId}else{sessionId=SDPUtils.generateSessionId()}return"v=0\r\n"+"o=thisisadapterortc "+sessionId+" "+version+" IN IP4 127.0.0.1\r\n"+"s=-\r\n"+"t=0 0\r\n"};SDPUtils.writeMediaSection=function(transceiver,caps,type,stream){var sdp=SDPUtils.writeRtpDescription(transceiver.kind,caps);sdp+=SDPUtils.writeIceParameters(transceiver.iceGatherer.getLocalParameters());sdp+=SDPUtils.writeDtlsParameters(transceiver.dtlsTransport.getLocalParameters(),type==="offer"?"actpass":"active");sdp+="a=mid:"+transceiver.mid+"\r\n";if(transceiver.direction){sdp+="a="+transceiver.direction+"\r\n"}else if(transceiver.rtpSender&&transceiver.rtpReceiver){sdp+="a=sendrecv\r\n"}else if(transceiver.rtpSender){sdp+="a=sendonly\r\n"}else if(transceiver.rtpReceiver){sdp+="a=recvonly\r\n"}else{sdp+="a=inactive\r\n"}if(transceiver.rtpSender){var msid="msid:"+stream.id+" "+transceiver.rtpSender.track.id+"\r\n";sdp+="a="+msid;sdp+="a=ssrc:"+transceiver.sendEncodingParameters[0].ssrc+" "+msid;if(transceiver.sendEncodingParameters[0].rtx){sdp+="a=ssrc:"+transceiver.sendEncodingParameters[0].rtx.ssrc+" "+msid;sdp+="a=ssrc-group:FID "+transceiver.sendEncodingParameters[0].ssrc+" "+transceiver.sendEncodingParameters[0].rtx.ssrc+"\r\n"}}sdp+="a=ssrc:"+transceiver.sendEncodingParameters[0].ssrc+" cname:"+SDPUtils.localCName+"\r\n";if(transceiver.rtpSender&&transceiver.sendEncodingParameters[0].rtx){sdp+="a=ssrc:"+transceiver.sendEncodingParameters[0].rtx.ssrc+" cname:"+SDPUtils.localCName+"\r\n"}return sdp};SDPUtils.getDirection=function(mediaSection,sessionpart){var lines=SDPUtils.splitLines(mediaSection);for(var i=0;i<lines.length;i++){switch(lines[i]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return lines[i].substr(2);default:}}if(sessionpart){return SDPUtils.getDirection(sessionpart)}return"sendrecv"};SDPUtils.getKind=function(mediaSection){var lines=SDPUtils.splitLines(mediaSection);var mline=lines[0].split(" ");return mline[0].substr(2)};SDPUtils.isRejected=function(mediaSection){return mediaSection.split(" ",2)[1]==="0"};SDPUtils.parseMLine=function(mediaSection){var lines=SDPUtils.splitLines(mediaSection);var parts=lines[0].substr(2).split(" ");return{kind:parts[0],port:parseInt(parts[1],10),protocol:parts[2],fmt:parts.slice(3).join(" ")}};SDPUtils.parseOLine=function(mediaSection){var line=SDPUtils.matchPrefix(mediaSection,"o=")[0];var parts=line.substr(2).split(" ");return{username:parts[0],sessionId:parts[1],sessionVersion:parseInt(parts[2],10),netType:parts[3],addressType:parts[4],address:parts[5]}};if(typeof module==="object"){module.exports=SDPUtils}},{}],53:[function(require,module,exports){if(typeof Object.create==="function"){module.exports=function inherits(ctor,superCtor){ctor.super_=superCtor;ctor.prototype=Object.create(superCtor.prototype,{constructor:{value:ctor,enumerable:false,writable:true,configurable:true}})}}else{module.exports=function inherits(ctor,superCtor){ctor.super_=superCtor;var TempCtor=function(){};TempCtor.prototype=superCtor.prototype;ctor.prototype=new TempCtor;ctor.prototype.constructor=ctor}}},{}],54:[function(require,module,exports){module.exports=function isBuffer(arg){return arg&&typeof arg==="object"&&typeof arg.copy==="function"&&typeof arg.fill==="function"&&typeof arg.readUInt8==="function"}},{}],55:[function(require,module,exports){(function(process,global){var formatRegExp=/%[sdj%]/g;exports.format=function(f){if(!isString(f)){var objects=[];for(var i=0;i<arguments.length;i++){objects.push(inspect(arguments[i]))}return objects.join(" ")}var i=1;var args=arguments;var len=args.length;var str=String(f).replace(formatRegExp,function(x){if(x==="%%")return"%";if(i>=len)return x;switch(x){case"%s":return String(args[i++]);case"%d":return Number(args[i++]);case"%j":try{return JSON.stringify(args[i++])}catch(_){return"[Circular]"}default:return x}});for(var x=args[i];i<len;x=args[++i]){if(isNull(x)||!isObject(x)){str+=" "+x}else{str+=" "+inspect(x)}}return str};exports.deprecate=function(fn,msg){if(isUndefined(global.process)){return function(){return exports.deprecate(fn,msg).apply(this,arguments)}}if(process.noDeprecation===true){return fn}var warned=false;function deprecated(){if(!warned){if(process.throwDeprecation){throw new Error(msg)}else if(process.traceDeprecation){console.trace(msg)}else{console.error(msg)}warned=true}return fn.apply(this,arguments)}return deprecated};var debugs={};var debugEnviron;exports.debuglog=function(set){if(isUndefined(debugEnviron))debugEnviron=process.env.NODE_DEBUG||"";set=set.toUpperCase();if(!debugs[set]){if(new RegExp("\\b"+set+"\\b","i").test(debugEnviron)){var pid=process.pid;debugs[set]=function(){var msg=exports.format.apply(exports,arguments);console.error("%s %d: %s",set,pid,msg)}}else{debugs[set]=function(){}}}return debugs[set]};function inspect(obj,opts){var ctx={seen:[],stylize:stylizeNoColor};if(arguments.length>=3)ctx.depth=arguments[2];if(arguments.length>=4)ctx.colors=arguments[3];if(isBoolean(opts)){ctx.showHidden=opts}else if(opts){exports._extend(ctx,opts)}if(isUndefined(ctx.showHidden))ctx.showHidden=false;if(isUndefined(ctx.depth))ctx.depth=2;if(isUndefined(ctx.colors))ctx.colors=false;if(isUndefined(ctx.customInspect))ctx.customInspect=true;if(ctx.colors)ctx.stylize=stylizeWithColor;return formatValue(ctx,obj,ctx.depth)}exports.inspect=inspect;inspect.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]};inspect.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"};function stylizeWithColor(str,styleType){var style=inspect.styles[styleType];if(style){return"\x1b["+inspect.colors[style][0]+"m"+str+"\x1b["+inspect.colors[style][1]+"m"}else{return str}}function stylizeNoColor(str,styleType){return str}function arrayToHash(array){var hash={};array.forEach(function(val,idx){hash[val]=true});return hash}function formatValue(ctx,value,recurseTimes){if(ctx.customInspect&&value&&isFunction(value.inspect)&&value.inspect!==exports.inspect&&!(value.constructor&&value.constructor.prototype===value)){var ret=value.inspect(recurseTimes,ctx);if(!isString(ret)){ret=formatValue(ctx,ret,recurseTimes)}return ret}var primitive=formatPrimitive(ctx,value);if(primitive){return primitive}var keys=Object.keys(value);var visibleKeys=arrayToHash(keys);if(ctx.showHidden){keys=Object.getOwnPropertyNames(value)}if(isError(value)&&(keys.indexOf("message")>=0||keys.indexOf("description")>=0)){return formatError(value)}if(keys.length===0){if(isFunction(value)){var name=value.name?": "+value.name:"";return ctx.stylize("[Function"+name+"]","special")}if(isRegExp(value)){return ctx.stylize(RegExp.prototype.toString.call(value),"regexp")}if(isDate(value)){return ctx.stylize(Date.prototype.toString.call(value),"date")}if(isError(value)){return formatError(value)}}var base="",array=false,braces=["{","}"];if(isArray(value)){array=true;braces=["[","]"]}if(isFunction(value)){var n=value.name?": "+value.name:"";base=" [Function"+n+"]"}if(isRegExp(value)){base=" "+RegExp.prototype.toString.call(value)}if(isDate(value)){base=" "+Date.prototype.toUTCString.call(value)}if(isError(value)){base=" "+formatError(value)}if(keys.length===0&&(!array||value.length==0)){return braces[0]+base+braces[1]}if(recurseTimes<0){if(isRegExp(value)){return ctx.stylize(RegExp.prototype.toString.call(value),"regexp")}else{return ctx.stylize("[Object]","special")}}ctx.seen.push(value);var output;if(array){output=formatArray(ctx,value,recurseTimes,visibleKeys,keys)}else{output=keys.map(function(key){return formatProperty(ctx,value,recurseTimes,visibleKeys,key,array)})}ctx.seen.pop();return reduceToSingleString(output,base,braces)}function formatPrimitive(ctx,value){if(isUndefined(value))return ctx.stylize("undefined","undefined");if(isString(value)){var simple="'"+JSON.stringify(value).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return ctx.stylize(simple,"string")}if(isNumber(value))return ctx.stylize(""+value,"number");if(isBoolean(value))return ctx.stylize(""+value,"boolean");if(isNull(value))return ctx.stylize("null","null")}function formatError(value){return"["+Error.prototype.toString.call(value)+"]"}function formatArray(ctx,value,recurseTimes,visibleKeys,keys){var output=[];for(var i=0,l=value.length;i<l;++i){if(hasOwnProperty(value,String(i))){output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,String(i),true))}else{output.push("")}}keys.forEach(function(key){if(!key.match(/^\d+$/)){output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,key,true))}});return output}function formatProperty(ctx,value,recurseTimes,visibleKeys,key,array){var name,str,desc;desc=Object.getOwnPropertyDescriptor(value,key)||{value:value[key]};if(desc.get){if(desc.set){str=ctx.stylize("[Getter/Setter]","special")}else{str=ctx.stylize("[Getter]","special")}}else{if(desc.set){str=ctx.stylize("[Setter]","special")}}if(!hasOwnProperty(visibleKeys,key)){name="["+key+"]"}if(!str){if(ctx.seen.indexOf(desc.value)<0){if(isNull(recurseTimes)){str=formatValue(ctx,desc.value,null)}else{str=formatValue(ctx,desc.value,recurseTimes-1)}if(str.indexOf("\n")>-1){if(array){str=str.split("\n").map(function(line){return"  "+line}).join("\n").substr(2)}else{str="\n"+str.split("\n").map(function(line){return"   "+line}).join("\n")}}}else{str=ctx.stylize("[Circular]","special")}}if(isUndefined(name)){if(array&&key.match(/^\d+$/)){return str}name=JSON.stringify(""+key);if(name.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)){name=name.substr(1,name.length-2);name=ctx.stylize(name,"name")}else{name=name.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'");name=ctx.stylize(name,"string")}}return name+": "+str}function reduceToSingleString(output,base,braces){var numLinesEst=0;var length=output.reduce(function(prev,cur){numLinesEst++;if(cur.indexOf("\n")>=0)numLinesEst++;return prev+cur.replace(/\u001b\[\d\d?m/g,"").length+1},0);if(length>60){return braces[0]+(base===""?"":base+"\n ")+" "+output.join(",\n  ")+" "+braces[1]}return braces[0]+base+" "+output.join(", ")+" "+braces[1]}function isArray(ar){return Array.isArray(ar)}exports.isArray=isArray;function isBoolean(arg){return typeof arg==="boolean"}exports.isBoolean=isBoolean;function isNull(arg){return arg===null}exports.isNull=isNull;function isNullOrUndefined(arg){return arg==null}exports.isNullOrUndefined=isNullOrUndefined;function isNumber(arg){return typeof arg==="number"}exports.isNumber=isNumber;function isString(arg){return typeof arg==="string"}exports.isString=isString;function isSymbol(arg){return typeof arg==="symbol"}exports.isSymbol=isSymbol;function isUndefined(arg){return arg===void 0}exports.isUndefined=isUndefined;function isRegExp(re){return isObject(re)&&objectToString(re)==="[object RegExp]"}exports.isRegExp=isRegExp;function isObject(arg){return typeof arg==="object"&&arg!==null}exports.isObject=isObject;function isDate(d){return isObject(d)&&objectToString(d)==="[object Date]"}exports.isDate=isDate;function isError(e){return isObject(e)&&(objectToString(e)==="[object Error]"||e instanceof Error)}exports.isError=isError;function isFunction(arg){return typeof arg==="function"}exports.isFunction=isFunction;function isPrimitive(arg){return arg===null||typeof arg==="boolean"||typeof arg==="number"||typeof arg==="string"||typeof arg==="symbol"||typeof arg==="undefined"}exports.isPrimitive=isPrimitive;exports.isBuffer=require("./support/isBuffer");function objectToString(o){return Object.prototype.toString.call(o)}function pad(n){return n<10?"0"+n.toString(10):n.toString(10)}var months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function timestamp(){var d=new Date;var time=[pad(d.getHours()),pad(d.getMinutes()),pad(d.getSeconds())].join(":");return[d.getDate(),months[d.getMonth()],time].join(" ")}exports.log=function(){console.log("%s - %s",timestamp(),exports.format.apply(exports,arguments))};exports.inherits=require("inherits");exports._extend=function(origin,add){if(!add||!isObject(add))return origin;var keys=Object.keys(add);var i=keys.length;while(i--){origin[keys[i]]=add[keys[i]]}return origin};function hasOwnProperty(obj,prop){return Object.prototype.hasOwnProperty.call(obj,prop)}}).call(this,require("_process"),typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./support/isBuffer":54,_process:48,inherits:53}],56:[function(require,module,exports){module.exports={name:"twilio-client",version:"1.4.32",description:"Javascript SDK for Twilio Client",homepage:"https://www.twilio.com/docs/client/twilio-js",main:"./es5/twilio.js",license:"Apache-2.0",repository:{type:"git",url:"git@code.hq.twilio.com:client/twiliojs.git"},scripts:{build:"npm-run-all clean build:es5 build:ts build:dist build:dist-min","build:es5":"rimraf ./es5 && babel lib -d es5","build:dist":"node ./scripts/build.js ./lib/browser.js ./LICENSE.md ./dist/twilio.js","build:dist-min":'uglifyjs ./dist/twilio.js -o ./dist/twilio.min.js --comments "/^! twilio-client.js/" -b beautify=false,ascii_only=true',"build:travis":"npm-run-all lint build test:unit test:webpack test:es5","build:ts":"tsc",clean:"rimraf ./coverage ./dist ./es5",coverage:"nyc --reporter=html ./node_modules/mocha/bin/mocha  --reporter=spec tests/index.js",extension:"browserify -t brfs extension/token/index.js > extension/token.js",lint:"npm-run-all lint:js lint:ts","lint:js":"eslint lib","lint:ts":"tslint -c tslint.json --project tsconfig.json -t stylish",release:"release",start:"node server.js",test:"npm-run-all test:unit test:frameworks","test:es5":'es-check es5 "./es5/**/*.js" ./dist/*.js',"test:framework:no-framework":"mocha tests/framework/no-framework.js","test:framework:react:install":"cd ./tests/framework/react && rimraf ./node_modules package-lock.json && npm install","test:framework:react:build":"cd ./tests/framework/react && npm run build","test:framework:react:run":"mocha ./tests/framework/react.js","test:framework:react":"npm-run-all test:framework:react:*","test:frameworks":"npm-run-all test:framework:no-framework test:framework:react","test:selenium":"mocha tests/browser/index.js","test:unit":"mocha --reporter=spec -r ts-node/register ./tests/index.ts","test:webpack":"cd ./tests/webpack && npm install && npm test"},devDependencies:{"@types/mocha":"^5.0.0","@types/node":"^9.6.5","@types/ws":"^4.0.2","babel-cli":"^6.26.0","babel-eslint":"^8.2.2","babel-plugin-transform-class-properties":"^6.24.1","babel-preset-es2015":"^6.24.1",brfs:"^1.4.3",browserify:"^14.3.0",chromedriver:"^2.31.0",envify:"2.0.1","es-check":"^2.0.3",eslint:"^4.19.1","eslint-plugin-babel":"^4.1.2",express:"^4.14.1",geckodriver:"^1.8.1","js-yaml":"^3.9.1",jsonwebtoken:"^7.4.3",lodash:"^4.17.4",mocha:"^3.5.0","npm-run-all":"^4.1.2",nyc:"^10.1.2",querystring:"^0.2.0","release-tool":"^0.2.2","selenium-webdriver":"^3.5.0",sinon:"^4.0.0","ts-node":"^6.0.0",tslint:"^5.9.1",twilio:"^2.11.1",typescript:"^2.8.1","uglify-js":"^3.3.11","vinyl-fs":"^3.0.2","vinyl-source-stream":"^2.0.0"},dependencies:{AudioPlayer:"git+https://github.com/twilio/AudioPlayer.git#1.0.1",backoff:"^2.5.0","rtcpeerconnection-shim":"^1.2.8",ws:"0.4.31",xmlhttprequest:"^1.8.0"},browser:{xmlhttprequest:"./browser/xmlhttprequest.js",ws:"./browser/ws.js"}}},{}]},{},[3]);var Voice=bundle(3);if(typeof define==="function"&&define.amd){define([],function(){return Voice})}else{var Twilio=root.Twilio=root.Twilio||{};Twilio.Connection=Twilio.Connection||Voice.Connection;Twilio.Device=Twilio.Device||Voice.Device;Twilio.PStream=Twilio.PStream||Voice.PStream}})(typeof window!=="undefined"?window:typeof global!=="undefined"?global:this);